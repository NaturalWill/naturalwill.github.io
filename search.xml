<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>两步实现开机登陆自动后台运行VirtualBox虚拟机</title>
    <url>/2015/12/16/Start-VirtualBox-Machine-With-Login-In-Windows/</url>
    <content><![CDATA[<p>目的：开机后自动后台运行虚拟机，只有进程，不显示GUI界面，关机自动保存虚拟机状态，以便下次开机恢复。</p>
<h3 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h3><h4 id="启动虚拟机脚本-startvm-bat"><a href="#启动虚拟机脚本-startvm-bat" class="headerlink" title="启动虚拟机脚本: startvm.bat"></a>启动虚拟机脚本: startvm.bat</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">&quot;D:\Program Files\Oracle\VirtualBox\VBoxManage&quot; startvm Arch_x64 --type headless</span><br></pre></td></tr></table></figure>

<h4 id="休眠虚拟机脚本-savestate-bat"><a href="#休眠虚拟机脚本-savestate-bat" class="headerlink" title="休眠虚拟机脚本: savestate.bat"></a>休眠虚拟机脚本: savestate.bat</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">&quot;D:\Program Files\Oracle\VirtualBox\VBoxManage&quot; controlvm Arch_x64 savestate</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>:</p>
<ul>
<li><code>&quot;D:\Program Files\Oracle\VirtualBox&quot;</code>是VirtualBox的安装目录，如果你装在其他地方则需要改为对应的位置。</li>
<li><code>Arch_x64</code>为虚拟机名字</li>
</ul>
<h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><p>快捷键 <code>&lt;Win&gt; + R</code> 打开运行窗口，输入<code>gpedit.msc</code>打开组策略，在<code>用户配置</code>-&gt;<code>Windows设置</code>-&gt;<code>脚本（登录/注销）</code>里，分别添加上面2个脚本。</p>
<hr>
<p><strong>恭喜你！你已经实现了开机后自动后台运行虚拟机</strong>。</p>
<span id="more"></span>

<hr>
<h3 id="附：VBoxManage命令部分选项解析"><a href="#附：VBoxManage命令部分选项解析" class="headerlink" title="附：VBoxManage命令部分选项解析"></a>附：VBoxManage命令部分选项解析</h3><pre><code>C:\&gt;&quot;D:\Program Files\Oracle\VirtualBox\VBoxManage&quot;
Oracle VM VirtualBox Command Line Management Interface Version 5.0.10
(C) 2005-2015 Oracle Corporation
All rights reserved.

Usage:

  VBoxManage [&lt;general option&gt;] &lt;command&gt;


General Options:

  [-v|--version]            print version number and exit
  [-q|--nologo]             suppress the logo
  [--settingspw &lt;pw&gt;]       provide the settings password
  [--settingspwfile &lt;file&gt;] provide a file containing the settings password


Commands:

  list [--long|-l]          vms|runningvms|ostypes|hostdvds|hostfloppies|
                            intnets|bridgedifs|hostonlyifs|natnets|dhcpservers|
                            hostinfo|hostcpuids|hddbackends|hdds|dvds|floppies|
                            usbhost|usbfilters|systemproperties|extpacks|
                            groups|webcams|screenshotformats
                            
...

  startvm                   &lt;uuid|vmname&gt;...
                            [--type gui|sdl|headless|separate]

  controlvm                 &lt;uuid|vmname&gt;
                            pause|resume|reset|poweroff|savestate|
                            
...
</code></pre>
<ul>
<li>如果要使用uuid，可以通过 <code>VBoxManage list vms</code>查看</li>
<li>startvm命令中type选项解析<ul>
<li>gui – 图形化界面，VirtualBox的默认启动方式</li>
<li>sdl – 图形化界面，但是少掉了部分功能，比如没有菜单等，一般用于调试过程</li>
<li>headless – 后台运行，并且默认开启vrdp服务，可以通过远程桌面工具来访问</li>
<li>separate – 分离式启动，在VirtualBox 5.0版本新增的启动方式：在后台启动虚拟机，分离的前端进程可以关闭，而虚拟机会继续运行</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>VirtualBox</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP JSON与XML间的相互转换</title>
    <url>/2015/12/23/PHP-Convert-between-JSON-and-XML/</url>
    <content><![CDATA[<p>由于某些原因，我需要将json转换为xml，在网上想找个将json转成xml的便捷方法，还是挺多的，但不能完全实现我的需求，最后还是在 <span class="exturl" data-url="aHR0cDovL2Jsb2cuNTF5aXAuY29tL3BocC82NjAuaHRtbA==">海底苍鹰<i class="fa fa-external-link-alt"></i></span> 所写的基础上完善了一下。以下是我所写的方法。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL05hdHVyYWxXaWxsL2pwaHB0b29scy9tYXN0ZXIvanNvbjJ4bWwucGhw">下载源文件<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="json转换成xml"><a href="#json转换成xml" class="headerlink" title="json转换成xml"></a>json转换成xml</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">json_to_xml</span>(<span class="params"><span class="variable">$source</span>, <span class="variable">$charset</span> = <span class="string">&#x27;UTF-8&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$source</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$array</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$source</span>); <span class="comment">//php5，以及以上，如果是更早版本，请下载JSON.php</span></span><br><span class="line">    <span class="variable">$xml</span>   = <span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;&#x27;</span> . <span class="variable">$charset</span> . <span class="string">&#x27;&quot;?&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$xml</span> .= <span class="title function_ invoke__">_json_to_xml</span>(<span class="variable">$array</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$xml</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_json_to_xml</span>(<span class="params"><span class="variable">$source</span>, <span class="variable">$pkey</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$source</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$v</span>)) &#123; <span class="comment">//判断是否是数组</span></span><br><span class="line">            <span class="variable">$string</span> .= <span class="title function_ invoke__">_json_to_xml</span>(<span class="variable">$v</span>, <span class="variable">$k</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$k</span>) ? <span class="variable">$pkey</span> : <span class="variable">$k</span>; <span class="comment">//判断Key是否是数字，如果是，则使用上一级的Key</span></span><br><span class="line">            <span class="variable">$string</span> .= <span class="keyword">empty</span>(<span class="variable">$key</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;&lt;&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$v</span>)) &#123; <span class="comment">//判断是否是对像</span></span><br><span class="line">                <span class="variable">$string</span> .= <span class="title function_ invoke__">_json_to_xml</span>(<span class="variable">$v</span>, <span class="variable">$k</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$string</span> .= <span class="variable">$v</span>; <span class="comment">//取得标签数据</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$string</span> .= <span class="keyword">empty</span>(<span class="variable">$key</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;&lt;/&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：此方法支持<code>&lt;name&gt;aaaa&lt;/name&gt;</code>，不支持<code>&lt;name type=&#39;test&#39;&gt;aaaaa&lt;/name&gt;</code></p>
<h2 id="xml转换成json"><a href="#xml转换成json" class="headerlink" title="xml转换成json"></a>xml转换成json</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xml_to_json</span>(<span class="params"><span class="variable">$source</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//判断source是file，还是string</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$source</span>)) &#123;</span><br><span class="line">        <span class="variable">$xml</span> = <span class="title function_ invoke__">simplexml_load_file</span>(<span class="variable">$source</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$source</span>)) &#123;</span><br><span class="line">        <span class="variable">$xml</span> = <span class="title function_ invoke__">simplexml_load_string</span>(<span class="variable">$source</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="variable">$json</span> = <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="variable">$xml</span>-&gt;<span class="title function_ invoke__">getName</span>() =&gt; <span class="variable">$xml</span>)); <span class="comment">//php5，以及以上，如果是更早版本，请下载JSON.php</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$json</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Naturalwill&#x27;s APP&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;note&quot;</span><span class="punctuation">:</span> <span class="string">&quot;一些细节的优化&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;iOS&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Naturalwill&#x27;s APP&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;note&quot;</span><span class="punctuation">:</span> <span class="string">&quot;正式上线&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;Oldversion&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Android&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Naturalwill&#x27;s APP&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;note&quot;</span><span class="punctuation">:</span> <span class="string">&quot;正式上线&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Naturalwill&#x27;s APP&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;note&quot;</span><span class="punctuation">:</span> <span class="string">&quot;一些细节的优化&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>json_to_xml</code>  ↓↑  <code>xml_to_json</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Android</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Naturalwill&#x27;s APP<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">note</span>&gt;</span>一些细节的优化<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Android</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">iOS</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Naturalwill&#x27;s APP<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">note</span>&gt;</span>正式上线<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">iOS</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Oldversion</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Android</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Naturalwill&#x27;s APP<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">note</span>&gt;</span>正式上线<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">Android</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Android</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Naturalwill&#x27;s APP<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">note</span>&gt;</span>一些细节的优化<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">Android</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Oldversion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>简单健康咨询系统Web API的设计与实现</title>
    <url>/2015/12/30/Simple-Healthcare-Consulting-System-API/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本教程专为刚刚熟悉基本知识的、但还没有接触到太多高级主题的开发者而设计。本教程也是想要去探索PHP编程一个很好的开始。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li><a href="#%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C">提供用户注册&#x2F;登陆接口</a></li>
<li><a href="#%E5%92%A8%E8%AF%A2%E6%9F%A5%E7%9C%8B">匿名用户可以浏览已有咨询</a></li>
<li><a href="#%E5%92%A8%E8%AF%A2%E6%8F%90%E4%BA%A4">已注册用户可以发布、评论咨询</a></li>
</ul>
<span id="more"></span>

<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><h4 id="表-users"><a href="#表-users" class="headerlink" title="表: users"></a>表: users</h4><table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">type</th>
<th align="left">note</th>
</tr>
</thead>
<tbody><tr>
<td align="left">uid</td>
<td align="left">mediumint(8)</td>
<td align="left">用户ID, 自动增长</td>
</tr>
<tr>
<td align="left">username</td>
<td align="left">char(15)</td>
<td align="left">用户名</td>
</tr>
<tr>
<td align="left">usertype</td>
<td align="left">bit</td>
<td align="left">用户类型, 0代表普通用户, 1代表管理员</td>
</tr>
<tr>
<td align="left">password</td>
<td align="left">char(32)</td>
<td align="left">密码</td>
</tr>
</tbody></table>
<h4 id="表-ziunx"><a href="#表-ziunx" class="headerlink" title="表: ziunx"></a>表: ziunx</h4><table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">type</th>
<th align="left">note</th>
</tr>
</thead>
<tbody><tr>
<td align="left">zid</td>
<td align="left">mediumint(8)</td>
<td align="left">咨询ID</td>
</tr>
<tr>
<td align="left">uid</td>
<td align="left">mediumint(8)</td>
<td align="left">发布用户ID</td>
</tr>
<tr>
<td align="left">subject</td>
<td align="left">char(80)</td>
<td align="left">标题</td>
</tr>
<tr>
<td align="left">message</td>
<td align="left">text</td>
<td align="left">咨询正文</td>
</tr>
<tr>
<td align="left">dateline</td>
<td align="left">int(10)</td>
<td align="left">时间戳</td>
</tr>
</tbody></table>
<h4 id="表-comment"><a href="#表-comment" class="headerlink" title="表: comment"></a>表: comment</h4><table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">type</th>
<th align="left">note</th>
</tr>
</thead>
<tbody><tr>
<td align="left">cid</td>
<td align="left">mediumint(8)</td>
<td align="left">评论ID</td>
</tr>
<tr>
<td align="left">zid</td>
<td align="left">mediumint(8)</td>
<td align="left">咨询ID</td>
</tr>
<tr>
<td align="left">uid</td>
<td align="left">mediumint(8)</td>
<td align="left">作者ID</td>
</tr>
<tr>
<td align="left">message</td>
<td align="left">text</td>
<td align="left">评论正文</td>
</tr>
</tbody></table>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `users` (</span><br><span class="line">  `uid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> auto_increment,</span><br><span class="line">  `username` <span class="type">char</span>(<span class="number">15</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `usertype` bit <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">  `password` <span class="type">char</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY  (`uid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> (`username`) </span><br><span class="line">)<span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `zixun` (</span><br><span class="line">  `zid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `subject` <span class="type">char</span>(<span class="number">80</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `dateline` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `message` mediumtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`zid`)</span><br><span class="line">)<span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `comment` (</span><br><span class="line">  `cid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `zid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `uid` mediumint(<span class="number">8</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `message` mediumtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`cid`)</span><br><span class="line">)<span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="程序结构"><a href="#程序结构" class="headerlink" title="程序结构"></a>程序结构</h2><pre><code>.
|-- config.php //配置文件
|-- common.php //公共文件
|-- index.php  //入口文件
|-- view.php   //咨询查看
|-- user.php   //登陆/注册
|-- submit.php //咨询提交
</code></pre>
<h2 id="程序实现"><a href="#程序实现" class="headerlink" title="程序实现"></a>程序实现</h2><h3 id="引用第三方类库"><a href="#引用第三方类库" class="headerlink" title="引用第三方类库"></a>引用第三方类库</h3><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHVyYWxXaWxsL1BIUC1NeVNRTGktRGF0YWJhc2UtQ2xhc3M=">mysql数据库操作类<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>用于存储数据库连接的配置，加密密钥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * config.php</span></span><br><span class="line"><span class="comment"> * 配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;UC_KEY&#x27;</span>, <span class="string">&#x27;U90ev285I6F7Deh0E7beK7Ueg6zfm9kfE3Q3R8a7W4v0Og1ccb1aH9Veb3YdEbt2&#x27;</span>); <span class="comment">//加密密钥</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_DBCONFIG</span> = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;host&#x27;</span>,     <span class="comment">//服务器地址</span></span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;username&#x27;</span>,    <span class="comment">//用户</span></span><br><span class="line">                <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;password&#x27;</span>, <span class="comment">//密码</span></span><br><span class="line">                <span class="string">&#x27;db&#x27;</span>=&gt; <span class="string">&#x27;databaseName&#x27;</span>, <span class="comment">//数据库</span></span><br><span class="line">                <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">3306</span>, <span class="comment">//服务器端口</span></span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>, <span class="comment">//表名前缀</span></span><br><span class="line">                <span class="string">&#x27;charset&#x27;</span> =&gt; <span class="string">&#x27;utf8&#x27;</span> <span class="comment">//字符集</span></span><br><span class="line">				);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="公共文件"><a href="#公共文件" class="headerlink" title="公共文件"></a>公共文件</h3><p>用于引入配置文件，第三方类库，及定义公共函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * common.php</span></span><br><span class="line"><span class="comment"> * 公共文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">&#x27;MysqliDb.php&#x27;</span>); <span class="comment">//引入mysql操作类</span></span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">&#x27;config.php&#x27;</span>); <span class="comment">//引入配置文件</span></span><br><span class="line"><span class="comment">//程序目录</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;S_ROOT&#x27;</span>, <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SGLOBAL</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">//时间</span></span><br><span class="line"><span class="variable">$mtime</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>, <span class="title function_ invoke__">microtime</span>());</span><br><span class="line"><span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;timestamp&#x27;</span>] = <span class="variable">$mtime</span>[<span class="number">1</span>];</span><br><span class="line"><span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;supe_starttime&#x27;</span>] = <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;timestamp&#x27;</span>] + <span class="variable">$mtime</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$_REQUEST</span>[<span class="string">&#x27;auth&#x27;</span>] = <span class="title function_ invoke__">rawurldecode</span>(<span class="title function_ invoke__">req</span>(<span class="string">&#x27;auth&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">MysqliDb</span>(<span class="variable">$_DBCONFIG</span>); <span class="comment">//连接数据库</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取$_GET或$_POST数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">req</span>(<span class="params"><span class="variable">$arg</span>,<span class="variable">$default</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$arg</span>])?<span class="variable">$default</span>:<span class="variable">$_REQUEST</span>[<span class="variable">$arg</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串解密加密</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authcode</span>(<span class="params"><span class="variable">$string</span>, <span class="variable">$operation</span> = <span class="string">&#x27;DECODE&#x27;</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$expiry</span> = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$ckey_length</span> = <span class="number">4</span>;	<span class="comment">// 随机密钥长度 取值 0-32;</span></span><br><span class="line">				<span class="comment">// 加入随机密钥，可以令密文无任何规律，即便是原文和密钥完全相同，加密结果也会每次不同，增大破解难度。</span></span><br><span class="line">				<span class="comment">// 取值越大，密文变动规律越大，密文变化 = 16 的 $ckey_length 次方</span></span><br><span class="line">				<span class="comment">// 当此值为 0 时，则不产生随机密钥</span></span><br><span class="line"></span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span> ? <span class="variable">$key</span> : UC_KEY);</span><br><span class="line">	<span class="variable">$keya</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$key</span>, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">	<span class="variable">$keyb</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$key</span>, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">	<span class="variable">$keyc</span> = <span class="variable">$ckey_length</span> ? (<span class="variable">$operation</span> == <span class="string">&#x27;DECODE&#x27;</span> ? <span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">0</span>, <span class="variable">$ckey_length</span>): <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">microtime</span>()), -<span class="variable">$ckey_length</span>)) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$cryptkey</span> = <span class="variable">$keya</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$keya</span>.<span class="variable">$keyc</span>);</span><br><span class="line">	<span class="variable">$key_length</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$cryptkey</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$string</span> = <span class="variable">$operation</span> == <span class="string">&#x27;DECODE&#x27;</span> ? <span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="variable">$ckey_length</span>)) : <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%010d&#x27;</span>, <span class="variable">$expiry</span> ? <span class="variable">$expiry</span> + <span class="title function_ invoke__">time</span>() : <span class="number">0</span>).<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$string</span>.<span class="variable">$keyb</span>), <span class="number">0</span>, <span class="number">16</span>).<span class="variable">$string</span>;</span><br><span class="line">	<span class="variable">$string_length</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$box</span> = <span class="title function_ invoke__">range</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$rndkey</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt;= <span class="number">255</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">		<span class="variable">$rndkey</span>[<span class="variable">$i</span>] = <span class="title function_ invoke__">ord</span>(<span class="variable">$cryptkey</span>[<span class="variable">$i</span> % <span class="variable">$key_length</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">		<span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$i</span>] + <span class="variable">$rndkey</span>[<span class="variable">$i</span>]) % <span class="number">256</span>;</span><br><span class="line">		<span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$i</span>];</span><br><span class="line">		<span class="variable">$box</span>[<span class="variable">$i</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">		<span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$a</span> = <span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$string_length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">		<span class="variable">$a</span> = (<span class="variable">$a</span> + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">		<span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$a</span>]) % <span class="number">256</span>;</span><br><span class="line">		<span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$a</span>];</span><br><span class="line">		<span class="variable">$box</span>[<span class="variable">$a</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">		<span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">		<span class="variable">$result</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$string</span>[<span class="variable">$i</span>]) ^ (<span class="variable">$box</span>[(<span class="variable">$box</span>[<span class="variable">$a</span>] + <span class="variable">$box</span>[<span class="variable">$j</span>]) % <span class="number">256</span>]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$operation</span> == <span class="string">&#x27;DECODE&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((<span class="title function_ invoke__">substr</span>(<span class="variable">$result</span>, <span class="number">0</span>, <span class="number">10</span>) == <span class="number">0</span> || <span class="title function_ invoke__">substr</span>(<span class="variable">$result</span>, <span class="number">0</span>, <span class="number">10</span>) - <span class="title function_ invoke__">time</span>() &gt; <span class="number">0</span>) &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$result</span>, <span class="number">10</span>, <span class="number">16</span>) == <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$result</span>, <span class="number">26</span>).<span class="variable">$keyb</span>), <span class="number">0</span>, <span class="number">16</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$result</span>, <span class="number">26</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$keyc</span>.<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断当前用户登录状态</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkauth</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$_SGLOBAL</span>;</span><br><span class="line">	<span class="variable">$auth</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;auth&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$auth</span>) &#123;</span><br><span class="line">		<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">		@<span class="keyword">list</span>(<span class="variable">$password</span>, <span class="variable">$uid</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;\t&quot;</span>, <span class="title function_ invoke__">authcode</span>(<span class="variable">$auth</span>, <span class="string">&#x27;DECODE&#x27;</span>));</span><br><span class="line">		<span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$uid</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$password</span> &amp;&amp; <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>]) &#123;</span><br><span class="line">			<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;uid&#x27;</span>, <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>]);</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$user</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">getOne</span>(<span class="string">&#x27;users&#x27;</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$user</span>[<span class="string">&#x27;password&#x27;</span>] == <span class="variable">$password</span>) &#123;</span><br><span class="line">					<span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;usertype&#x27;</span>] = <span class="variable">$user</span>[<span class="string">&#x27;usertype&#x27;</span>];					</span><br><span class="line">					<span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;to_login&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回json数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string  $code 错误代码，0代表正确，1代表错误</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string  $message 错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string  $data json数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showjson</span>(<span class="params"><span class="variable">$message</span>, <span class="variable">$code</span>=<span class="number">1</span>, <span class="variable">$data</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">ob_clean</span>();	</span><br><span class="line">	<span class="variable">$r</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$r</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="variable">$code</span>;</span><br><span class="line">	<span class="variable">$r</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="variable">$message</span>;</span><br><span class="line">	<span class="variable">$r</span>[<span class="string">&#x27;data&#x27;</span>] = <span class="variable">$data</span>;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Cache-Control: no-cache, must-revalidate&#x27;</span>);</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/json;&#x27;</span>); </span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$r</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户操作"><a href="#用户操作" class="headerlink" title="用户操作"></a>用户操作</h3><p>提供用户注册&#x2F;登陆接口</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * common.php</span></span><br><span class="line"><span class="comment"> * 用户操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//注册用户</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$data</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">	<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$data</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>])&#123;</span><br><span class="line">		<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">		<span class="variable">$data</span>[<span class="string">&#x27;usertype&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="variable">$id</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">insert</span> (<span class="string">&#x27;users&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$id</span>) <span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;username_exist&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;register_error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//验证用户名密码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$password</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">	<span class="variable">$username</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">	<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$password</span> &amp;&amp; <span class="variable">$username</span>) &#123;</span><br><span class="line">		<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;username&#x27;</span>, <span class="variable">$username</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">getOne</span>(<span class="string">&#x27;users&#x27;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$user</span>[<span class="string">&#x27;password&#x27;</span>] == <span class="variable">$password</span>) &#123;</span><br><span class="line">				<span class="variable">$auth</span> = <span class="title function_ invoke__">authcode</span>(<span class="string">&quot;<span class="subst">$user</span>[password]\t<span class="subst">$user</span>[uid]&quot;</span>, <span class="string">&#x27;ENCODE&#x27;</span>);</span><br><span class="line">				<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>, <span class="keyword">array</span>(<span class="string">&quot;m_auth&quot;</span>=&gt;<span class="title function_ invoke__">rawurlencode</span>(<span class="variable">$auth</span>)));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;password_error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;login_error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="咨询查看"><a href="#咨询查看" class="headerlink" title="咨询查看"></a>咨询查看</h3><p>匿名用户可以浏览已有咨询</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>PHP</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * view.php</span></span><br><span class="line"><span class="comment"> * 咨询查看</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//列出咨询</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listzx</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$start</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;start&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="variable">$perpage</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;perpage&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$start</span>&lt;<span class="number">0</span>) <span class="variable">$start</span>=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$perpage</span>))	<span class="variable">$perpage</span> = <span class="number">10</span>;</span><br><span class="line">	<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">	<span class="variable">$stats</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">getOne</span> (<span class="string">&quot;comment&quot;</span>, <span class="string">&quot;count(*) as cnt&quot;</span>);</span><br><span class="line">	<span class="variable">$data</span>=<span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$data</span>[<span class="string">&#x27;total&#x27;</span>] = <span class="variable">$stats</span>[<span class="string">&#x27;cnt&#x27;</span>];</span><br><span class="line">	<span class="variable">$list</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">rawQuery</span>(<span class="string">&quot;SELECT z.*, u.username FROM zixun z LEFT JOIN users u ON z.uid=u.uid ORDER BY z.dateline DESC LIMIT <span class="subst">$start</span>,<span class="subst">$perpage</span>&quot;</span>);</span><br><span class="line">	<span class="variable">$data</span>[<span class="string">&#x27;count&#x27;</span>] = <span class="variable">$db</span>-&gt;count;</span><br><span class="line">	<span class="variable">$data</span>[<span class="string">&#x27;list&#x27;</span>] = <span class="variable">$list</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$db</span>-&gt;count &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>, <span class="keyword">array</span>(<span class="string">&quot;zixun&quot;</span>=&gt;<span class="variable">$data</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;list_error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//显示咨询内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showzx</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$zid</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;zid&#x27;</span>);</span><br><span class="line">	<span class="variable">$start</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;start&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="variable">$perpage</span> = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;perpage&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$start</span>&lt;<span class="number">0</span>) <span class="variable">$start</span>=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$perpage</span>))	<span class="variable">$perpage</span> = <span class="number">30</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$zid</span>))	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;zid_not_exist&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line"></span><br><span class="line">	<span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">rawQueryOne</span> (<span class="string">&quot;SELECT z.*, u.username FROM zixun z LEFT JOIN users u ON z.uid=u.uid WHERE z.zid=&#x27;<span class="subst">$zid</span>&#x27;&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$db</span>-&gt;count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span> (<span class="string">&quot;zid&quot;</span>, <span class="variable">$zid</span>);</span><br><span class="line">		<span class="variable">$stats</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">getOne</span> (<span class="string">&quot;comment&quot;</span>, <span class="string">&quot;count(*) as cnt&quot;</span>);</span><br><span class="line">		<span class="variable">$data</span>[<span class="string">&#x27;total&#x27;</span>] = <span class="variable">$stats</span>[<span class="string">&#x27;cnt&#x27;</span>];</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//if($start&gt;=$data[&#x27;total&#x27;]) $start=0;</span></span><br><span class="line">		<span class="variable">$comment</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">rawQuery</span>(<span class="string">&quot;SELECT c.*,s.username FROM comment c LEFT JOIN users s ON c.uid=s.uid WHERE c.zid=&#x27;<span class="subst">$zid</span>&#x27; ORDER BY c.cid LIMIT <span class="subst">$start</span>,<span class="subst">$perpage</span>&quot;</span>);</span><br><span class="line">		<span class="variable">$data</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="variable">$db</span>-&gt;count;</span><br><span class="line">		<span class="variable">$data</span>[<span class="string">&#x27;comment&#x27;</span>]=<span class="variable">$comment</span> ;</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>, <span class="keyword">array</span>(<span class="string">&quot;zixun&quot;</span>=&gt;<span class="variable">$data</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;show_error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="咨询提交"><a href="#咨询提交" class="headerlink" title="咨询提交"></a>咨询提交</h3><p>已注册用户可以发布、评论咨询</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?</span>PHP</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * common.php</span></span><br><span class="line"><span class="comment"> * 咨询提交</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//发布咨询</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zixun</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$_SGLOBAL</span>;</span><br><span class="line">	<span class="title function_ invoke__">checkauth</span>();   <span class="comment">//验证登陆</span></span><br><span class="line">	</span><br><span class="line">	<span class="variable">$op</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;op&#x27;</span>);</span><br><span class="line">	<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$op</span>==<span class="string">&#x27;add&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$setarr</span> = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;uid&#x27;</span> =&gt; <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>],</span><br><span class="line">			<span class="string">&#x27;dateline&#x27;</span> =&gt; <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;timestamp&#x27;</span>]</span><br><span class="line">		);</span><br><span class="line">		<span class="variable">$setarr</span>[<span class="string">&#x27;subject&#x27;</span>] = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;subject&#x27;</span>);</span><br><span class="line">		<span class="variable">$setarr</span>[<span class="string">&#x27;message&#x27;</span>] = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;message&#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$setarr</span>[<span class="string">&#x27;subject&#x27;</span>]&amp;&amp;<span class="variable">$setarr</span>[<span class="string">&#x27;message&#x27;</span>])&#123;</span><br><span class="line">			<span class="variable">$id</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="string">&#x27;zixun&#x27;</span>, <span class="variable">$setarr</span>);   <span class="comment">//插入数据</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$id</span>)&#123;</span><br><span class="line">				<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>, <span class="keyword">array</span>(<span class="string">&quot;zid&quot;</span>=&gt;<span class="variable">$id</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;submit_zixun_error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;subject_or_message_can_not_empty&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span>(<span class="variable">$op</span>==<span class="string">&#x27;del&#x27;</span>)&#123;</span><br><span class="line">		<span class="variable">$zid</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;zid&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$zid</span>))&#123;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;non_normal_operation&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;zid&#x27;</span>, <span class="variable">$zid</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;usertype&#x27;</span>]==<span class="number">1</span>)&#123; <span class="comment">//是否管理员</span></span><br><span class="line">			</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;uid&#x27;</span>, <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;zixun&#x27;</span>);   <span class="comment">//删除咨询</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>) &#123;</span><br><span class="line">			<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;zid&#x27;</span>, <span class="variable">$zid</span>);</span><br><span class="line">			<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;comment&#x27;</span>);  <span class="comment">//删除对应的评论</span></span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;zixun_not_exist&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;error_submit&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//评论咨询</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">comment</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$_SGLOBAL</span>;</span><br><span class="line">	<span class="title function_ invoke__">checkauth</span>();   <span class="comment">//验证登陆</span></span><br><span class="line">	</span><br><span class="line">	<span class="variable">$op</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;op&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$db</span> = <span class="title class_">MysqliDb</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$op</span>==<span class="string">&#x27;add&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$setarr</span> = <span class="keyword">array</span>(<span class="string">&#x27;uid&#x27;</span> =&gt; <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>]);</span><br><span class="line">		<span class="variable">$setarr</span>[<span class="string">&#x27;message&#x27;</span>] = <span class="title function_ invoke__">req</span>(<span class="string">&#x27;message&#x27;</span>);</span><br><span class="line">		<span class="variable">$setarr</span>[<span class="string">&#x27;zid&#x27;</span>] =<span class="title function_ invoke__">req</span>(<span class="string">&#x27;zid&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$setarr</span>[<span class="string">&#x27;message&#x27;</span>]&amp;&amp;<span class="variable">$setarr</span>[<span class="string">&#x27;zid&#x27;</span>])&#123;</span><br><span class="line">			<span class="variable">$id</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="string">&#x27;comment&#x27;</span>, <span class="variable">$setarr</span>);   <span class="comment">//插入数据</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$id</span>)&#123;</span><br><span class="line">				<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>, <span class="number">0</span>, <span class="keyword">array</span>(<span class="string">&quot;cid&quot;</span>=&gt;<span class="variable">$id</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;submit_comment_error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;zid_or_message_can_not_empty&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span>(<span class="variable">$op</span>==<span class="string">&#x27;del&#x27;</span>)&#123;</span><br><span class="line">		<span class="variable">$cid</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;cid&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$cid</span>))&#123;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;non_normal_operation&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;cid&#x27;</span>, <span class="variable">$cid</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;usertype&#x27;</span>]==<span class="number">1</span>)&#123; <span class="comment">//是否管理员</span></span><br><span class="line">			</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;uid&#x27;</span>, <span class="variable">$_SGLOBAL</span>[<span class="string">&#x27;uid&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;comment&#x27;</span>);   <span class="comment">//删除评论</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;do_success&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;comment_not_exist&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h3><p>程序的主入口</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>PHP</span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">&#x27;common.php&#x27;</span>); <span class="comment">//引入公共文件</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$do</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;do&#x27;</span>);</span><br><span class="line"><span class="variable">$ac</span>=<span class="title function_ invoke__">req</span>(<span class="string">&#x27;ac&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//允许的方法</span></span><br><span class="line"><span class="variable">$acs</span> = <span class="keyword">array</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;submit&#x27;</span>, <span class="string">&#x27;view&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$ac</span>) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$ac</span>, <span class="variable">$acs</span>)) &#123;</span><br><span class="line">	<span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;error_ac&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include_once</span>(S_ROOT.<span class="variable">$ac</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="variable">$do</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">call_user_func</span>(<span class="variable">$do</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">showjson</span>(<span class="string">&#x27;error_do&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="接口使用方法"><a href="#接口使用方法" class="headerlink" title="接口使用方法"></a>接口使用方法</h2><p>查看<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHVyYWxXaWxsL1NpbXBsZS1IZWFsdGhjYXJlLUNvbnN1bHRpbmctU3lzdGVtLUFQSSMlZTYlOGUlYTUlZTUlOGYlYTMlZTQlYmQlYmYlZTclOTQlYTglZTYlOTYlYjklZTYlYjMlOTU=">接口使用方法<i class="fa fa-external-link-alt"></i></span>。</p>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p>查看<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHVyYWxXaWxsL1NpbXBsZS1IZWFsdGhjYXJlLUNvbnN1bHRpbmctU3lzdGVtLUFQSQ==">项目地址<i class="fa fa-external-link-alt"></i></span>。</p>
<p><strong>版权</strong>: 本文采用以下协议进行授权, <span class="exturl" data-url="aHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnktbmMtbmQvMy4wL2RlZWQuemg=">自由转载 - 非商用 - 非衍生 - 保持署名 | Creative Commons BY-NC-ND 3.0<i class="fa fa-external-link-alt"></i></span>。</p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>API</tag>
      </tags>
  </entry>
  <entry>
    <title>ArchLinux下修改wine的默认浏览器</title>
    <url>/2016/02/24/Modify-wine-default-webbrowser-in-archlinux/</url>
    <content><![CDATA[<p>wine 1.9 已经可以运行 QQ 7.1 了，体验已经算是很不错了，唯一感觉美中不足的就是在QQ上点开邮箱时，用的wine iexplore不能正常打开QQ邮箱，Google了一下，发现网上只有通过修改注册表的方式修改wine的默认浏览器，然而我按网上的方法来发现根本没有那些注册表项，于是只好自己想办法了。</p>
<hr>
<p>首先，打开gnome自带的系统监视器，找到当前运行的iexplore的位置</p>
<p><code>/home/username/.wine/drive_c/Program Files (x86)/Internet Explorer/iexplore.exe</code></p>
<p>然后，把ie替换为我们想要用的浏览器。</p>
<p>具体做法：</p>
<ol>
<li><p>为以防万一，先备份ie浏览器</p>
<pre><code> $ cd ～/.wine/drive_c/Program\ Files\ \(x86\)/Internet\ Explorer
 $ mv iexplore.exe iexplore.exe.backup
</code></pre>
</li>
<li><p>找到自己正在用的浏览器的位置，创建软连接，比如我用的是Archlinux AUR里的google-chrome</p>
<pre><code> $ ln -s $(which google-chrome-stable) iexplore.exe
</code></pre>
</li>
</ol>
<p>完成！当我们再次点击QQ邮箱的图标，打开邮箱的浏览器已经变成Google-chrome了～～<br>（如果你使用的是其他的浏览器，只需要把上面的<code>google-chrome-stable</code>改为你在终端中打开浏览器的命令就可以。）</p>
<span id="more"></span>

<p>PS: 附上 google-chrome-stable 文件内容：</p>
<pre><code>    $ cat $(which google-chrome-stable)

    #!/bin/bash

    # Allow users to override command-line options
    if [[ -f ~/.config/chrome-flags.conf ]]; then
            CHROME_USER_FLAGS=&quot;$(cat ~/.config/chrome-flags.conf)&quot;
    fi

    # Launch
    exec /opt/google/chrome/google-chrome $CHROME_USER_FLAGS &quot;$@&quot;%
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Wine</tag>
        <tag>Notes</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下文件的压缩与解压缩</title>
    <url>/2016/07/03/compress-and-extract-files-on-linux/</url>
    <content><![CDATA[<h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><pre><code># 创建压缩包
tar -cvf name-of-archive.tar /path/to/directory-or-file    
tar -cvf name-of-archive.tar /home/arch --exclude=/home/arch/.cache --exclude=/home/arch/Downloads
tar -cvf name-of-archive.tar /home/arch --exclude=*.jpg

tar -czvf name-of-archive.tar.gz /path/to/directory-or-file    
tar -cJvf name-of-archive.tar.xz /path/to/directory-or-file    
tar -cjvf name-of-archive.tar.bz2 /path/to/directory-or-file    
tar -cZvf name-of-archive.tar.Z /path/to/directory-or-file    


# 查看压缩包内容
tar -tf archive.tar
tar -tvf archive.tar
tar -tzf archive.tar.gz
tar -tzvf archive.tar.gz


# 解压文件
tar -xvf archive.tar
tar -xvf archive.tar -C /tmp

tar -xzvf archive.tar.gz
tar -xJvf archive.tar.xz
tar -xjvf archive.tar.bz2
tar -xZvf archive.tar.Z
</code></pre>
<p>参数解释<br>    * -c: 创建压缩包（create）<br>    * -t: 列出压缩包内容（list）<br>    * -x: 提取文件（extract）<br>    * -v: 显示详细信息（verbose）<br>    * -f: 用于指定文件名（filename），f后必须接文件名。<br>    * -C: 解压到指定目录<br>    * –exclude: 忽略文件或目录<br>    * -z: 使用 gzip 算法来创建压缩包或提取文件。<br>    * -J: 使用 xz 算法创建压缩包或提取文件。<br>    * -j: 使用 bzip2 算法创建压缩包或提取文件。<br>    * -Z: 使用 ncompress 算法创建压缩包或提取文件。</p>
<span id="more"></span>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><pre><code># 7z
7z a archive.7z /path/to/directory-or-file
7z x archive.7z
7z x archive.rar

# zip
zip -r archive.zip /path/to/directory-or-file
unzip archive.zip

# gzip
gzip archive.tar
gunzip archive.tar.gz

# xz
xz archive.tar
unxz archive.tar.xz

# bzip2
bzip2 archive.tar
bunzip2 archive.tar.bz2

# Z
compress archive.tar
uncompress archive.tar.Z
</code></pre>
<h3 id="jar"><a href="#jar" class="headerlink" title="jar"></a>jar</h3><pre><code>jar -cvf archive.jar /path/to/directory-or-file
jar -xvf archive.jar
</code></pre>
<p>注：如果是打包的是Java类库，并且该类库中存在主类，那么需要写一个 META-INF&#x2F;MANIFEST.MF 配置文件，内容如下：</p>
<pre><code>Manifest-Version: 1.0
Created-By: 1.6.0_27 (Sun Microsystems Inc.)
Main-class: the_name_of_the_main_class_should_be_put_here
</code></pre>
<p>然后用如下命令打包：</p>
<pre><code>jar -cvfm name-of-archive.jar META-INF/MANIFEST.MF /path/to/directory-or-file
</code></pre>
<p>这样以后就能用 <code>java -jar name-of-archive.jar</code> 命令直接运行主类中的 <code>public static void main</code> 方法了。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>tar</tag>
        <tag>7z</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 14.04 上部署LNMP，并开启HTTPS</title>
    <url>/2016/07/07/Secure-LNMP-on-Ubuntu-14-04/</url>
    <content><![CDATA[<p>本教程将会涉及以下工具：</p>
<ul>
<li>Ubuntu 14.04</li>
<li>MySQL</li>
<li>PHP</li>
<li>Nginx</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>更新软件源</p>
<pre><code>sudo apt-get update
</code></pre>
<p>安装必要组件</p>
<pre><code>sudo apt-get install mysql-server   # 安装 MySQL

sudo apt-get install nginx-full     # 安装 Nginx

sudo apt-get install php5-fpm       # 安装 php5
sudo apt-get install php5-cli       # 安装 php5 命令行工具
sudo apt-get install php5-mcrypt php5-mysql php5-curl    # 安装常用 php5 扩展
</code></pre>
<p>安装 PHP 依赖管理工具 composer (可选)</p>
<pre><code>sudo apt-get install git     # 安装 git

# 安装 composer
cd ~
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
</code></pre>
<span id="more"></span>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="PHP-配置"><a href="#PHP-配置" class="headerlink" title="PHP 配置"></a>PHP 配置</h3><p>打开配置文件：</p>
<pre><code>sudo nano /etc/php5/fpm/php.ini
</code></pre>
<p>找到 cgi.fix_pathinfo 修改为 0 ，如下：</p>
<pre><code>cgi.fix_pathinfo=0
</code></pre>
<p>保存并退出，因为这是一个可能的安全漏洞，详情可以看<span class="exturl" data-url="aHR0cDovL3d3dy5sYXJ1ZW5jZS5jb20vMjAxMC8wNS8yMC8xNDk1Lmh0bWw=">鸟哥的文章<i class="fa fa-external-link-alt"></i></span>！</p>
<p>使用 php5enmod 启用 MCrypt 扩展，并重启 php5-fpm 服务：</p>
<pre><code>sudo php5enmod mcrypt
sudo service php5-fpm restart
</code></pre>
<h3 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h3><p>创建网站目录 ：</p>
<pre><code>sudo mkdir -p /var/www/default
</code></pre>
<p>打开 nginx 默认配置文件：</p>
<pre><code>sudo nano /etc/nginx/sites-available/default
</code></pre>
<p>默认配置如下：</p>
<pre><code># You may add here your
# server &#123;
#       ...
# &#125;
# statements for each of your virtual hosts to this file

##
# You should look at the following URL&#39;s in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

server &#123;
        listen 80 default_server;
        listen [::]:80 default_server ipv6only=on;

        root /usr/share/nginx/html;
        index index.html index.htm;

        # Make site accessible from http://localhost/
        server_name localhost;

        location / &#123;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
                # Uncomment to enable naxsi on this location
                # include /etc/nginx/naxsi.rules
        &#125;

        # Only for nginx-naxsi used with nginx-naxsi-ui : process denied requests
        #location /RequestDenied &#123;
        #       proxy_pass http://127.0.0.1:8080;
        #&#125;

        #error_page 404 /404.html;

        # redirect server error pages to the static page /50x.html
        #
        #error_page 500 502 503 504 /50x.html;
        #location = /50x.html &#123;
        #       root /usr/share/nginx/html;
        #&#125;

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ &#123;
        #       fastcgi_split_path_info ^(.+\.php)(/.+)$;
        #       # NOTE: You should have &quot;cgi.fix_pathinfo = 0;&quot; in php.ini
        #
        #       # With php5-cgi alone:
        #       fastcgi_pass 127.0.0.1:9000;
        #       # With php5-fpm:
        #       fastcgi_pass unix:/var/run/php5-fpm.sock;
        #       fastcgi_index index.php;
        #       include fastcgi_params;
        #&#125;

        # deny access to .htaccess files, if Apache&#39;s document root
        # concurs with nginx&#39;s one
        #
        #location ~ /\.ht &#123;
        #       deny all;
        #&#125;
&#125;


# another virtual host using mix of IP-, name-, and port-based configuration
#
#server &#123;
#       listen 8000;
#       listen somename:8080;
#       server_name somename alias another.alias;
#       root html;
#       index index.html index.htm;
#
#       location / &#123;
#               try_files $uri $uri/ =404;
#       &#125;
#&#125;


# HTTPS server
#
#server &#123;
#       listen 443;
#       server_name localhost;
#
#       root html;
#       index index.html index.htm;
#
#       ssl on;
#       ssl_certificate cert.pem;
#       ssl_certificate_key cert.key;
#
#       ssl_session_timeout 5m;
#
#       ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
#       ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;
#       ssl_prefer_server_ciphers on;
#
#       location / &#123;
#               try_files $uri $uri/ =404;
#       &#125;
#&#125;
</code></pre>
<p>修改如下：</p>
<pre><code>server &#123;
    # 监听 80 端口
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;
    
    # 监听 443 端口
    listen 443 ssl;
    listen [::]:443 ssl ipv6only=on;
    
     # 服务器名称，server_domain_or_IP 请替换为自己设置的名称或者 IP 地址
    server_name server_domain_or_IP;
    
    # 设定网站根目录
    root /var/www/default;
    # 网站默认首页
    index index.php index.html index.htm;

    # 开启 SSL 并设置证书路径
    ssl on;
    ssl_certificate  /path/to/your/domain/cert/cert.crt;
    ssl_certificate_key /path/to/your/domain/cert/cert.key;

    # SSL 配置
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;
    ssl_prefer_server_ciphers on;
    
    # 强制用 HTTPS 访问，如不需要可以注释掉
    add_header Strict-Transport-Security max-age=63072000;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    location / &#123;
        try_files $uri $uri/ =404;
        
        # Laravel 转发规则，若使用 Laravel 框架，则修改为此配置
        #try_files $uri $uri/ /index.php?$query_string;  
    &#125;
    

    # PHP 支持
    location ~ \.php$ &#123;
        try_files $uri /index.php =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    &#125;
&#125;
</code></pre>
<p>重启 nginx 服务：</p>
<pre><code>sudo service nginx restart
</code></pre>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>在浏览器打开上面设置的 <code>server_domain_or_IP</code> 即可。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>Linux</tag>
        <tag>HTTPS</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>How To Create Facade On Laravel 5.2</title>
    <url>/2016/08/24/Create-Facade-on-Laravel-5-2/</url>
    <content><![CDATA[<p>Reference <span class="exturl" data-url="aHR0cDovL3d3dy5uMGltcG9zc2libGUuY29tL2FydGljbGUvaG93LXRvLWNyZWF0ZS1mYWNhZGUtb24tbGFyYXZlbC01MQ==">How To Create Facade On Laravel 5.1<i class="fa fa-external-link-alt"></i></span></p>
<p>Here is step by step to create facade on laravel 5.2</p>
<ol>
<li>Create PHP Class File.</li>
<li>Bind that class to Service Provider</li>
<li>Register that ServiceProvider to config\app.php as providers</li>
<li>Create Class which is this class extends to Illuminate\Support\Facades\Facade</li>
<li>Register point 4 to config\app.php as aliases</li>
</ol>
<h2 id="Step-1-Create-PHP-Class-File-for-example-in-App-Classes-UauthHelper-php"><a href="#Step-1-Create-PHP-Class-File-for-example-in-App-Classes-UauthHelper-php" class="headerlink" title="Step 1 - Create PHP Class File, for example in App\Classes\UauthHelper.php"></a>Step 1 - Create PHP Class File, for example in App\Classes\UauthHelper.php</h2><pre><code>&lt;?php

namespace App\Classes;

class UauthHelper &#123;
    public function foo()
    &#123;
        echo &quot;foo&quot;;
    &#125;
&#125;
</code></pre>
<h2 id="Step-2-Bind-that-class-to-Service-Provider"><a href="#Step-2-Bind-that-class-to-Service-Provider" class="headerlink" title="Step 2 - Bind that class to Service Provider"></a>Step 2 - Bind that class to Service Provider</h2><p>In case i create a new serviceprovider by execute</p>
<pre><code>php artisan make:provider &#39;UauthServiceProvider&#39;
</code></pre>
<p>then add</p>
<pre><code>        $this-&gt;app-&gt;bind(&#39;uauth&#39;, function () &#123;
            return new \App\Classes\UauthHelper;
        &#125;);
        
        
</code></pre>
<span id="more"></span>
<p>Like so</p>
<pre><code>&lt;?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\App;

class UauthServiceProvider extends ServiceProvider
&#123;
    /*
     * Bootstrap the application services.
     *
     * @return void
     */
    public function boot()
    &#123;
        //
    &#125;

    /*
     * Register the application services.
     *
     * @return void
     */
    public function register()
    &#123;
        //
        $this-&gt;app-&gt;bind(&#39;uauth&#39;, function () &#123;
            return new \App\Classes\UauthHelper;
        &#125;);
    &#125;
&#125;
</code></pre>
<h2 id="Step-3-Register-that-ServiceProvider-to-config-app-php-as-providers"><a href="#Step-3-Register-that-ServiceProvider-to-config-app-php-as-providers" class="headerlink" title="Step 3 - Register that ServiceProvider to config\app.php as providers"></a>Step 3 - Register that ServiceProvider to config\app.php as providers</h2><pre><code>     /*
     * Application Service Providers...
     */
    App\Providers\UauthServiceProvider::class,
</code></pre>
<h2 id="Step-4-Create-Class-which-is-this-class-extends-to-Illuminate-Support-Facades-Facade"><a href="#Step-4-Create-Class-which-is-this-class-extends-to-Illuminate-Support-Facades-Facade" class="headerlink" title="Step 4 - Create Class which is this class extends to Illuminate\Support\Facades\Facade"></a>Step 4 - Create Class which is this class extends to Illuminate\Support\Facades\Facade</h2><p>For Example I create this class in App\Facades\Uauth.php</p>
<pre><code>&lt;?php

namespace App\Facades;
use Illuminate\Support\Facades\Facade;


class Uauth extends Facade&#123;
    
    protected static function getFacadeAccessor()
    &#123;
        return &#39;uauth&#39;;
    &#125;
&#125;
</code></pre>
<h2 id="Step-5-Register-point-4-to-config-app-php-as-aliases"><a href="#Step-5-Register-point-4-to-config-app-php-as-aliases" class="headerlink" title="Step 5 - Register point 4 to config\app.php as aliases"></a>Step 5 - Register point 4 to config\app.php as aliases</h2><pre><code>    &#39;Uauth&#39; =&gt; App\Facades\Uauth::class
    
</code></pre>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>On App\Http\routes.php create single route</p>
<pre><code>Route::get(&#39;/&#39;, function()&#123;
    Uauth::foo();
&#125;);
</code></pre>
<p>Then check on your browser</p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>Laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript: 世界上最被误解的语言</title>
    <url>/2016/11/26/JavaScript-the-world-s-most-misunderstood-programming-language/</url>
    <content><![CDATA[<h1 id="JavaScript-世界上最被误解的语言"><a href="#JavaScript-世界上最被误解的语言" class="headerlink" title="JavaScript: 世界上最被误解的语言"></a>JavaScript: 世界上最被误解的语言</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy5jcm9ja2ZvcmQuY29tL2phdmFzY3JpcHQ=">JavaScript<i class="fa fa-external-link-alt"></i></span> , 亦称为 Mocha 、 LiveScript 、 JScript 或 ECMAScript ，是世界上流行的编程语言之一。事实上世界上差不多每台个人电脑都至少安装了一个 JavaScript 解释器。JavaScript 的流行完全是由于他在 WWW 脚本语言领域中的地位决定的。</p>
<p>不管它有多么流行，极少有人了解 JavaScript 是一个十分动态的通用面向对象编程语言。这怎能成为一个秘密呢？为什么这个语言如此被误解？</p>
<h2 id="关于名字"><a href="#关于名字" class="headerlink" title="关于名字"></a>关于名字</h2><p>这个 Java- 前缀暗示了 JavaScript 和 Java 的关系，也就是 JavaScript 是 Java 的一个子集也就是不如 Java 强大。看上去这个名称就故意制造混乱，然后随之而来的是误解。 JavaScript 并不是解释型的 Java 语言。 Java 是解释型的 Java ， JavaScript 是另一种语言。</p>
<p>JavaScript 和 Java 的语法很相似，就象 Java 和 C 的语法相似一样。但它也不是 Java 的子集就像 Java 也不是 C 的子集一样。在应用上， Java 要远比原先设想的好得多（ Java 原称 Oak ）。</p>
<p>JavaScript 并不是由 Sun 公司开发的。 JavaScript 是由 Netscape 公司开发。它本来叫做 LiveScript ，这个名字并不是那样容易混淆。</p>
<p>-Script 后缀暗示了它不是一个真正的编程语言——脚本语言好象不是真正的编程语言。但其实这是一个专长的问题。相对 C 而言， JavaScript 牺牲性能但带来更强的表达力和动态性。</p>
<span id="more"></span>

<h2 id="披着-C-外衣的-Lisp"><a href="#披着-C-外衣的-Lisp" class="headerlink" title="披着 C 外衣的 Lisp"></a>披着 C 外衣的 Lisp</h2><p>JavaScript 的 C 风格的语法，包括大括号和复杂的 for  语句，让它看起来好象是一个普通的过程式语言。这是一个误导因为 JavaScript 和函数式语言如 Lisp 和 Scheme 有更多的共同之处。它用数组代替了列表，用对象代替了属性列表。函数是第一位的，而且有闭包。你不需要平衡那些括号就可以用 lambda 算子。</p>
<h2 id="思维定势"><a href="#思维定势" class="headerlink" title="思维定势"></a>思维定势</h2><p>JavaScript 是原被设计在 Netscape Navigator 中运行的。它的成功让它成为几乎所有浏览器的标准配置。这导致了思维定势。 JavaScript 简直就是程序语言中的 George  Reeves （一位曾扮演超人的演员，但后来死于枪杀，被官方认为自杀，细节不详──译注）。其实， JavaScript 也适合很多和 Web 无关的应用程序。</p>
<h2 id="不断改变的目标"><a href="#不断改变的目标" class="headerlink" title="不断改变的目标"></a>不断改变的目标</h2><p>JavaScript 的第一个版本功能十分弱。它缺少异常处理、内部函数和继承。而它的现在的形态，它已经是一套完整的面向对象语言。但很多看法都是基于认为它的形式不成熟。</p>
<p>管理这个语言的 ECMA 委员正在开发扩展 ，原意是很好，而这样却会加剧这个语言最严重的问题：版本太多了。这也造成了混淆。</p>
<h2 id="设计错误"><a href="#设计错误" class="headerlink" title="设计错误"></a>设计错误</h2><p>没有什么编程语言是完美的， JavaScript 也有它的设计上的错误，如“+”的重载同时表示“加法”与“带类型转换的字符串连接”，和有错误倾向的 with 语句应该避免使用。保留字策略过于严格。分号的加入是一个很大的错误，正则表达式的记号也是。这些错误会导致编程错误，并把整个语言的设计视为问题。幸运的是，这些问题可以用一个很好和 <span class="exturl" data-url="aHR0cDovL3d3dy5qc2xpbnQuY29tLw==">lint<i class="fa fa-external-link-alt"></i></span> 程序来避免。</p>
<p>这个语言的设计从整体上看还是十分健全的。但很令人惊讶的是， ECMAScript 委员会好象根本不想修正这些错误。也许他们对重新制作一个更感兴趣。</p>
<h2 id="肮脏的实现"><a href="#肮脏的实现" class="headerlink" title="肮脏的实现"></a>肮脏的实现</h2><p>JavaScript 早期实现错误百出。这对该语言带来了很恶劣的影响。更糟糕的是，这些实现还被嵌入的更错误百出的浏览器中。</p>
<h2 id="拙劣的书籍"><a href="#拙劣的书籍" class="headerlink" title="拙劣的书籍"></a>拙劣的书籍</h2><p>几乎所有的书籍都是相当可怕的。他们包含错误，不好的例子，并促进坏做法。语言的重要特征经常被解释得很差，或者完全干脆完全不写。我回顾了JavaScript的几十本书，我只能推荐其一： <span class="exturl" data-url="aHR0cDovL3d3dy5hbWF6b24uY29tL2V4ZWMvb2JpZG9zL0FTSU4vMDU5NjEwMTk5Ni93cnJybGR3aWRld2Vi">JavaScript: The Definitive Guide (5th Edition)<i class="fa fa-external-link-alt"></i></span> by David Flanagan. </p>
<h2 id="不够标准的标准"><a href="#不够标准的标准" class="headerlink" title="不够标准的标准"></a>不够标准的标准</h2><p>JavaScript 的<span class="exturl" data-url="aHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL3B1YmxpY2F0aW9ucy9zdGFuZGFyZHMvRWNtYS0yNjIuaHRt">官方标准规格说明书<i class="fa fa-external-link-alt"></i></span>由 <span class="exturl" data-url="aHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnLw==">ECMA<i class="fa fa-external-link-alt"></i></span> 发布。该规格书也是质量奇差。它难以阅读也难以理解。它也对拙劣书籍的问题作出了自己的一份“贡献”，因为作者无法使用这个标准文档来增加他们对语言的认识。 ECMA 和 TC 39委员会应该为此感到深深的羞愧。</p>
<h2 id="业余爱好者"><a href="#业余爱好者" class="headerlink" title="业余爱好者"></a>业余爱好者</h2><p>大部分写 JavaScript 的人都不是程序员。他们缺乏训练写好程序的修养。 JavaScript 有如此丰富的表达能力，他们可以任意用它来写代码，以任何形式。这给 JavaScript 带来了一个名声──它是专门为外行设计的，不适合专业的程序员。这显然不是事实。</p>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><p>JavaScript 是不是面向对象的？它拥有对象，可以包含数据和处理数据的方法。对象可以包含其它对象。它没有类，但它却有构造器可以做类能做的事，包括扮演类变量和方法的容器的角色。它没有基于类的继承，但它有基于原型的继承。</p>
<p>两个建立对象系统的方法是通过继承 (is-a) 和通过聚合 (has-a)。 JavaScript 两个都有，但它的动态性质让它可以在聚合上超越。</p>
<p>一些批评说 JavaScript 不是真正面向对象的因为它不能提供信息的隐藏。也就是，对象不能有私有变量和私有方法：所有的成员都是公共的。</p>
<p>但 <span class="exturl" data-url="aHR0cDovL3d3dy5jcm9ja2ZvcmQuY29tL2phdmFzY3JpcHQvcHJpdmF0ZS5odG1s">Private Members in JavaScript<i class="fa fa-external-link-alt"></i></span> 又证明了 JavaScript 对象可以拥有私有变量和私有方法。当然，极少有人认识到，因为 JavaScript 是世界是最受误解的语言嘛！</p>
<p>另外还有批评说 JavaScript 不能提供继承，但 <span class="exturl" data-url="aHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9pbmhlcml0YW5jZS5odG1s">Classical Inheritance in JavaScript<i class="fa fa-external-link-alt"></i></span> 却证明了 JavaScript 不仅能支持传统的继承还能应用其它的代码复用模式。</p>
<p>原文链接： <span class="exturl" data-url="aHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9qYXZhc2NyaXB0Lmh0bWw=">JavaScript: The World’s Most Misunderstood Programming Language<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>Javascript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Debian 8 下配置 exim4 使 PHP 可以用 sendmail 发送邮件</title>
    <url>/2016/11/26/php-sendmail-on-debian-8/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>e-mail 系统共有三个主要的组成功能。首先是 Mail User Agent (MUA)，这是用户发送和读取邮件的程序。然后是 Mail Transfer Agent (MTA)，用来将邮件从一台计算机传递到另一台。最后是 Mail Delivery Agent (MDA)，用于将收到的邮件投递到用户的收件箱。</p>
<p>这三项功能可以由不同的程序执行，但也能合并到一个或两个程序里。还可以用不同的程序处理不同类型的邮件。</p>
<p>在 Linux 和 Unix 系统上 mutt 是历史悠久的常用 MUA。像其他传统的 Linux 程序一样，是基于纯文本的。它常与作为 MTA 的 exim 或 sendmail、作为 MDA 的 procmail 一起使用。</p>
<p>Debian 8 默认会安装 exim4 和 mutt 软件包。 exim4 组合了 MTA&#x2F;MDA 功能并相对小巧和灵活。它默认配置为只处理系统本地的 e-mail 。</p>
<span id="more"></span>

<h2 id="Sept-1-配置-Exim4-MTA"><a href="#Sept-1-配置-Exim4-MTA" class="headerlink" title="Sept 1 - 配置 Exim4 MTA"></a>Sept 1 - 配置 Exim4 MTA</h2><p>要让系统处理外部 e-mail，需要重新配置 exim4 软件包。</p>
<pre><code># dpkg-reconfigure exim4-config
</code></pre>
<blockquote>
<p>输入命令之后(作为 root)，您会被问到是否需要将配置文件分成几个小文件。如果您拿不准，就选择默认选项。</p>
<p>接着您将看到几个常见的邮件方案，请选择一个最近似您需求的那个。</p>
<ul>
<li>internet site</li>
</ul>
<p>您的系统被连接到网络上，并且您通过 SMTP 直接收发邮件。在接下来的几页中，程序会询问您一些基本问题，如：您的机器的邮件名称、您接受或转发邮件的域等等。</p>
<ul>
<li>mail sent by smarthost</li>
</ul>
<p>本方案中您的送出邮件转发到另一台机器，称为 “smarthost”，它来负责发送信息到最终目的地。smarthost 一般还用于保存您的计算机接收的邮件，所以您不需要长时间在线。这也意味着您需要使用类似 fetchmail 这样的程序从 smarthost 下载邮件。</p>
<p>大多时候 smarthost 是您 ISP 的邮件服务器，这对拨号用户非常适合。它也可以是公司的邮件服务器，或是您自己网络中的另外一台机器。</p>
<ul>
<li>mail sent by smarthost; no local mail</li>
</ul>
<p>该选项基本上与前一种情况相同，只有一点不同，本系统不再架设用于处理本地的 e-mail domain。在本系统上的邮件(比如，给系统管理员的)还是会被处理。</p>
<ul>
<li>local delivery only</li>
</ul>
<p>本选项是系统默认的配置。</p>
<ul>
<li>no configuration at this time</li>
</ul>
<p>除非您真的知道这是在干什么，否则请不要选择这一选项。这会留下一个未配置的邮件系统 — 在您再次配置它之前，您都无法收发任何邮件，并且可能会错过一些系统工具发来的重要信息。</p>
<p>如果没有合适的方案，或者需要更精确的设置，您需要在安装完成之后编辑 &#x2F;etc&#x2F;exim4 目录下的配置文件。有关 exim4 更多的信息可以在 &#x2F;usr&#x2F;share&#x2F;doc&#x2F;exim4 下找到；README.Debian.gz 里面有 exim4 配置方面的细节，并说明从哪里找到更多的文档。</p>
<p>注意，如果您没有正式的域名，直接发送邮件到互联网，因为接收服务器的反垃圾邮件策略会拒绝接收邮件。这时建议使用 ISP 的邮件服务器。假如您还想直接发送邮件，可能要用另一个邮件地址替换默认生成的那个。如果您使用的是 exim4 作为 MTA，可以添加一个条目到 &#x2F;etc&#x2F;email-addresses。</p>
</blockquote>
<p>输入命令之后，我们选择 <code>internet site</code> ，然后按提示输入域名等相关信息。</p>
<h2 id="Step-2-配置-php-ini"><a href="#Step-2-配置-php-ini" class="headerlink" title="Step 2 - 配置 php.ini"></a>Step 2 - 配置 php.ini</h2><p>编辑 php.ini ，在其中找到 sendmail_path 选项，如果 sendmail_path 为 sendmail_path &#x3D; &#x2F;usr&#x2F;sbin&#x2F;sendmail -t -i 即无需修改，若 sendmail_path 为注释状态，则去掉 sendmail_path 前面的“ ; ”并附上 &#x2F;usr&#x2F;sbin&#x2F;sendmail -t -i ，最终会是这样的：</p>
<pre><code>sendmail_path = /usr/sbin/sendmail -t -i
</code></pre>
<p>最后，重启 Apache 或 PHP-FPM 即可。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>Linux</tag>
        <tag>email</tag>
      </tags>
  </entry>
  <entry>
    <title>【怪事】在 Arch on Windows Subsystem 里运行 hexo g 生成的部分博客的日期早了一天</title>
    <url>/2016/12/13/hexo-blog-strange-things-on-archlinux-on-windows-subsystem/</url>
    <content><![CDATA[<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>今天突然发现一件怪事，我博客的一篇文章的地址变了，原本是</p>
<pre><code>https://naturalwill.github.io/2016/02/24/Modify-wine-default-webbrowser-in-archlinux/
</code></pre>
<p>却突然变成了</p>
<pre><code>https://naturalwill.github.io/2016/02/23/Modify-wine-default-webbrowser-in-archlinux/
</code></pre>
<p>日期部分早了一天。</p>
<p>回想最近做了什么，唯一与这博客有关的事情就是我在 archlinux as the WSL (Windows Subsystem for Linux) 里生成了一次博客。</p>
<p>打开 alwsl 重新生成一次，发现，果然如此。</p>
<span id="more"></span>

<p>这是我的博客文件列表：</p>
<pre><code>jier@DESKTOP-BI1IICL ~/repo/hexo-blog (git)-[master] % ls source/_posts
2015-12-16-Start-VirtualBox-Machine-With-Login-In-Windows.md
2015-12-23-PHP-Convert-between-JSON-and-XML.md
2015-12-30-Simple-Healthcare-Consulting-System-API.md
2016-02-24-Modify-wine-default-webbrowser-in-archlinux.md
2016-07-03-compress-and-extract-files-on-linux.md
2016-07-07-Secure-LNMP-on-Ubuntu-14-04.md
2016-08-24-Create-Facade-on-Laravel-5-2.md
2016-11-26-JavaScript-the-world-s-most-misunderstood-programming-language.md
2016-11-26-php-sendmail-on-debian-8.md
</code></pre>
<p>在 alwsl 里运行 <code>hexo g</code> :</p>
<pre><code>jier@DESKTOP-BI1IICL ~/repo/hexo-blog (git)-[master] % hexo g
INFO  Start processing
INFO  Files loaded in 2.68 s
INFO  Generated: index.html
INFO  Generated: 2016/11/26/php-sendmail-on-debian-8/index.html
INFO  Generated: 2015/12/15/Start-VirtualBox-Machine-With-Login-In-Windows/index.html
INFO  Generated: 2016/07/06/Secure-LNMP-on-Ubuntu-14-04/index.html
INFO  Generated: 2016/11/26/JavaScript-the-world-s-most-misunderstood-programming-language/index.html
INFO  Generated: 2016/02/23/Modify-wine-default-webbrowser-in-archlinux/index.html
INFO  Generated: 2016/08/23/Create-Facade-on-Laravel-5-2/index.html
INFO  Generated: 2016/07/02/compress-and-extract-files-on-linux/index.html
INFO  Generated: 2015/12/29/Simple-Healthcare-Consulting-System-API/index.html
INFO  Generated: 2015/12/22/PHP-Convert-between-JSON-and-XML/index.html
INFO  10 files generated in 27 s
hexo g  9.19s user 30.41s system 56% cpu 1:10.66 total
</code></pre>
<p>在 ArchLinux 里运行 <code>hexo g</code> :</p>
<pre><code>jier@zarch ~/hexo-blog (git)-[master] % hexo g
INFO  Start processing
INFO  Files loaded in 1.55 s
INFO  Generated: 2016/11/26/php-sendmail-on-debian-8/index.html
INFO  Generated: 2016/11/26/JavaScript-the-world-s-most-misunderstood-programming-language/index.html
INFO  Generated: 2016/08/24/Create-Facade-on-Laravel-5-2/index.html
INFO  Generated: 2016/07/07/Secure-LNMP-on-Ubuntu-14-04/index.html
INFO  Generated: 2016/07/03/compress-and-extract-files-on-linux/index.html
INFO  Generated: 2016/02/24/Modify-wine-default-webbrowser-in-archlinux/index.html
INFO  Generated: 2015/12/30/Simple-Healthcare-Consulting-System-API/index.html
INFO  Generated: 2015/12/23/PHP-Convert-between-JSON-and-XML/index.html
INFO  Generated: 2015/12/16/Start-VirtualBox-Machine-With-Login-In-Windows/index.html
INFO  Generated: index.html
INFO  10 files generated in 2.34 s
</code></pre>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>寻找中。。。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>WSL</tag>
        <tag>issue</tag>
      </tags>
  </entry>
  <entry>
    <title>在 WPF 中获取窗体或控件句柄</title>
    <url>/2016/12/16/get-handle-in-WPF/</url>
    <content><![CDATA[<p>引入命名空间：</p>
<pre><code>using System.Windows.Interop;
</code></pre>
<p>窗体： </p>
<pre><code>IntPtr hwnd = new WindowInteropHelper(this).Handle;
</code></pre>
<p>控件： </p>
<pre><code>IntPtr hwnd = ((HwndSource)PresentationSource.FromVisual(uielement)).Handle;
</code></pre>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>.Net</tag>
        <tag>WPF</tag>
      </tags>
  </entry>
  <entry>
    <title>JS实现数字雨效果</title>
    <url>/2017/01/03/digital-rain-in-JavaScript/</url>
    <content><![CDATA[<p>JavaScript + Canvas 实现数字雨效果。</p>
<div id="display_background" style="display: block;  z-index: 1001;">
    <canvas id="my_canvas" style="height: 400px; width: 600px;" ></canvas>
</div>
<script type="text/javascript">
    var c = document.getElementById("my_canvas");
    var ctx = c.getContext("2d");

<pre><code>c.height = window.innerHeight;
c.width = window.innerWidth;

var txts = &quot;01&quot;;
txts = txts.split(&quot;&quot;);

var font_size = 16;
var columns = c.width/font_size;
var drops = [];
for(var x = 0; x &lt; columns; x++) &#123;
    drops[x] = 1;
&#125;

function draw()
&#123;
    ctx.fillStyle = &quot;rgba(0, 0, 0, 0.05)&quot;;
    ctx.fillRect(0, 0, c.width, c.height);

    ctx.fillStyle = &quot;#0F0&quot;; //green text
    ctx.font = font_size + &quot;px arial&quot;;
    for(var i = 0; i &lt; drops.length; i++)
    &#123;
        var text = txts[Math.floor(Math.random()*txts.length)];
        ctx.fillText(text, i*font_size, drops[i]*font_size);
        if(drops[i]*font_size &gt; c.height || Math.random() &gt; 0.95)
            drops[i] = 0;

        drops[i]++;
    &#125;
&#125;
setInterval(draw, 33);
</code></pre>
<p></script></p>
<p>源码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;display_background&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: block;  z-index: 1001;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;my_canvas&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 400px; width: 600px;&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> c = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;my_canvas&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> ctx = c.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">height</span> = <span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">width</span> = <span class="variable language_">window</span>.<span class="property">innerWidth</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> txts = <span class="string">&quot;01&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    txts = txts.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> font_size = <span class="number">16</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> columns = c.<span class="property">width</span>/font_size;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> drops = [];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; columns; x++) &#123;</span></span><br><span class="line"><span class="language-javascript">        drops[x] = <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">draw</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">        ctx.<span class="property">fillStyle</span> = <span class="string">&quot;rgba(0, 0, 0, 0.05)&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, c.<span class="property">width</span>, c.<span class="property">height</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        ctx.<span class="property">fillStyle</span> = <span class="string">&quot;#0F0&quot;</span>; <span class="comment">//green text</span></span></span><br><span class="line"><span class="language-javascript">        ctx.<span class="property">font</span> = font_size + <span class="string">&quot;px arial&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; drops.<span class="property">length</span>; i++)</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> text = txts[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*txts.<span class="property">length</span>)];</span></span><br><span class="line"><span class="language-javascript">            ctx.<span class="title function_">fillText</span>(text, i*font_size, drops[i]*font_size);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(drops[i]*font_size &gt; c.<span class="property">height</span> || <span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.95</span>)</span></span><br><span class="line"><span class="language-javascript">                drops[i] = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            drops[i]++;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setInterval</span>(draw, <span class="number">33</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>400-编程</category>
        <category>Javascript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>在 WPF Image 控件中显示 Bitmap 数据</title>
    <url>/2017/03/05/display-bitmap-in-a-wpf-image/</url>
    <content><![CDATA[<h2 id="方案一：-使用-MemoryStream"><a href="#方案一：-使用-MemoryStream" class="headerlink" title="方案一： 使用 MemoryStream"></a>方案一： 使用 MemoryStream</h2><p>先将 Bitmap 储存成 MemoryStream ，然后指定给 BitmapImage 。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateImageByMemoryStream</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (MemoryStream memory = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> w = <span class="number">0</span>, h = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        MyDll.GetBitmapSize(<span class="keyword">ref</span> w, <span class="keyword">ref</span> h);</span><br><span class="line">        System.Drawing.Bitmap bitmap;</span><br><span class="line"></span><br><span class="line">        bitmap = <span class="keyword">new</span> System.Drawing.Bitmap(w, h, System.Drawing.Imaging.PixelFormat.Format32bppArgb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.Drawing.Rectangle rect = <span class="keyword">new</span> System.Drawing.Rectangle(<span class="number">0</span>, <span class="number">0</span>, bitmap.Width, bitmap.Height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.Drawing.Imaging.BitmapData bmpData =</span><br><span class="line">            bitmap.LockBits(rect, System.Drawing.Imaging.ImageLockMode.ReadWrite, bitmap.PixelFormat);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the address of the first line.</span></span><br><span class="line">            IntPtr ptr = bmpData.Scan0;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> status = MyDll.GetBitmapData(ptr) &gt;= <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Unlock the bits.</span></span><br><span class="line">            bitmap.UnlockBits(bmpData);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status)</span><br><span class="line">            &#123;</span><br><span class="line">    bitmap.Save(memory, System.Drawing.Imaging.ImageFormat.Bmp);</span><br><span class="line">                UpdateUI(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    memory.Position = <span class="number">0</span>;</span><br><span class="line">                    BitmapImage bitmapimage = <span class="keyword">new</span> BitmapImage();</span><br><span class="line">                    bitmapimage.BeginInit();</span><br><span class="line">                    bitmapimage.StreamSource = memory;</span><br><span class="line">                    bitmapimage.CacheOption = BitmapCacheOption.OnLoad;</span><br><span class="line">                    bitmapimage.EndInit();</span><br><span class="line"></span><br><span class="line">                    imgPreview.Source = bitmapimage;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="方案二：-调用-Imaging-CreateBitmapSourceFromHBitmap"><a href="#方案二：-调用-Imaging-CreateBitmapSourceFromHBitmap" class="headerlink" title="方案二： 调用 Imaging.CreateBitmapSourceFromHBitmap"></a>方案二： 调用 Imaging.CreateBitmapSourceFromHBitmap</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateImageByBitmap</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> w = <span class="number">0</span>, h = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    MyDll.GetBitmapSize(<span class="keyword">ref</span> w, <span class="keyword">ref</span> h);</span><br><span class="line">    <span class="keyword">var</span> bitmap = <span class="keyword">new</span> System.Drawing.Bitmap(w, h, System.Drawing.Imaging.PixelFormat.Format32bppArgb);</span><br><span class="line"></span><br><span class="line">    System.Drawing.Rectangle rect = <span class="keyword">new</span> System.Drawing.Rectangle(<span class="number">0</span>, <span class="number">0</span>, bitmap.Width, bitmap.Height);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        System.Drawing.Imaging.BitmapData bmpData =</span><br><span class="line">            bitmap.LockBits(rect, System.Drawing.Imaging.ImageLockMode.ReadWrite, bitmap.PixelFormat);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the address of the first line.</span></span><br><span class="line">        IntPtr ptr = bmpData.Scan0;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> status = MyDll.GetBitmapData(ptr) &gt;= <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Unlock the bits.</span></span><br><span class="line">        bitmap.UnlockBits(bmpData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status)</span><br><span class="line">            UpdateUI(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                imgPreview.Source = BitmapHelper.BitmapToBitmapSource(bitmap);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BitmapHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;gdi32.dll&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">DeleteObject</span>(<span class="params">IntPtr hObject</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapSource <span class="title">BitmapToBitmapSource</span>(<span class="params">System.Drawing.Bitmap bitmap</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IntPtr ptr = bitmap.GetHbitmap();</span><br><span class="line">        BitmapSource result = Imaging.CreateBitmapSourceFromHBitmap(</span><br><span class="line">            ptr, IntPtr.Zero, Int32Rect.Empty, </span><br><span class="line">            BitmapSizeOptions.FromEmptyOptions());</span><br><span class="line">        <span class="comment">//release resource</span></span><br><span class="line">        DeleteObject(ptr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="方案三：-使用-WriteableBitmap"><a href="#方案三：-使用-WriteableBitmap" class="headerlink" title="方案三： 使用 WriteableBitmap"></a>方案三： 使用 WriteableBitmap</h2><p>注：这个方法会长时间占用 UI 线程。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateImageByWriteBitmap</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> w = <span class="number">0</span>, h = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    MyDll.GetBitmapSize(<span class="keyword">ref</span> w, <span class="keyword">ref</span> h);</span><br><span class="line">    <span class="keyword">var</span> rect = <span class="keyword">new</span> System.Windows.Int32Rect(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line"></span><br><span class="line">    UpdateUI(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        imgPreview.Source =</span><br><span class="line">            writeBitmap = <span class="keyword">new</span> WriteableBitmap(rect.Width, rect.Height, <span class="number">96</span>, <span class="number">96</span>, PixelFormats.Bgra32, <span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateUI(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            writeBitmap.Lock();</span><br><span class="line">            <span class="keyword">if</span> (MyDll.GetBitmapData(writeBitmap.BackBuffer) &gt;= <span class="number">0</span>)</span><br><span class="line">                writeBitmap.AddDirtyRect(rect);</span><br><span class="line">            writeBitmap.Unlock();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="MainWindow-xaml-cs"><a href="#MainWindow-xaml-cs" class="headerlink" title="MainWindow.xaml.cs"></a>MainWindow.xaml.cs</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Controls;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Interop;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media.Imaging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WpfDemo</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">	&#123;</span><br><span class="line">		Image imgPreview;</span><br><span class="line">		WriteableBitmap writeBitmap;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			InitializeComponent();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">UpdateUI</span>(<span class="params">Action x</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (imgPreview.Dispatcher.CheckAccess())</span><br><span class="line">			&#123;</span><br><span class="line">				x.Invoke();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				imgPreview.Dispatcher.Invoke(x);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用-DLL-获取图片数据"><a href="#调用-DLL-获取图片数据" class="headerlink" title="调用 DLL 获取图片数据"></a>调用 DLL 获取图片数据</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDll</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取图片大小</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;xxx.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">GetBitmapSize</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">int</span> width, <span class="keyword">ref</span> <span class="built_in">int</span> height</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取图片数据，返回值大于 0 代表成功</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;xxx.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">GetBitmapData</span>(<span class="params">IntPtr desFrameData</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>.Net</tag>
        <tag>WPF</tag>
        <tag>流媒体</tag>
      </tags>
  </entry>
  <entry>
    <title>【另辟蹊径】如何在 WPF 实现 MDI 窗口</title>
    <url>/2017/03/07/create-mdi-window-in-WPF/</url>
    <content><![CDATA[<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>大概三个月前，我刚刚来到公司实习，老大说我们要做一个与斗鱼主播端功能相近的视频直播软件，界面用 C# 实现，让我来负责这一块，问我该用 WinForm 还是别的来做？ &#x2F;(ㄒoㄒ)&#x2F;~~ 当时我不知道怎的就选了 WPF ，最近，我们要为程序加上预览功能，即要播放 YUV&#x2F;RGB 数据。 然而，从视频设备那里采集到了 YUV 数据后，转为 Bitmap ，然后再转为 BitmapSource ，到最终呈现出来，非常低效。</p>
<p>这几天，我们发现通过 SDL 进行渲染能有效的降低 CPU 使用率。</p>
<p>然而，坑还是有的，我把 WPF Image 对象和图片数据传给 SDL ，它却直接把整个窗体霸占了 T_T 。</p>
<p>因此，只能把整个窗体给 SDL 了。</p>
<span id="more"></span>

<h2 id="网络上的-WPF-MDI-方案"><a href="#网络上的-WPF-MDI-方案" class="headerlink" title="网络上的 WPF MDI 方案"></a>网络上的 WPF MDI 方案</h2><p>先说说我在网上找到的 MDI 方案。</p>
<h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p>用Host的方式，将一个窗体的句柄设置为另一窗体的子窗体 （调用 SetParent API），大概是这样子的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Input;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Interop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WpfMdiDemo</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> MainWindow.xaml 的交互逻辑</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">	&#123;</span><br><span class="line">		[<span class="meta">DllImport(<span class="string">&quot;user32.dll&quot;</span>, EntryPoint = <span class="string">&quot;SetParent&quot;</span>)</span>]</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">SetParent</span>(<span class="params">IntPtr childPtr, IntPtr parentPtr</span>)</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			InitializeComponent();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> ChildWindow c;</span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MainWindow_OnLoaded</span>(<span class="params"><span class="built_in">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			c = <span class="keyword">new</span> ChildWindow&#123; Owner = <span class="keyword">this</span> &#125;;</span><br><span class="line">			c.Show();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 将一个窗体的句柄设置为另一窗体的子窗体，这句一定得在 Window.Show() 之后，不然不会有效</span></span><br><span class="line">			WindowInteropHelper parentHelper = <span class="keyword">new</span> WindowInteropHelper(<span class="keyword">this</span>);</span><br><span class="line">			WindowInteropHelper childHelper = <span class="keyword">new</span> WindowInteropHelper(c);</span><br><span class="line">			SetParent(childHelper.Handle, parentHelper.Handle);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcWluZzIwMDUvYXJ0aWNsZS9kZXRhaWxzLzY1MjM3MjE=">WPF实现MDI窗口，并解决花屏问题<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p>这是一个开源的 WPF MDI 解决方案。 <span class="exturl" data-url="aHR0cDovL3dwZm1kaS5jb2RlcGxleC5jb20v">WPF Multiple Document Interface (MDI)<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="我的解决方案"><a href="#我的解决方案" class="headerlink" title="我的解决方案"></a>我的解决方案</h2><p>方案二虽然据说很好的实现了 WPF MDI ，但是它的 MDI 实际上还是通过控件的形式实现的，传递给 SDL 的话， SDL 还是会把我的 MainWindow 吃掉，并不符合我的需求。</p>
<p>So, 我只能基于方案一打造我的 MDI 了。</p>
<h3 id="方案一中遇到的问题"><a href="#方案一中遇到的问题" class="headerlink" title="方案一中遇到的问题"></a>方案一中遇到的问题</h3><ul>
<li>调用 SetParent 后，子窗体的外观会变得像 WinForm 窗体而与主窗体风格迥异</li>
<li>调用 SetParent 后，子窗体会闪烁一下，再出现在父窗体中。</li>
</ul>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ol>
<li><p>隐藏窗口标题栏、边框，隐藏任务栏图标，禁止手动调整大小：</p>
<p> WindowStyle&#x3D;”None” ShowInTaskbar&#x3D;”False” ResizeMode&#x3D;”NoResize” </p>
</li>
<li><p>预先设置好子窗体的位置，先将宽高设置为 1 ，待调用 SetParent 后，还原宽高：</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// c 为 ChildWindow </span></span><br><span class="line"><span class="comment">// gPreview 是父窗体中的一控件， c 的初始位置根据 gPreview 定位</span></span><br><span class="line"><span class="comment">// w, h 是 c 的实际宽高</span></span><br><span class="line">Window window = Window.GetWindow(gPreview);</span><br><span class="line"><span class="keyword">var</span> point = gPreview.TransformToAncestor(window).Transform(<span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">c.Left = point.X + (gPreview.ActualWidth - w) / <span class="number">2</span>;</span><br><span class="line">c.Top = point.Y + (gPreview.ActualHeight - h) / <span class="number">2</span>;</span><br><span class="line">c.Width = <span class="number">1</span>;</span><br><span class="line">c.Height = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">c.Show();</span><br><span class="line"></span><br><span class="line">WindowInteropHelper parentHelper = <span class="keyword">new</span> WindowInteropHelper(_main);</span><br><span class="line">WindowInteropHelper childHelper = <span class="keyword">new</span> WindowInteropHelper(c);</span><br><span class="line">SetParent(childHelper.Handle, parentHelper.Handle);</span><br><span class="line"></span><br><span class="line">c.Width = w;</span><br><span class="line">c.Height = h;</span><br></pre></td></tr></table></figure>

<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>如果需要让窗口的显示标题栏及边框，可以通过在主窗体增加仿标题及边框的控件，然后子窗体根据该控件调整位置与大小即可。</p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>.Net</tag>
        <tag>WPF</tag>
      </tags>
  </entry>
  <entry>
    <title>在 WPF 中调用 SDL2 播放 RGB/YUV</title>
    <url>/2017/03/07/display-RGB-or-YUV-by-SDL2-in-WPF/</url>
    <content><![CDATA[<h2 id="SDL简介"><a href="#SDL简介" class="headerlink" title="SDL简介"></a>SDL简介</h2><p>SDL（Simple DirectMedia Layer）是一套开放源代码的跨平台多媒体开发库，使用C语言写成。SDL提供了数种控制图像、声音、输出入的函数，让开发者只要用相同或是相似的代码就可以开发出跨多个平台（Linux、Windows、Mac OS X等）的应用软件。目前SDL多用于开发游戏、模拟器、媒体播放器等多媒体应用领域。</p>
<span id="more"></span>

<h2 id="SDL播放视频的流程"><a href="#SDL播放视频的流程" class="headerlink" title="SDL播放视频的流程"></a>SDL播放视频的流程</h2><ul>
<li>初始化<ul>
<li>初始化SDL</li>
<li>创建窗口（Window）</li>
<li>基于窗口创建渲染器（Render）</li>
<li>创建纹理（Texture）</li>
</ul>
</li>
<li>循环显示画面<ul>
<li>设置纹理的数据</li>
<li>纹理复制给渲染目标</li>
<li>显示</li>
</ul>
</li>
</ul>
<h2 id="C-语言部分"><a href="#C-语言部分" class="headerlink" title="C 语言部分"></a>C 语言部分</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// libMyPlayer.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXPORT_API __declspec(dllexport)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sdl/SDL.h&quot;</span></span></span><br><span class="line">    FILE __iob_func[<span class="number">3</span>] = &#123; *<span class="built_in">stdin</span>,*<span class="built_in">stdout</span>,*<span class="built_in">stderr</span> &#125;;  <span class="comment">// 使用 VS2015 编译时，需加入这一句</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    EXPORT_API <span class="type">int</span> <span class="title function_">SdlSetWin</span><span class="params">(HWND handler, <span class="type">int</span> win_w, <span class="type">int</span> win_h)</span>;</span><br><span class="line">    EXPORT_API <span class="type">int</span> <span class="title function_">SdlInit</span><span class="params">(<span class="type">int</span> pix_w, <span class="type">int</span> pix_h)</span>;</span><br><span class="line">    EXPORT_API <span class="type">int</span> <span class="title function_">SdlRender</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* buffer)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>注意：<br>使用 VS2015 编译时，需加入 <code>extern &quot;C&quot; FILE __iob_func[3] = &#123; *stdin,*stdout,*stderr &#125;;</code> 这一句，同时在 <code>链接器-&gt;附加依赖项</code> 里加入 <code>legacy_stdio_definitions.lib</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// libMyPlayer.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libMyPlayer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//set &#x27;1&#x27; to choose a type of file to play</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_BGRA    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_RGB24   0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_BGR24   0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_YUV420P 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Bit per Pixel</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LOAD_BGRA</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> bpp = <span class="number">32</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_RGB24|LOAD_BGR24</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> bpp = <span class="number">24</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_YUV420P</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> bpp = <span class="number">12</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> screen_w = <span class="number">500</span>, screen_h = <span class="number">500</span>;</span><br><span class="line"><span class="type">int</span> pixel_w = <span class="number">320</span>, pixel_h = <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> * buffer = new <span class="type">unsigned</span> <span class="type">char</span>[pixel_w*pixel_h*bpp / <span class="number">8</span>];</span><br><span class="line"><span class="comment">//BPP=32</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> * buffer_convert = new <span class="type">unsigned</span> <span class="type">char</span>[pixel_w*pixel_h * <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//Convert RGB24/BGR24 to RGB32/BGR32</span></span><br><span class="line"><span class="comment">//And change Endian if needed</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CONVERT_24to32</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *image_in, <span class="type">unsigned</span> <span class="type">char</span> *image_out, <span class="type">int</span> w, <span class="type">int</span> h)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i &lt; h;i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>;j &lt; w;j++) &#123;</span><br><span class="line">            <span class="comment">//Big Endian or Small Endian?</span></span><br><span class="line">            <span class="comment">//&quot;ARGB&quot; order:high bit -&gt; low bit.</span></span><br><span class="line">            <span class="comment">//ARGB Format Big Endian (low address save high MSB, here is A) in memory : A|R|G|B</span></span><br><span class="line">            <span class="comment">//ARGB Format Little Endian (low address save low MSB, here is B) in memory : B|G|R|A</span></span><br><span class="line">            <span class="keyword">if</span> (SDL_BYTEORDER == SDL_LIL_ENDIAN) &#123;</span><br><span class="line">                <span class="comment">//Little Endian (x86): R|G|B --&gt; B|G|R|A</span></span><br><span class="line">                image_out[(i*w + j) * <span class="number">4</span> + <span class="number">0</span>] = image_in[(i*w + j) * <span class="number">3</span> + <span class="number">2</span>];</span><br><span class="line">                image_out[(i*w + j) * <span class="number">4</span> + <span class="number">1</span>] = image_in[(i*w + j) * <span class="number">3</span> + <span class="number">1</span>];</span><br><span class="line">                image_out[(i*w + j) * <span class="number">4</span> + <span class="number">2</span>] = image_in[(i*w + j) * <span class="number">3</span>];</span><br><span class="line">                image_out[(i*w + j) * <span class="number">4</span> + <span class="number">3</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//Big Endian: R|G|B --&gt; A|R|G|B</span></span><br><span class="line">                image_out[(i*w + j) * <span class="number">4</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="built_in">memcpy</span>(image_out + (i*w + j) * <span class="number">4</span> + <span class="number">1</span>, image_in + (i*w + j) * <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Refresh Event</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REFRESH_EVENT  (SDL_USEREVENT + 1)</span></span><br><span class="line"><span class="comment">//Break</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BREAK_EVENT  (SDL_USEREVENT + 2)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> thread_exit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">refresh_video</span><span class="params">(<span class="type">void</span> *opaque)</span> &#123;</span><br><span class="line">    thread_exit = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!thread_exit) &#123;</span><br><span class="line">        SDL_Event event;</span><br><span class="line">        event.type = REFRESH_EVENT;</span><br><span class="line">        SDL_PushEvent(&amp;event);</span><br><span class="line">        SDL_Delay(<span class="number">40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    thread_exit = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//Break</span></span><br><span class="line">    SDL_Event event;</span><br><span class="line">    event.type = BREAK_EVENT;</span><br><span class="line">    SDL_PushEvent(&amp;event);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SDL_Window* screen;</span><br><span class="line">SDL_Renderer* sdlRenderer;</span><br><span class="line">SDL_Texture* sdlTexture;</span><br><span class="line"></span><br><span class="line">SDL_Rect sdlRect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SDL_Event event;</span><br><span class="line">HWND winhandler;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">SdlSetWin</span><span class="params">(HWND handler, <span class="type">const</span> <span class="type">int</span> win_w, <span class="type">const</span> <span class="type">int</span> win_h)</span></span><br><span class="line">&#123;</span><br><span class="line">    winhandler = handler;</span><br><span class="line">    screen_w = win_w;</span><br><span class="line">    screen_h = win_h;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">SdlInit</span><span class="params">(<span class="type">const</span> <span class="type">int</span> pix_w, <span class="type">const</span> <span class="type">int</span> pix_h)</span></span><br><span class="line">&#123;</span><br><span class="line">    pixel_w = pix_w;</span><br><span class="line">    pixel_h = pix_h;</span><br><span class="line"></span><br><span class="line">    buffer = new <span class="type">unsigned</span> <span class="type">char</span>[pixel_w*pixel_h*bpp / <span class="number">8</span>];</span><br><span class="line">    buffer_convert = new <span class="type">unsigned</span> <span class="type">char</span>[pixel_w*pixel_h * <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SDL_Init(SDL_INIT_VIDEO)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not initialize SDL - %s\n&quot;</span>, SDL_GetError());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SDL 2.0 Support for multiple windows</span></span><br><span class="line">    <span class="comment">//screen = SDL_CreateWindow(&quot;Simplest Video Play SDL2&quot;, SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED,</span></span><br><span class="line">    <span class="comment">//  screen_w, screen_h, SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE);</span></span><br><span class="line">    screen = SDL_CreateWindowFrom(winhandler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!screen) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDL: could not create window - exiting:%s\n&quot;</span>, SDL_GetError());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sdlRenderer = SDL_CreateRenderer(screen, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    Uint32 pixformat = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LOAD_BGRA</span></span><br><span class="line">    <span class="comment">//Note: ARGB8888 in &quot;Little Endian&quot; system stores as B|G|R|A</span></span><br><span class="line">    pixformat = SDL_PIXELFORMAT_ARGB8888;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_RGB24</span></span><br><span class="line">    pixformat = SDL_PIXELFORMAT_RGB888;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_BGR24</span></span><br><span class="line">    pixformat = SDL_PIXELFORMAT_BGR888;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_YUV420P</span></span><br><span class="line">    <span class="comment">//IYUV: Y + U + V  (3 planes)</span></span><br><span class="line">    <span class="comment">//YV12: Y + V + U  (3 planes)</span></span><br><span class="line">    pixformat = SDL_PIXELFORMAT_IYUV;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    sdlTexture = SDL_CreateTexture(sdlRenderer, pixformat, SDL_TEXTUREACCESS_STREAMING, pixel_w, pixel_h);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">SdlRender</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* buffer)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LOAD_BGRA</span></span><br><span class="line">    <span class="comment">//We don&#x27;t need to change Endian</span></span><br><span class="line">    <span class="comment">//Because input BGRA pixel data(B|G|R|A) is same as ARGB8888 in Little Endian (B|G|R|A)</span></span><br><span class="line">    SDL_UpdateTexture(sdlTexture, <span class="literal">NULL</span>, buffer, pixel_w * <span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_RGB24|LOAD_BGR24</span></span><br><span class="line">    <span class="comment">//change 24bit to 32 bit</span></span><br><span class="line">    <span class="comment">//and in Windows we need to change Endian</span></span><br><span class="line">    CONVERT_24to32(buffer, buffer_convert, pixel_w, pixel_h);</span><br><span class="line">    SDL_UpdateTexture(sdlTexture, <span class="literal">NULL</span>, buffer_convert, pixel_w * <span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> LOAD_YUV420P</span></span><br><span class="line">    SDL_UpdateTexture(sdlTexture, <span class="literal">NULL</span>, buffer, pixel_w);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">//FIX: If window is resize</span></span><br><span class="line">    sdlRect.x = <span class="number">0</span>;</span><br><span class="line">    sdlRect.y = <span class="number">0</span>;</span><br><span class="line">    sdlRect.w = screen_w;</span><br><span class="line">    sdlRect.h = screen_h;</span><br><span class="line"></span><br><span class="line">    SDL_RenderClear(sdlRenderer);</span><br><span class="line">    SDL_RenderCopy(sdlRenderer, sdlTexture, <span class="literal">NULL</span>, &amp;sdlRect);</span><br><span class="line">    SDL_RenderPresent(sdlRenderer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="WPF-播放-RGB-例子"><a href="#WPF-播放-RGB-例子" class="headerlink" title="WPF 播放 RGB 例子"></a>WPF 播放 RGB 例子</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在 UI 线程中新建窗口，并将窗口句柄传入 DLL 中</span></span><br><span class="line"></span><br><span class="line">RunAtUI(() =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    win = <span class="keyword">new</span> MyPlayerWindow();</span><br><span class="line">    win.Show();</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> defaultDPI = <span class="number">96</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于解决启用DPI缩放导致预览区域部分黑屏的问题</span></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> graphics = System.Drawing.Graphics.FromHwnd(IntPtr.Zero))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> dpiX = graphics.DpiX;</span><br><span class="line">        <span class="built_in">float</span> dpiY = graphics.DpiY;</span><br><span class="line">        IntPtr hwnd = <span class="keyword">new</span> WindowInteropHelper(win).Handle;</span><br><span class="line">        <span class="keyword">if</span> (LibCrPlayerHelper.SdlSetWin(hwnd, (<span class="built_in">int</span>)(win.Width * dpiX / defaultDPI), (<span class="built_in">int</span>)(win.Height * dpiY / defaultDPI)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Error: SdlSetWin.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取图片大小，设置图片大小，并初始化</span></span><br><span class="line"><span class="built_in">int</span> w = <span class="number">0</span>, h = <span class="number">0</span>;</span><br><span class="line">MyDll.GetBitmapSize(<span class="keyword">ref</span> w, <span class="keyword">ref</span> h);</span><br><span class="line">bitmap = <span class="keyword">new</span> System.Drawing.Bitmap(w, h, System.Drawing.Imaging.PixelFormat.Format32bppArgb);</span><br><span class="line">rect = <span class="keyword">new</span> System.Drawing.Rectangle(<span class="number">0</span>, <span class="number">0</span>, bitmap.Width, bitmap.Height);</span><br><span class="line">LibCrPlayerHelper.SdlInit(bitmap.Width, bitmap.Height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环显示画面</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> bmpData = bitmap.LockBits(rect, System.Drawing.Imaging.ImageLockMode.ReadWrite, bitmap.PixelFormat);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the address of the first line.</span></span><br><span class="line">    IntPtr ptr = bmpData.Scan0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MyDll.GetBitmapData(ptr) &gt;= <span class="number">0</span>)</span><br><span class="line">        LibCrPlayerHelper.SdlRender(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unlock the bits.</span></span><br><span class="line">    bitmap.UnlockBits(bmpData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<br>最常见的显示分辨率为每英寸 96 点 (DPI)，但支持 120、133、170 及以上的更高分辨率的显示器也越来越常见。<br>假如用户电脑进行了 DPI 缩放，现在的显示分辨率为 120dpi ，上面代码中 DPI 缩放前（ 96dpi ）的 win.Width 为 640px ，缩放后（ 120dpi ）的 win.Width 所取得的值依然是 640px ，然而 win.Width 在 DPI 缩放后实际大小已经变为了 800px (640*120&#x2F;96) ，所以若直接把 win.Width 传递给 SDL 的话，会造成窗口只有左上角的一部分被渲染的问题。</p>
<h2 id="MainWindow-xaml-cs"><a href="#MainWindow-xaml-cs" class="headerlink" title="MainWindow.xaml.cs"></a>MainWindow.xaml.cs</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Controls;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Interop;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media.Imaging;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WpfDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Window win;</span><br><span class="line">        <span class="keyword">private</span> System.Drawing.Bitmap bitmap;</span><br><span class="line">        <span class="keyword">private</span> System.Drawing.Rectangle rect;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            InitializeComponent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RunAtUI</span>(<span class="params">Action x</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (imgPreview.Dispatcher.CheckAccess())</span><br><span class="line">            &#123;</span><br><span class="line">                x.Invoke();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                imgPreview.Dispatcher.Invoke(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LibMyPlayerHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置窗口句柄，窗口大小</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;libMyPlayer.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">SdlSetWin</span>(<span class="params">IntPtr handler, <span class="built_in">int</span> win_w, <span class="built_in">int</span> win_h</span>)</span>;</span><br><span class="line">    <span class="comment">// 设置图片大小，并开始初始化</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;libMyPlayer.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">SdlInit</span>(<span class="params"><span class="built_in">int</span> pix_w, <span class="built_in">int</span> pix_h</span>)</span>;</span><br><span class="line">    <span class="comment">// 传入图片数据，并开始渲染</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;libMyPlayer.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">SdlRender</span>(<span class="params">IntPtr ptr</span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDll</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取图片大小</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;xxx.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">GetBitmapSize</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">int</span> width, <span class="keyword">ref</span> <span class="built_in">int</span> height</span>)</span>;</span><br><span class="line">    <span class="comment">// 获取图片数据，返回值大于 0 代表成功</span></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;xxx.dll&quot;</span>, CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">GetBitmapData</span>(<span class="params">IntPtr desFrameData</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h2><p>如果给 SDL 传入 WPF 某个控件的句柄， SDL 也会直接渲染整个窗口。</p>
<pre><code>IntPtr hwnd = ((HwndSource)PresentationSource.FromVisual(uielement)).Handle;
if (LibCrPlayerHelper.SdlSetWin(hwnd, (int)win.Width, (int)win.Height) &lt; 0)
    throw new Exception(&quot;Error: SdlSetWin.&quot;);
</code></pre>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>.Net</tag>
        <tag>WPF</tag>
        <tag>流媒体</tag>
      </tags>
  </entry>
  <entry>
    <title>Teamtalk</title>
    <url>/2017/05/03/Teamtalk-awesome/</url>
    <content><![CDATA[<p>TeamTalk 是蘑菇街开源的一款企业办公即时通信软件，最初是为自己内部沟通而做的 IM 工具。</p>
<p>支持的平台：</p>
<ul>
<li>Windows</li>
<li>Mac</li>
<li>iOS</li>
<li>Android</li>
</ul>
<p>Gethub: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vZ3VqaWUvVGVhbVRhbGs=">https://github.com/mogujie/TeamTalk<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h2 id="TeamTalk-架构"><a href="#TeamTalk-架构" class="headerlink" title="TeamTalk 架构"></a>TeamTalk 架构</h2><p><img src="/images/teamtalk/teamtalk_arch.jpg" alt="TeamTalk Architecture" title="TeamTalk Architecture"></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><span class="exturl" data-url="aHR0cDovL3d3dy5vcGVuLW9wZW4uY29tL2xpYi92aWV3L29wZW4xNDUxNTQ5NDQwMzg2Lmh0bWw=">来自蘑菇街的开源IM：TeamTalk<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTYxMDE0MDcwMzU5L2h0dHA6Ly9ibHVlZm94YWgub3JnL3RlYW10YWxrL25ld190dF9kZXBsb3kuaHRtbA==">新版TeamTalk部署教程<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL2Nkbm5uLjA3bmV0MDEuY29tL2xpbnV4LzIwMTcvMDEvMTc5NTU2OS5odG1s">VS2015编译Teamtalk的Windows客户端<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTYxMjE5MDM1MzA2L2h0dHA6Ly9ibHVlZm94YWgub3JnL3RlYW10YWxrL2FkZF9wcm90b2NvbC5odG1s">如何新增一个处理协议<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTYxMDE0MDYxMDQ2L2h0dHA6Ly9ibHVlZm94YWgub3JnL2NhdGVnb3J5L3RlYW10YWxrLw==">蓝狐 —— 分类 TeamTalk 下的文章<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuaWJtLmNvbS9kZXZlbG9wZXJ3b3Jrcy9jbi9saW51eC9sLWNuLWdwYi8=">Google Protocol Buffer 的使用和原理<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>IM</category>
      </categories>
      <tags>
        <tag>TeamTalk</tag>
      </tags>
  </entry>
  <entry>
    <title>ffmpeg 获取摄像头、麦克风选项</title>
    <url>/2017/05/05/ffmpeg-notes/</url>
    <content><![CDATA[<p>简单记录一下 ffmpeg 获取 DirectShow 设备数据的方法。本文所述的方法主要是对应Windows平台的。（由于 ffmpeg 输出编码为 UTF-8, 所以这里使用 Git Bash ）</p>
<h2 id="列出设备"><a href="#列出设备" class="headerlink" title="列出设备"></a>列出设备</h2><pre><code>$ ./ffmpeg -list_devices true -f dshow -i dummy
ffmpeg version 3.2.4 Copyright (c) 2000-2017 the FFmpeg developers
  built with gcc 6.3.0 (GCC)
[dshow @ 00000000001c23c0] DirectShow video devices (some may be both video and audio devices)
[dshow @ 00000000001c23c0]  &quot;Integrated Webcam&quot;
[dshow @ 00000000001c23c0]     Alternative name &quot;@device_pnp_\\?\usb#vid_0c45&amp;pid_6448&amp;mi_00#7&amp;2645f9e4&amp;0&amp;0000#&#123;65e8773d-8f56-11d0-a3b9-00a0c9223196&#125;\global&quot;
[dshow @ 00000000001c23c0]  &quot;screen-capture-recorder&quot;
[dshow @ 00000000001c23c0]     Alternative name &quot;@device_sw_&#123;860BB310-5D01-11D0-BD3B-00A0C911CE86&#125;\&#123;4EA69364-2C8A-4AE6-A561-56E4B5044439&#125;&quot;
[dshow @ 00000000001c23c0] DirectShow audio devices
[dshow @ 00000000001c23c0]  &quot;麦克风 (High Definition Audio 设备)&quot;
[dshow @ 00000000001c23c0]     Alternative name &quot;@device_cm_&#123;33D9A762-90C8-11D0-BD43-00A0C911CE86&#125;\wave_&#123;E26AD2BE-B335-41EC-BED5-40F982F21FF7&#125;&quot;
[dshow @ 00000000001c23c0]  &quot;virtual-audio-capturer&quot;
[dshow @ 00000000001c23c0]     Alternative name &quot;@device_sw_&#123;33D9A762-90C8-11D0-BD43-00A0C911CE86&#125;\&#123;8E146464-DB61-4309-AFA1-3578E927E935&#125;&quot;
dummy: Immediate exit requested
</code></pre>
<h2 id="查看设备选项"><a href="#查看设备选项" class="headerlink" title="查看设备选项"></a>查看设备选项</h2><p>video</p>
<pre><code>$ ./ffmpeg -list_options true -f dshow -i video=&quot;Integrated Webcam&quot;
ffmpeg version 3.2.4 Copyright (c) 2000-2017 the FFmpeg developers
  built with gcc 6.3.0 (GCC)
[dshow @ 0000000000ea23e0] DirectShow video device options (from video devices)
[dshow @ 0000000000ea23e0]  Pin &quot;捕获&quot; (alternative pin name &quot;0&quot;)
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=640x480 fps=10 max s=640x480 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=640x480 fps=10 max s=640x480 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=352x288 fps=10 max s=352x288 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=352x288 fps=10 max s=352x288 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=320x240 fps=10 max s=320x240 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=320x240 fps=10 max s=320x240 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=176x144 fps=10 max s=176x144 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=176x144 fps=10 max s=176x144 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=160x120 fps=10 max s=160x120 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=160x120 fps=10 max s=160x120 fps=30
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=1280x720 fps=11 max s=1280x720 fps=11
[dshow @ 0000000000ea23e0]   pixel_format=yuyv422  min s=1280x720 fps=11 max s=1280x720 fps=11
[dshow @ 0000000000ea23e0]   vcodec=mjpeg  min s=1280x720 fps=10 max s=1280x720 fps=30
[dshow @ 0000000000ea23e0]   vcodec=mjpeg  min s=1280x720 fps=10 max s=1280x720 fps=30
video=Integrated Webcam: Immediate exit requested
</code></pre>
<p>audio</p>
<pre><code>$ ./ffmpeg -list_options true -f dshow -i audio=&quot;麦克风 (High Definition Audio 设备)&quot;
ffmpeg version 3.2.4 Copyright (c) 2000-2017 the FFmpeg developers
  built with gcc 6.3.0 (GCC)
[dshow @ 00000000024d24a0] DirectShow audio only device options (from audio devices)
[dshow @ 00000000024d24a0]  Pin &quot;Capture&quot; (alternative pin name &quot;Capture&quot;)
[dshow @ 00000000024d24a0]   min ch=1 bits=8 rate= 11025 max ch=2 bits=16 rate= 44100
    Last message repeated 22 times
audio=麦克风 (High Definition Audio 设备): Immediate exit requested
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Notes</category>
      </categories>
      <tags>
        <tag>Notes</tag>
        <tag>ffmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 16.04 安装PHP、MySQL、Nginx</title>
    <url>/2017/06/21/install-nginx-php-mysql-in-ubuntu-16-04/</url>
    <content><![CDATA[<h2 id="更新-apt-包"><a href="#更新-apt-包" class="headerlink" title="更新 apt 包"></a>更新 apt 包</h2><pre><code>sudo apt update
</code></pre>
<p>    </p>
<h2 id="安装-MySQL"><a href="#安装-MySQL" class="headerlink" title="安装 MySQL"></a>安装 MySQL</h2><pre><code>sudo apt install mysql-server mysql-client
</code></pre>
<h2 id="安装-PHP-7"><a href="#安装-PHP-7" class="headerlink" title="安装 PHP 7"></a>安装 PHP 7</h2><pre><code>sudo apt install php-&#123;cli,fpm&#125;
</code></pre>
<p>安装PHP插件</p>
<pre><code>sudo apt install php-&#123;mcrypt,mbstring,curl,gd,mysql,xml&#125;
</code></pre>
<h2 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h2><pre><code>sudo apt install nginx-full
</code></pre>
<p>配置Nginx, 使之支持PHP, 编辑<code>/etc/nginx/sites-enabled/default</code>, 在server段中找到以下一段并解除部分注释，使其如下：</p>
<pre><code># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
#
location ~ \.php$ &#123;
    include snippets/fastcgi-php.conf;

    # With php7.0-cgi alone:
    #fastcgi_pass 127.0.0.1:9000;
    # With php7.0-fpm:
    fastcgi_pass unix:/run/php/php7.0-fpm.sock;
&#125;
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>C# 跨线程更新 UI</title>
    <url>/2017/09/18/update-ui-when-cross-thread/</url>
    <content><![CDATA[<h2 id="Winforms-跨线程更新-UI"><a href="#Winforms-跨线程更新-UI" class="headerlink" title="Winforms 跨线程更新 UI"></a>Winforms 跨线程更新 UI</h2><p>在 Winforms 中, 所有的控件都包含 <code>InvokeRequired</code> 属性, 如果我们要更新UI，通过它我们可以判断是否需要调用 <code>[Begin]Invoke</code>.</p>
<h3 id="直接使用"><a href="#直接使用" class="headerlink" title="直接使用"></a>直接使用</h3><pre><code>delegate void SetTextCallback(string text);

public void SetText(string text)
&#123;
    if (InvokeRequired)
    &#123;
        var d = new SetTextCallback(SetText);
        this.textBox1.Invoke(d, new object[] &#123; text &#125;);
    &#125;
    else
    &#123;
        this.textBox1.Text = text;
    &#125;
&#125;
</code></pre>
<p>直接调用 <code>SetText</code> 即可。</p>
<span id="more"></span>

<h3 id="使用扩展方法"><a href="#使用扩展方法" class="headerlink" title="使用扩展方法"></a>使用扩展方法</h3><pre><code>public static class MyClass
&#123;
    public static void InvokeIfRequired(this ISynchronizeInvoke obj, MethodInvoker action)
    &#123;
        if (obj.InvokeRequired)
        &#123;
            var args = new object[0];
            obj.Invoke(action, args);
        &#125;
        else
        &#123;
            action();
        &#125;
    &#125;
&#125;
</code></pre>
<p>使用：</p>
<pre><code>this.textBox1.InvokeIfRequired(() =&gt;
&#123;
    // Do anything you want with the control here
    this.textBox1.Text = &quot;text&quot;;
&#125;);
</code></pre>
<h2 id="WPF-跨线程更新-UI"><a href="#WPF-跨线程更新-UI" class="headerlink" title="WPF 跨线程更新 UI"></a>WPF 跨线程更新 UI</h2><p>在 WPF 中，与 WinForms 中 <code>InvokeRequired</code> 属性相对应的有： <code>DispatcherObject.CheckAccess()</code> 和 <code>Dispatcher.CheckAccess()</code>.</p>
<pre><code>// Uses the Dispatcher.CheckAccess method to determine if 
// the calling thread has access to the thread the UI object is on.
private void TryToUpdateButtonCheckAccess(object uiObject)
&#123;
    Button theButton = uiObject as Button;

    if (theButton != null)
    &#123;
        // Checking if this thread has access to the object.
        if (theButton.Dispatcher.CheckAccess())
        &#123;
            // This thread has access so it can update the UI thread.
            UpdateButtonUI(theButton);
        &#125;
        else
        &#123;
            // This thread does not have access to the UI thread.
            // Place the update method on the Dispatcher of the UI thread.
            theButton.Dispatcher.BeginInvoke(DispatcherPriority.Normal,
                new UpdateUIDelegate(UpdateButtonUI), theButton);
        &#125;
    &#125;
&#125;
</code></pre>
<p>然而, <code>CheckAccess</code> 和 <code>VerifyAccess</code> 被标记为永远不在智能提示在显示，是否在暗示我们应该直接使用 <code>Dispatcher.Invoke()</code> 呢？</p>
<pre><code>//
// 摘要:
//     确定调用线程是否为与此 System.Windows.Threading.Dispatcher 关联的线程。
//
// 返回结果:
//     如果调用线程是与此 System.Windows.Threading.Dispatcher 关联的线程，则为 true；否则为 false。
[EditorBrowsable(EditorBrowsableState.Never)]
public bool CheckAccess();
</code></pre>
<p>相关链接：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTI5Mzc5MDIvY29ycmVjdC11c2FnZS1vci1ub3QtdXNhZ2Utb2YtZGlzcGF0Y2hlci1jaGVja2FjY2Vzcw=="> Correct usage (or not-usage) of Dispatcher.CheckAccess() <i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>.Net</tag>
      </tags>
  </entry>
  <entry>
    <title>为通过yum安装的Nginx添加nginx-rtmp-module</title>
    <url>/2017/09/25/add-rtmp-module-to-nginx-by-yum/</url>
    <content><![CDATA[<p>Nginx 一般都是编译安装，不过它本身也提供了通过yum安装的方式，比如在CentOS 7中需要先安装 Yum 源：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>之后就是常规的 <code>yum -y install nginx</code> 。</p>
<p>通过这一方式安装的Nginx已经可以通过系统服务的方式进行启动，相当便捷，但是很多有趣的第三方插件并没有能够加入，比如header-more-nginx-module，Nginx目前看来不像Tengine是可以后期动态添加模块的，所以解决的方案出了编译安装似乎没有其他的方式了。</p>
<p>不过Nginx编译只生成一个二进制文件，那么，如果获取yum安装的Nginx编译参数，之后使用同一版本的源代码进行编译，之后替换生成文件就可以了。</p>
<span id="more"></span>

<h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h2><pre><code>yum -y install nginx
</code></pre>
<h2 id="查看原来的-nginx-编译参数"><a href="#查看原来的-nginx-编译参数" class="headerlink" title="查看原来的 nginx 编译参数"></a>查看原来的 nginx 编译参数</h2><pre><code>nginx -V
</code></pre>
<p>输出如下：</p>
<pre><code>nginx version: nginx/1.12.2
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-16) (GCC)
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#39; --with-ld-opt=&#39;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#39; --add-module=../nginx-rtmp-module
</code></pre>
<h2 id="获取对应的-Nginx-源码"><a href="#获取对应的-Nginx-源码" class="headerlink" title="获取对应的 Nginx 源码"></a>获取对应的 Nginx 源码</h2><pre><code>wget https://nginx.org/download/nginx-1.12.2.tar.gz
</code></pre>
<p>获取nginx-rtmp-module源码：</p>
<pre><code>git clone https://github.com/arut/nginx-rtmp-module.git
cd nginx-rtmp-module
git checkout $(git describe --abbrev=0 --tags)
</code></pre>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><pre><code>yum -y install &#123;GeoIP,gd,gperftools,libxml2,libxslt,openssl,pcre,perl,zlib&#125;-devel perl-ExtUtils-Embed redhat-rpm-config
</code></pre>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>在获得的编译参数中加入 nginx-rtmp-module 源码的路径，如： <code>--add-module=../nginx-rtmp-module</code> 。然后执行 configure</p>
<pre><code>./configure --prefix=/usr/share/nginx \
    --sbin-path=/usr/sbin/nginx \
    --modules-path=/usr/lib64/nginx/modules \
    --conf-path=/etc/nginx/nginx.conf \
    --error-log-path=/var/log/nginx/error.log \
    --http-log-path=/var/log/nginx/access.log \
    --http-client-body-temp-path=/var/lib/nginx/tmp/client_body \
    --http-proxy-temp-path=/var/lib/nginx/tmp/proxy \
    --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \
    --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi \
    --http-scgi-temp-path=/var/lib/nginx/tmp/scgi \
    --pid-path=/run/nginx.pid \
    --lock-path=/run/lock/subsys/nginx \
    --user=nginx \
    --group=nginx \
    --with-file-aio \
    --with-ipv6 \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_realip_module \
    --with-http_addition_module \
    --with-http_xslt_module=dynamic \
    --with-http_image_filter_module=dynamic \
    --with-http_geoip_module=dynamic \
    --with-http_sub_module \
    --with-http_dav_module \
    --with-http_flv_module \
    --with-http_mp4_module \
    --with-http_gunzip_module \
    --with-http_gzip_static_module \
    --with-http_random_index_module \
    --with-http_secure_link_module \
    --with-http_degradation_module \
    --with-http_slice_module \
    --with-http_stub_status_module \
    --with-http_perl_module=dynamic \
    --with-mail=dynamic \
    --with-mail_ssl_module \
    --with-pcre \
    --with-pcre-jit \
    --with-stream=dynamic \
    --with-stream_ssl_module \
    --with-google_perftools_module \
    --with-debug \
    --with-cc-opt=&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#39; \
    --with-ld-opt=&#39;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#39; \
    --add-module=../nginx-rtmp-module
 
</code></pre>
<p>停止运行现在的Nginx，然后执行编译安装：</p>
<pre><code>systemctl stop nginx

make
make install
</code></pre>
<h2 id="禁止-yum-更新-nginx"><a href="#禁止-yum-更新-nginx" class="headerlink" title="禁止 yum 更新 nginx"></a>禁止 yum 更新 nginx</h2><p>修改 yum.conf :</p>
<pre><code>nano /etc/yum.conf
</code></pre>
<p>在文件中加入下面配置顶：</p>
<pre><code>exclude=nginx*
</code></pre>
<p>修改后的 yum.conf 看起来是这样的：</p>
<pre><code>[main]
cachedir=/var/cache/yum/$basearch/$releasever
keepcache=0
debuglevel=2
logfile=/var/log/yum.log
exactarch=1
obsoletes=1
gpgcheck=1
plugins=1
installonly_limit=5
bugtracker_url=http://bugs.centos.org/set_project.php?project_id=19&amp;ref=http://bugs.centos.org/bug_report_page.php?category=yum
distroverpkg=centos-release

#  This is the default, if you make this bigger yum won&#39;t see if the metadata
# is newer on the remote and so you&#39;ll &quot;gain&quot; the bandwidth of not having to
# download the new metadata and &quot;pay&quot; for it by yum not having correct
# information.
#  It is esp. important, to have correct metadata, for distributions like
# Fedora which don&#39;t keep old packages around. If you don&#39;t like this checking
# interupting your command line usage, it&#39;s much better to have something
# manually check the metadata once an hour (yum-updatesd will do this).
# metadata_expire=90m

# PUT YOUR REPOS HERE OR IN separate files named file.repo
# in /etc/yum.repos.d

exlude=nginx*
</code></pre>
<p>这样，使用 yum update 命令升级系统的时候就不会再升级 nginx 相关的软件包了。</p>
<p>参考链接：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9hbnlvZi5tZS9hcnRpY2xlcy8yMzY="> 为yum安装的Nginx添加模块 <i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Nginx</tag>
        <tag>流媒体</tag>
        <tag>RTMP</tag>
      </tags>
  </entry>
  <entry>
    <title>另类的 CefSharp.WPF 中文输入问题解决方案</title>
    <url>/2017/10/31/cefsharp-better-use-in-wpf/</url>
    <content><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>由于某个需求，需要在原有的 WPF 程序上内嵌浏览器，最终选定 CefSharp.WPF , 但是还是有不少的问题影响着使用体验，比如：最开始遇到的不能输入中文、能输入中文了输入法候选框或右键菜单却跑到屏幕左上角，使用搜狗等第三方输入法不能输入等等。</p>
<p>Google 上逛了很久，也试了很多方法，最后发现一个最简单好用的方案是借用 WinForm 控件。</p>
<span id="more"></span>

<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>新建一个 .Net 4.5.2 以上的 WinForm 程序，修改输出类型为“类库”，然后通过 NuGet 下载最新的 <code>CefSharp.WinForms</code> , 新建一个用户控件 <code>CefControl</code>, 添加命名空间：</p>
<pre><code>using CefSharp;
using CefSharp.WinForms;
</code></pre>
<p>添加如下代码：</p>
<pre><code>public partial class CefControl : UserControl
&#123;
    ChromiumWebBrowser Default;

    public CefControl(string url)
    &#123;
        InitializeComponent();

        if (!Cef.IsInitialized)
            Cef.Initialize();
        Default = new ChromiumWebBrowser(url);
        // Add it to the form and fill it to the form window.
        this.Controls.Add(Default);
        Default.Dock = DockStyle.Fill;
    &#125;

    public static void Shutdown()
    &#123;
        if (Cef.IsInitialized)
            Cef.Shutdown();
    &#125;
&#125;
</code></pre>
<p>在 WPF 项目中使用：</p>
<pre><code>        &lt;WindowsFormsHost&gt;
            &lt;wflib:CefControl/&gt;
        &lt;/WindowsFormsHost&gt;
</code></pre>
<p>或：</p>
<pre><code>        WindowsFormsHost browser = new WindowsFormsHost();
        browser.Child = new CefControl(url);
        
</code></pre>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS9TdGFydHNfMjAwMC9wL2NlZmhhcnAtd3BmLW9zci1pbWUuaHRtbA==">解决 CefSharp WPF控件不能使用输入法输入中文的问题<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS93b2xmLXN1bi9wLzY5Mjg0NTYuaHRtbA==">CefSharp WPF 中文输入问题解决方法<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>WPF</tag>
      </tags>
  </entry>
  <entry>
    <title>在 Windows 10 2017秋季更新后 WSL 替换 Ubuntu 为 Archlinux</title>
    <url>/2017/11/05/install-archlinux-on-wsl/</url>
    <content><![CDATA[<p>从Windows商店安装Ubuntu。</p>
<p>从开始菜单打开 Ubuntu。</p>
<p>通过 cmd 切换默认用户为 root:</p>
<pre><code>&gt; ubuntu config --default-user root
</code></pre>
<p>重新打开 Ubuntu。</p>
<p>从 <span class="exturl" data-url="aHR0cHM6Ly93d3cuYXJjaGxpbnV4Lm9yZy9kb3dubG9hZC8=">Arch Linux Downloads<i class="fa fa-external-link-alt"></i></span>或镜像站 下载一个 archlinux-bootstrap.tar.gz, 并解压：</p>
<pre><code># wget https://mirrors.tuna.tsinghua.edu.cn/archlinux/iso/2018.05.01/archlinux-bootstrap-2018.05.01-x86_64.tar.gz
# tar -zxvf archlinux-bootstrap-2018.05.01-x86_64.tar.gz
</code></pre>
<p>修改 <code>~/root.x86_64/etc/pacman.d/mirrorlist</code>, 选择需要的服务器，取消注释。</p>
<p>让WSL自动生成 &#x2F;etc&#x2F;resolv.conf:</p>
<pre><code># echo &quot;# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line.&quot; &gt; ~/root.x86_64/etc/resolv.conf
</code></pre>
<p>退出所有 Ubuntu Shell, 在资源管理器中打开 <code>%localappdata%\Packages</code>, 并找到 <code>CanonicalGroupLimited.UbuntuonWindows_</code> 开头的文件夹，删除 <code>%localappdata%\Packages\CanonicalGroupLimited.UbuntuonWindows_*\LocalState\rootfs</code> 中的 bin, etc, lib, lib64, sbin, srv, usr 和 var 等 8 个文件夹。</p>
<p>然后，<strong>移动</strong> <code>rootfs\root\root.x86_64</code> 中的 bin, etc, lib, lib64, sbin, srv, usr 和 var 到 <code>rootfs</code> 中。</p>
<p><del>在另一个 Arch Linux 系统中构建 <a href="https://aur.archlinux.org/packages/fakeroot-tcp/">fakeroot-tcp<sup>AUR</sup></a> 和 <a href="https://aur.archlinux.org/packages/glibc-wsl/">glibc-wsl<sup>AUR</sup></a> , 然后复制到你的 Windows 电脑。 （通过 <code>--nocheck</code> 选项可以在 <code>makepkg</code> 编译 glibc-wsl 时跳过一个非常耗时的测试套件） <em>glibc-wsl</em> 用于解决 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9CYXNoT25XaW5kb3dzL2lzc3Vlcy8xODc4">这个bug<i class="fa fa-external-link-alt"></i></span>。 而直到 System V IPC 被完全实现之前 <em>fakeroot-tcp</em> 都是必需的。 (<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9CYXNoT25XaW5kb3dzL2lzc3Vlcy8xMDE2">详情<i class="fa fa-external-link-alt"></i></span>)</del></p>
<p>在另一个 Arch Linux 系统中构建 <a href="https://aur.archlinux.org/packages/fakeroot-tcp/">fakeroot-tcp<sup>AUR</sup></a> , 然后复制到你的 Windows 电脑。直到 System V IPC 被完全实现之前 <em>fakeroot-tcp</em> 都是必需的。 (<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9CYXNoT25XaW5kb3dzL2lzc3Vlcy8xMDE2">详情<i class="fa fa-external-link-alt"></i></span>)</p>
<p>重新打开 Bash 以安装 Archlinux:</p>
<pre><code># pacman-key --init
# pacman-key --populate archlinux
# pacman -Syy
# pacman -U fakeroot-tcp-1.22-2-x86_64.pkg.tar.xz
# pacman -Syu base base-devel
</code></pre>
<p>注意：在安装 base 和 base-devel 时，需要取消 <del>glibc 和</del> fakeroot 。</p>
<p>最后，增加一个普通账号。</p>
<pre><code># useradd -m -G wheel -s /bin/bash username
# passwd root
# passwd username
</code></pre>
<p>并通过 cmd 设置该账号为默认账号：</p>
<pre><code>&gt; ubuntu config --default-user username
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>WSL</tag>
        <tag>Archlinux</tag>
      </tags>
  </entry>
  <entry>
    <title>通过 Apt 为 Nginx 添加 RTMP 直播模块</title>
    <url>/2017/11/10/add-rtmp-module-to-nginx-full-with-apt/</url>
    <content><![CDATA[<p>通过 apt 安装的 Nginx 可以通过系统服务的方式进行启动，相当便捷，但 Nginx 目前还不可以后期动态添加模块的，所以只能通过编译安装了。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>更新，及安装必要工具。</p>
<pre><code>sudo apt-get update
sudo apt-get install -y dpkg-dev
</code></pre>
<p>创建一个干净的目录，用于后面的编译工作。</p>
<pre><code>mkdir build &amp;&amp; cd build
</code></pre>
<p>获取 nginx 源码。执行以下代码后，会在当前目录将 nginx 的源码下载至 <em>nginx-*</em> , * 是版本号。</p>
<pre><code>apt-get source nginx
</code></pre>
<p>获取 nginx-rtmp-module 源码。通过 git 获取，或者<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FydXQvbmdpbngtcnRtcC1tb2R1bGUvYXJjaGl2ZS9tYXN0ZXIuemlw">直接下载<i class="fa fa-external-link-alt"></i></span>。</p>
<pre><code>git clone https://github.com/arut/nginx-rtmp-module.git
cd nginx-rtmp-module
git checkout $(git describe --abbrev=0 --tags)
</code></pre>
<span id="more"></span>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>进入  <em>nginx-*</em> 目录，修改 <code>debian/rules</code>, 找到 <code>full_configure_flags</code> 或 <code>config.status.full</code> 这一段，在最后增加一行 <code>--add-module=*</code>，其中 &#x3D; 后是 nginx-rtmp-module 的路径，比如我的 nginx-rtmp-module 跟 nginx 一样都在 build 目录下，是这样的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--add-module=$(CURDIR)/../nginx-rtmp-module</span><br></pre></td></tr></table></figure>

<p>修改后的段落像是这样的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">full_configure_flags := \</span><br><span class="line">            $(common_configure_flags) \</span><br><span class="line">            --with-http_addition_module \</span><br><span class="line">            --with-http_dav_module \</span><br><span class="line">            --with-http_geoip_module \</span><br><span class="line">            --with-http_gunzip_module \</span><br><span class="line">            --with-http_gzip_static_module \</span><br><span class="line">            --with-http_image_filter_module \</span><br><span class="line">                        --with-http_v2_module \</span><br><span class="line">            --with-http_sub_module \</span><br><span class="line">            --with-http_xslt_module \</span><br><span class="line">            --with-stream \</span><br><span class="line">            --with-stream_ssl_module \</span><br><span class="line">            --with-mail \</span><br><span class="line">            --with-mail_ssl_module \</span><br><span class="line">            --with-threads \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-auth-pam \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-dav-ext-module \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-echo \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-upstream-fair \</span><br><span class="line">            --add-module=$(MODULESDIR)/ngx_http_substitutions_filter_module \</span><br><span class="line">            --add-module=$(CURDIR)/../nginx-rtmp-module</span><br></pre></td></tr></table></figure>

<p>或是这样的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">config.status.full: config.env.full</span><br><span class="line">        cd $(BUILDDIR_full) &amp;&amp; ./configure  \</span><br><span class="line">            $(common_configure_flags) \</span><br><span class="line">            --with-http_addition_module \</span><br><span class="line">            --with-http_dav_module \</span><br><span class="line">            --with-http_geoip_module \</span><br><span class="line">            --with-http_gzip_static_module \</span><br><span class="line">            --with-http_image_filter_module \</span><br><span class="line">            --with-http_spdy_module \</span><br><span class="line">            --with-http_sub_module \</span><br><span class="line">            --with-http_xslt_module \</span><br><span class="line">            --with-mail \</span><br><span class="line">            --with-mail_ssl_module \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-auth-pam \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-dav-ext-module \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-echo \</span><br><span class="line">            --add-module=$(MODULESDIR)/nginx-upstream-fair \</span><br><span class="line">            --add-module=$(MODULESDIR)/ngx_http_substitutions_filter_module \</span><br><span class="line">            --add-module=$(CURDIR)/../nginx-rtmp-module \</span><br><span class="line">            &gt;$@</span><br><span class="line">        touch $@</span><br></pre></td></tr></table></figure>

<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><pre><code>sudo apt-get build-dep nginx
</code></pre>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><pre><code>dpkg-buildpackage -b
</code></pre>
<p>之后，会在 nginx 的上级目录，也就是 build 目录下，生成一堆 deb 软件包。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>接下来就可以直接安装了。</p>
<pre><code>sudo dpkg -i nginx-common_*.deb nginx-full_*.deb
</code></pre>
<h2 id="后期工作"><a href="#后期工作" class="headerlink" title="后期工作"></a>后期工作</h2><p>在运行 <code>apt upgrade</code> 的时候，忽略 nginx-common 与 nginx-full 。</p>
<pre><code>sudo apt-mark hold nginx-common nginx-full
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Nginx</tag>
        <tag>流媒体</tag>
        <tag>RTMP</tag>
      </tags>
  </entry>
  <entry>
    <title>如何将 RGB 数据保存为 BMP 图片？</title>
    <url>/2017/12/04/save-rgb-as-bmp/</url>
    <content><![CDATA[<p>直接上代码，一个函数搞定。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SaveAsBMP</span><span class="params">(<span class="type">char</span> *filename, <span class="type">unsigned</span> <span class="type">char</span>* image, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> bpp)</span></span><br><span class="line">&#123;</span><br><span class="line">	BITMAPFILEHEADER bmpheader;</span><br><span class="line">	BITMAPINFOHEADER bmpinfo;</span><br><span class="line">	FILE *fp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((fp = fopen(filename, <span class="string">&quot;wb+&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open file failed!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 4 Byte aligned</span></span><br><span class="line">	<span class="type">int</span> stride = (((width * bpp) + <span class="number">31</span>) &gt;&gt; <span class="number">5</span>) &lt;&lt; <span class="number">2</span>;  <span class="comment">// (( BPP * Width ) / 32) * 4</span></span><br><span class="line">	<span class="type">int</span> img_data_size = stride * height;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	bmpheader.bfType = <span class="number">0x4d42</span>;</span><br><span class="line">	bmpheader.bfReserved1 = <span class="number">0</span>;</span><br><span class="line">	bmpheader.bfReserved2 = <span class="number">0</span>;</span><br><span class="line">	bmpheader.bfOffBits = <span class="keyword">sizeof</span>(BITMAPFILEHEADER) + <span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span><br><span class="line">	bmpheader.bfSize = bmpheader.bfOffBits + img_data_size;</span><br><span class="line"></span><br><span class="line">	bmpinfo.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span><br><span class="line">	bmpinfo.biWidth = width;</span><br><span class="line">	bmpinfo.biHeight = height;</span><br><span class="line">	bmpinfo.biPlanes = <span class="number">1</span>;</span><br><span class="line">	bmpinfo.biBitCount = bpp;</span><br><span class="line">	bmpinfo.biCompression = BI_RGB;</span><br><span class="line">	bmpinfo.biSizeImage = img_data_size; <span class="comment">//  it can be 0 when biCompression is BI_RGB.</span></span><br><span class="line">	bmpinfo.biXPelsPerMeter = <span class="number">3780</span>;  <span class="comment">// 96 * 39.370079 ~= 3780</span></span><br><span class="line">	bmpinfo.biYPelsPerMeter = <span class="number">3780</span>;</span><br><span class="line">	bmpinfo.biClrUsed = <span class="number">0</span>;</span><br><span class="line">	bmpinfo.biClrImportant = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	fwrite(&amp;bmpheader, <span class="keyword">sizeof</span>(bmpheader), <span class="number">1</span>, fp);</span><br><span class="line">	fwrite(&amp;bmpinfo, <span class="keyword">sizeof</span>(bmpinfo), <span class="number">1</span>, fp);</span><br><span class="line">	</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *buffer = new <span class="type">unsigned</span> <span class="type">char</span>[img_data_size];</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>* pImage = image;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>* pDest = buffer;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pixel_w_size = width * bpp / <span class="number">8</span>;</span><br><span class="line">	pImage += pixel_w_size*(height - <span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; height; i++) &#123;</span><br><span class="line">		<span class="built_in">memcpy</span>(pDest, pImage, pixel_w_size);</span><br><span class="line">		pDest += stride;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//fwrite(pImage, pixel_w_size, 1, fp);</span></span><br><span class="line">		pImage -= pixel_w_size;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pImage = nullptr;</span><br><span class="line"></span><br><span class="line">	fwrite(buffer, img_data_size, <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	delete[] buffer;</span><br><span class="line">	buffer = nullptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p>BMP文件格式，又称为Bitmap（位图）或是DIB(Device-Independent Device，设备无关位图)，是Windows系统中广泛使用的图像文件格式。由于它可以不作任何变换地保存图像像素域的数据，因此成为我们取得RAW数据的重要来源。Windows的图形用户界面（graphical user interfaces）也在它的内建图像子系统GDI中对BMP格式提供了支持。</p>
<p>BMP文件的数据按照从文件头开始的先后顺序分为四个部分：</p>
<ul>
<li>bmp文件头(bmp file header)：提供文件的格式、大小等信息</li>
<li>位图信息头(bitmap information)：提供图像数据的尺寸、位平面数、压缩方式、颜色索引等信息</li>
<li>调色板(color palette)：可选，如使用索引来表示图像，调色板就是索引与其对应的颜色的映射表</li>
<li>位图数据(bitmap data)：就是图像数据啦^_^</li>
</ul>
<table>
<thead>
<tr>
<th>块名称</th>
<th>对应Windows结构体定义</th>
<th>大小（Byte）</th>
</tr>
</thead>
<tbody><tr>
<td>文件信息头</td>
<td>BITMAPFILEHEADER</td>
<td>14</td>
</tr>
<tr>
<td>位图信息头</td>
<td>BITMAPINFOHEADER</td>
<td>40</td>
</tr>
<tr>
<td>调色版</td>
<td></td>
<td>由颜色索引数决定</td>
</tr>
<tr>
<td>RGB颜色阵列</td>
<td>BYTE*</td>
<td>由图像长宽尺寸决定</td>
</tr>
</tbody></table>
<h3 id="BMP文件头（14字节）"><a href="#BMP文件头（14字节）" class="headerlink" title="BMP文件头（14字节）"></a>BMP文件头（14字节）</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span><br><span class="line">  WORD  bfType;</span><br><span class="line">  DWORD bfSize;</span><br><span class="line">  WORD  bfReserved1;</span><br><span class="line">  WORD  bfReserved2;</span><br><span class="line">  DWORD bfOffBits;</span><br><span class="line">&#125; BITMAPFILEHEADER, *PBITMAPFILEHEADER;</span><br></pre></td></tr></table></figure>
<ul>
<li>bfType<br>The file type; must be BM. 即 0x4d42 </li>
<li>bfSize<br>The size, in bytes, of the bitmap file. 该位图文件的大小，用字节为单位</li>
<li>bfReserved1<br>Reserved; must be zero.</li>
<li>bfReserved2<br>Reserved; must be zero.</li>
<li>bfOffBits<br>The offset, in bytes, from the beginning of the BITMAPFILEHEADER structure to the bitmap bits.<br>从文件头开始到实际的图象数据之间的字节的偏移量。这个参数是非常有用的，因为位图信息头和调色板的长度会根据不同情况而变化，所以你可以用这个偏移值迅速的从文件中读取到位数据。</li>
</ul>
<h3 id="位图信息头（40字节）"><a href="#位图信息头（40字节）" class="headerlink" title="位图信息头（40字节）"></a>位图信息头（40字节）</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span><br><span class="line">  DWORD biSize;</span><br><span class="line">  LONG  biWidth;</span><br><span class="line">  LONG  biHeight;</span><br><span class="line">  WORD  biPlanes;</span><br><span class="line">  WORD  biBitCount;</span><br><span class="line">  DWORD biCompression;</span><br><span class="line">  DWORD biSizeImage;</span><br><span class="line">  LONG  biXPelsPerMeter;</span><br><span class="line">  LONG  biYPelsPerMeter;</span><br><span class="line">  DWORD biClrUsed;</span><br><span class="line">  DWORD biClrImportant;</span><br><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span><br></pre></td></tr></table></figure>

<ul>
<li>biSize<br>The number of bytes required by the structure.</li>
<li>biWidth<br>The width of the bitmap, in pixels.<br>If biCompression is <em>BI_JPEG</em> or <em>BI_PNG</em>, the biWidth member specifies the width of the decompressed JPEG or PNG image file, respectively.</li>
<li>biHeight<br>The height of the bitmap, in pixels. If biHeight is positive, the bitmap is a bottom-up DIB and its origin is the lower-left corner. If biHeight is negative, the bitmap is a top-down DIB and its origin is the upper-left corner.<br>If biHeight is negative, indicating a top-down DIB, biCompression must be either BI_RGB or BI_BITFIELDS. Top-down DIBs cannot be compressed.<br>If biCompression is <em>BI_JPEG</em> or <em>BI_PNG</em>, the biHeight member specifies the height of the decompressed JPEG or PNG image file, respectively.<br>说明图象的高度，以象素为单位。注：这个值除了用于描述图像的高度之外，它还有另一个用处，就是指明该图像是倒向的位图，还是正向的位图。<br>如果该值是一个正数，说明图像是倒向的，如果该值是一个负数，则说明图像是正向的。大多数的BMP文件都是倒向的位图，也就是时，高度值是一个正数。</li>
<li>biPlanes<br>The number of planes for the target device. This value must be set to 1.<br>为目标设备说明位面数，其值将总是被设为1。</li>
<li>biBitCount<br>The number of bits-per-pixel. The biBitCount member of the BITMAPINFOHEADER structure determines the number of bits that define each pixel and the maximum number of colors in the bitmap. This member must be one of the following values.<br>说明比特数&#x2F;象素，其值为1、4、8、16、24、或32。但是由于我们平时用到的图像绝大部分是24位和32位的。</li>
<li>biCompression<br>The type of compression for a compressed bottom-up bitmap (top-down DIBs cannot be compressed). This member can be one of the following values.</li>
<li>biSizeImage<br>The size, in bytes, of the image. This may be set to zero for BI_RGB bitmaps.<br>If biCompression is BI_JPEG or BI_PNG, biSizeImage indicates the size of the JPEG or PNG image buffer, respectively.<br>说明图象的大小，以字节为单位。当用BI_RGB格式时，可设置为0。</li>
<li>biXPelsPerMeter<br>The horizontal resolution, in pixels-per-meter, of the target device for the bitmap. An application can use this value to select a bitmap from a resource group that best matches the characteristics of the current device.<br>说明水平分辨率，用象素&#x2F;米表示。</li>
<li>biYPelsPerMeter<br>The vertical resolution, in pixels-per-meter, of the target device for the bitmap.</li>
<li>biClrUsed<br>The number of color indexes in the color table that are actually used by the bitmap. If this value is zero, the bitmap uses the maximum number of colors corresponding to the value of the biBitCount member for the compression mode specified by biCompression.<br>If biClrUsed is nonzero and the biBitCount member is less than 16, the biClrUsed member specifies the actual number of colors the graphics engine or device driver accesses. If biBitCount is 16 or greater, the biClrUsed member specifies the size of the color table used to optimize performance of the system color palettes. If biBitCount equals 16 or 32, the optimal color palette starts immediately following the three DWORD masks.<br>When the bitmap array immediately follows the BITMAPINFO structure, it is a packed bitmap. Packed bitmaps are referenced by a single pointer. Packed bitmaps require that the biClrUsed member must be either zero or the actual size of the color table.<br>说明位图实际使用的彩色表中的颜色索引数（设为0的话，则说明使用所有调色板项）。</li>
<li>biClrImportant<br>The number of color indexes that are required for displaying the bitmap. If this value is zero, all colors are required.<br>说明对图象显示有重要影响的颜色索引的数目，如果是0，表示都重要。</li>
</ul>
<h3 id="位图数据"><a href="#位图数据" class="headerlink" title="位图数据"></a>位图数据</h3><p>位图数据记录了位图的每一个像素值，记录顺序是在扫描行内是从左到右，扫描行之间是从下到上。</p>
<p>无论是磁盘上的位图文件还是内存中的位图图像，像素都由一组位（英语：bit）表示。</p>
<p>位图的一个像素值所占的字节数：</p>
<ul>
<li>每像素占1位（色深为1位，1bpp）的格式支持2种不同颜色。像素值直接对应一个位的值，最左像素对应第一个字节的最高位。使用该位的值用来对色表的索引：为0表示色表中的第一项，为1表示色表中的第二项（即最后一项）。</li>
<li>每像素占2位（色深为2位，2bpp）的格式支持4种不同颜色。每个字节对应4个像素，最左像素为最高的两位（仅在Windows CE中有效）。需要使用像素值来对一张含有4个颜色值的色表进行索引。</li>
<li>每像素占4位（色深为4位，4bpp）的格式支持16种不同的颜色。每个字节对应2个像素，最左像素为最高的四位。需要使用像素值来对一张含有16个颜色值的色表进行索引。</li>
<li>每像素占8位（色深为8位，8bpp）的格式支持256种不同的颜色。每个字节对应1个像素。需要使用像素值来对一张含有256个颜色值的色表进行索引。</li>
<li>每像素占16位（色深为16位，16bpp）的格式支持65536种不同的颜色，每2个字节（byte）对应一个像素。该像素的不透明度（英语：alpha）、红、绿、蓝采样值即存储在该2个字节中。</li>
<li>每像素占24位（色深为24位，24bpp）的格式支持16777216种不同的颜色，每3个字节对应一个像素。按顺序分别为B,G,R。</li>
<li>每像素占32位（色深为32位，32bpp）的格式支持4294967296种不同的颜色，每4个字节对应一个像素。按顺序分别为B,G,R,A。</li>
</ul>
<p>为了区分一个颜色值中的哪些位表示哪种采样值，DIB头给出了一套默认规则，同时也允许使用BITFIELDS将某组位指定为像素中的某个通道。</p>
<h3 id="对齐规则"><a href="#对齐规则" class="headerlink" title="对齐规则"></a>对齐规则</h3><p>由于Windows在进行行扫描的时候最小的单位为4个字节，如果数据对齐满足这个值的话对于数据的获取速度等都是有很大的增益的。<br>因此，BMP图像顺应了这个要求，要求每行的数据的长度必须是4的倍数，如果不够需要进行比特填充（以0填充），这样可以达到按行的快速存取。<br>这时，位图数据区的大小就未必是图片宽×每像素字节数×图片高能表示的了，因为每行可能还需要进行比特填充。</p>
<p>填充后的每行的字节数为：</p>
<pre><code>RowSize = 4 * (( BPP * Width ) / 32)
</code></pre>
<p>其中BPP（Bits Per Pixel）为每像素的比特数。</p>
<p>在程序中，我们可以表示为：</p>
<pre><code>int stride = (((Width * BPP) + 31) &gt;&gt; 5) &lt;&lt; 2;
</code></pre>
<p>注意： int 的除法。结果还是int，会舍掉小数点。所以，我们加上31，再除以32，就可以防止字节数变少。</p>
<p>这样，位图数据区的大小为：</p>
<pre><code>img_data_size = stride * Height;
</code></pre>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vTWF0cml4X1lhby9hcmNoaXZlLzIwMDkvMTIvMDIvMTYxNTI5NS5odG1s">BMP文件格式详解<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQveXlmenkvYXJ0aWNsZS9kZXRhaWxzLzc4NTk0NQ==">位图文件（BMP）格式分析以及程序实现<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQk1QX2ZpbGVfZm9ybWF0">BMP file format<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vcXVlcnkvZGV2MTUucXVlcnk/YXBwSWQ9RGV2MTVJREVGMSZsPVpILUNOJms9ayhXSU5HREkvQklUTUFQRklMRUhFQURFUik7ayhCSVRNQVBGSUxFSEVBREVSKTtrKERldkxhbmctQysrKTtrKFRhcmdldE9TLVdpbmRvd3MpJnJkPXRydWU=">BITMAPFILEHEADER structure<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vcXVlcnkvZGV2MTUucXVlcnk/YXBwSWQ9RGV2MTVJREVGMSZsPVpILUNOJms9ayhXSU5HREkvQklUTUFQSU5GT0hFQURFUik7ayhCSVRNQVBJTkZPSEVBREVSKTtrKERldkxhbmctQysrKTtrKFRhcmdldE9TLVdpbmRvd3MpJnJkPXRydWU=">BITMAPINFOHEADER structure<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy50aGV0aGlyZG1lZGlhLmNvbS9wYy8yMDA0MDcvMjAwNDA3MjIxMTcwMjkuc2h0bQ==">BMP格式图像文件详析<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvb2xkbXRuL2FydGljbGUvZGV0YWlscy80Njc0MjU1NQ==">ffmpeg(7)：将h264编码的视频流保存为BMP或者JPEG图片<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>流媒体</tag>
        <tag>图像</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Nginx 转发时保留原始域名</title>
    <url>/2017/12/29/keep-the-Host-header-via-nginx-proxy-pass/</url>
    <content><![CDATA[<p>如果直接通过设置 proxy_pass 转发，会发现原来的域名会丢失，取代出现的是目标地址的 IP 。</p>
<pre><code>server &#123;
    listen 80;

    location / &#123;
        proxy_pass http://127.0.0.1:4356;
    &#125;
&#125;
</code></pre>
<p>解决方法是设置 proxy_set_header . 具体如下：</p>
<pre><code>server &#123;
    listen 80;

    # this is the key !!!
    proxy_set_header Host $host:$server_port;

    location / &#123;
        proxy_pass http://127.0.0.1:4356;
    &#125;
&#125;
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 16.04 禁用客人会话</title>
    <url>/2018/01/22/disable-guest-in-ubuntu-16-04/</url>
    <content><![CDATA[<p>禁用Ubuntu 16.04 的访客模式，只需要修改配置文件 <code>/etc/lightdm/lightdm.conf.d/50-guest-wrapper.conf</code> 。</p>
<pre><code>sudo nano /etc/lightdm/lightdm.conf.d/50-guest-wrapper.conf
</code></pre>
<p>在文件中添加以下内容即可。</p>
<pre><code>[Seat:*]
allow-guest=false
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Notes</tag>
        <tag>Ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>关于 Runtime Error</title>
    <url>/2018/01/26/about-runtime-error/</url>
    <content><![CDATA[<p>自己开发的程序遇到过几次 Runtime Error，用 Visual Studio 调试也完全无法捕获错误，一直以为是运行库有问题，后来发现程序里进行了<strong>错误的类型转换</strong>也可能会引起这个问题。</p>
<span id="more"></span>
<p><img src="/images/runtime-error.jpg" alt="Runtime Error"></p>
<blockquote>
<p>Microsoft Visual C++ Runtime Library</p>
<p>Runtime Error!</p>
<p>Program: C:\xxx\xxx.exe</p>
<p>This application has requested the Runtime to terminate it in an unusual way.<br>Please contact the application’s support team for more information.</p>
</blockquote>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>那些年，在 .Net 里踩过的坑</title>
    <url>/2018/02/07/Traps-and-Pitfalls-of-dotNet/</url>
    <content><![CDATA[<h2 id="WPF-与-WinForm-混用"><a href="#WPF-与-WinForm-混用" class="headerlink" title="WPF 与 WinForm 混用"></a>WPF 与 WinForm 混用</h2><h3 id="AllowsTransparency-amp-WindowsFormsHost"><a href="#AllowsTransparency-amp-WindowsFormsHost" class="headerlink" title="AllowsTransparency &amp; WindowsFormsHost"></a>AllowsTransparency &amp; WindowsFormsHost</h3><p>WPF 启用窗体透明(<code>AllowsTransparency=&quot;true&quot;</code>) 后， <code>WindowsFormsHost</code> 的内容不可见。</p>
<span id="more"></span>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>这是一个 Win32 的限制。</p>
<p>使用 <code>WS_EX_LAYERED</code> 和 <code>UpdateLayeredWindow()</code> 的分层窗体不支持子窗体。</p>
<p>要支持子窗口需要使用不变的不透明度 (<code>WS_EX_LAYERED</code> and <code>SetLayeredWindowAttributes()</code>) 。</p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>一个较好的解决方案，见 <span class="exturl" data-url="aHR0cHM6Ly9ibG9ncy5tc2RuLm1pY3Jvc29mdC5jb20vY2hhbmdvdi8yMDA5LzAxLzE5L3dlYmJyb3dzZXItY29udHJvbC1vbi10cmFuc3BhcmVudC13cGYtd2luZG93Lw==">webbrowser-control-on-transparent-wpf-window<i class="fa fa-external-link-alt"></i></span>。</p>
<p>感谢 <span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDEwODUzMS93cGYtd2luZG93c2Zvcm1zaG9zdC1pcy1ub3QtdmlzaWJsZS13aGVuLWFsbG93c3RyYW5zcGFyZW5jeS10cnVl">Fredrik Hedblad<i class="fa fa-external-link-alt"></i></span> 。</p>
<h4 id="More"><a href="#More" class="headerlink" title="More"></a>More</h4><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS93aW5kb3dzL2Rlc2t0b3AvZmY3MDA1NDModj12cy44NSkuYXNweA==">Extended Window Styles<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
      <tags>
        <tag>WPF</tag>
      </tags>
  </entry>
  <entry>
    <title>代理和镜像设置</title>
    <url>/2018/02/10/proxy-and-mirror-notes/</url>
    <content><![CDATA[<p>代理地址格式： <code>protocol://[user[:pass]@]host[:port]/</code></p>
<p>假设代理地址为： <span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxMDgwLw==">http://127.0.0.1:1080<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="在环境变量中设置代理"><a href="#在环境变量中设置代理" class="headerlink" title="在环境变量中设置代理"></a>在环境变量中设置代理</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Set the proxy address of your uni/company/vpn network ## </span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://127.0.0.1:1080</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"><span class="comment">## FTP version ##</span></span><br><span class="line"><span class="built_in">export</span> ftp_proxy=http:///127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"><span class="comment">## http_proxy with username and password </span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://user:password@your-proxy-ip-address:port/</span><br><span class="line"><span class="built_in">export</span> https_proxy=https://user:password@your-proxy-ip-address:port/</span><br></pre></td></tr></table></figure>

<h4 id="使用配置文件"><a href="#使用配置文件" class="headerlink" title="使用配置文件"></a>使用配置文件</h4><h5 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h5><p>为wget使用代理，可以直接修改<code>/etc/wgetrc</code>，也可以在主文件夹下新建<code>.wgetrc</code>，并编辑相应内容，一般采用后者。</p>
<p>将<code>/etc/wgetrc</code>中与 proxy 有关的几行复制到<code>~/.wgetrc</code>，并做如下修改：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># You can set the default proxies for Wget to use for http, https, and ftp.</span></span><br><span class="line"><span class="comment"># They will override the value in the environment.</span></span><br><span class="line"><span class="attr">https_proxy</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">1080</span></span><br><span class="line"><span class="attr">http_proxy</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">1080</span></span><br><span class="line"><span class="attr">ftp_proxy</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">1080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you do not want to use proxy at all, set this to off.</span></span><br><span class="line"><span class="attr">use_proxy</span> = <span class="literal">on</span></span><br></pre></td></tr></table></figure>

<h5 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h5><p>编辑 <code>~/.curlrc</code> ：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">proxy</span>=<span class="string">&quot;http://127.0.0.1:1080&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><pre><code>git config --global https.proxy http://127.0.0.1:1080
git config --global https.proxy http://127.0.0.1:1080

git config --global http.proxy &#39;socks5://127.0.0.1:1080&#39;
git config --global https.proxy &#39;socks5://127.0.0.1:1080&#39;


git config --global --unset http.proxy
git config --global --unset https.proxy
</code></pre>
<h3 id="Npm"><a href="#Npm" class="headerlink" title="Npm"></a>Npm</h3><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><p>npm获取配置有 6 种方式，优先级由高到底。</p>
<ol>
<li><p>命令行参数。 </p>
<pre><code> npm install --proxy http://127.0.0.1:1080 [name]
</code></pre>
</li>
<li><p>环境变量。 以 <code>npm_config_</code> 为前缀的环境变量将会被认为是 npm 的配置属性。</p>
<pre><code> export npm_config_proxy=http://127.0.0.1:1080
</code></pre>
</li>
<li><p>用户配置文件。可以通过 <code>npm config get userconfig</code> 查看文件路径。</p>
<pre><code> npm config set proxy http://127.0.0.1:1080
 npm config set https-proxy http://127.0.0.1:1080
</code></pre>
</li>
<li><p>全局配置文件。可以通过 <code>npm config get globalconfig</code> 查看文件路径。</p>
<pre><code> npm config set proxy http://127.0.0.1:1080
 npm config set https-proxy http://127.0.0.1:1080
</code></pre>
</li>
<li><p>内置配置文件。安装 npm 的目录下的 <code>npmrc</code> 文件。</p>
</li>
<li><p>默认配置。 npm 本身有默认配置参数，如果以上 5 条都没设置，则 npm 会使用默认配置参数。</p>
</li>
</ol>
<h4 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h4><ul>
<li>淘宝npm镜像<br>  搜索地址：<span class="exturl" data-url="aHR0cDovL25wbS50YW9iYW8ub3JnLw==">http://npm.taobao.org/<i class="fa fa-external-link-alt"></i></span><br>  registry地址：<span class="exturl" data-url="aHR0cDovL3JlZ2lzdHJ5Lm5wbS50YW9iYW8ub3JnLw==">http://registry.npm.taobao.org/<i class="fa fa-external-link-alt"></i></span></li>
<li>cnpmjs镜像<br>  搜索地址：<span class="exturl" data-url="aHR0cDovL2NucG1qcy5vcmcv">http://cnpmjs.org/<i class="fa fa-external-link-alt"></i></span><br>  registry地址：<span class="exturl" data-url="aHR0cDovL3IuY25wbWpzLm9yZy8=">http://r.cnpmjs.org/<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<ol>
<li><p>临时使用</p>
<pre><code> npm --registry https://registry.npm.taobao.org install [name]
</code></pre>
</li>
<li><p>持久使用</p>
<pre><code> npm config set registry https://registry.npm.taobao.org

 // 配置后可通过下面方式来验证是否成功
 npm config get registry
 // 或
 npm info [name]
</code></pre>
</li>
<li><p>通过cnpm使用</p>
<pre><code> npm install -g cnpm --registry=https://registry.npm.taobao.org

 // 使用
 cnpm install [name]
</code></pre>
</li>
</ol>
<h5 id="yarn"><a href="#yarn" class="headerlink" title="yarn"></a>yarn</h5><p>设置为官方镜像：</p>
<pre><code>    yarn config set registry https://registry.yarnpkg.com
</code></pre>
<p>设置为淘宝镜像：</p>
<pre><code>    yarn config set registry http://registry.npm.taobao.org
</code></pre>
<h6 id="CLI-commands-comparison"><a href="#CLI-commands-comparison" class="headerlink" title="CLI commands comparison"></a>CLI commands comparison</h6><table>
<thead>
<tr>
<th>npm (v5)</th>
<th>Yarn</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm install</code></td>
<td><code>yarn install</code></td>
</tr>
<tr>
<td>(N&#x2F;A)</td>
<td><code>yarn install --flat</code></td>
</tr>
<tr>
<td>(N&#x2F;A)</td>
<td><code>yarn install --har</code></td>
</tr>
<tr>
<td><code>npm install --no-package-lock</code></td>
<td><code>yarn install --no-lockfile</code></td>
</tr>
<tr>
<td>(N&#x2F;A)</td>
<td><code>yarn install --pure-lockfile</code></td>
</tr>
<tr>
<td><code>npm install [package] --save</code></td>
<td><code>yarn add [package]</code></td>
</tr>
<tr>
<td><code>npm install [package] --save-dev</code></td>
<td><code>yarn add [package] --dev</code></td>
</tr>
<tr>
<td>(N&#x2F;A)</td>
<td><code>yarn add [package] --peer</code></td>
</tr>
<tr>
<td><code>npm install [package] --save-optional</code></td>
<td><code>yarn add [package] --optional</code></td>
</tr>
<tr>
<td><code>npm install [package] --save-exact</code></td>
<td><code>yarn add [package] --exact</code></td>
</tr>
<tr>
<td>(N&#x2F;A)</td>
<td><code>yarn add [package] --tilde</code></td>
</tr>
<tr>
<td><code>npm install [package] --global</code></td>
<td><code>yarn global add [package]</code></td>
</tr>
<tr>
<td><code>npm update --global</code></td>
<td><code>yarn global upgrade</code></td>
</tr>
<tr>
<td><code>npm rebuild</code></td>
<td><code>yarn add --force</code></td>
</tr>
<tr>
<td><code>npm uninstall [package]</code></td>
<td><code>yarn remove [package]</code></td>
</tr>
<tr>
<td><code>npm cache clean</code></td>
<td><code>yarn cache clean [package]</code></td>
</tr>
<tr>
<td><code>rm -rf node_modules &amp;&amp; npm install</code></td>
<td><code>yarn upgrade</code></td>
</tr>
<tr>
<td><code>npm version major</code></td>
<td><code>yarn version --major</code></td>
</tr>
<tr>
<td><code>npm version minor</code></td>
<td><code>yarn version --minor</code></td>
</tr>
<tr>
<td><code>npm version patch</code></td>
<td><code>yarn version --patch</code></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Notes</category>
      </categories>
      <tags>
        <tag>proxy</tag>
        <tag>mirror</tag>
        <tag>npm</tag>
        <tag>yarn</tag>
      </tags>
  </entry>
  <entry>
    <title>听书笔记之《非暴力沟通》</title>
    <url>/2018/02/28/Reading-Note-of-Nonviolent-Communication/</url>
    <content><![CDATA[<p>作者：马歇尔·卢森堡</p>
<p>旨在帮助我们用不批评、不指责的方式去与人交谈，化解冲突，增进感情。</p>
<p>最佳应用于较亲密的关系。</p>
<blockquote>
<p>我们最容易伤害的是我们最亲近的人。</p>
</blockquote>
<span id="more"></span>

<p><img src="/images/Nonviolent-Communication-Notes.png" alt="Nonviolent Communication"></p>
<h2 id="四个沟通技巧"><a href="#四个沟通技巧" class="headerlink" title="四个沟通技巧"></a>四个沟通技巧</h2><p>让自己不发起暴力沟通</p>
<ol>
<li>观察事实和表达事实</li>
<li>体会和表达感受</li>
<li>发现需要</li>
<li>提出明确的请求</li>
</ol>
<h3 id="观察事实和表达事实"><a href="#观察事实和表达事实" class="headerlink" title="观察事实和表达事实"></a>观察事实和表达事实</h3><p>区分事实和看法。</p>
<p>主观词：我认为、我觉得、你总是…………</p>
<h3 id="体会和表达感受"><a href="#体会和表达感受" class="headerlink" title="体会和表达感受"></a>体会和表达感受</h3><p>感受由心而发，感性，容易唤起引发对方的同理心。看法是理性思考产生，”贴标签”容易引起对方本能的抗拒和反驳。</p>
<p>区分想法、评价和感受</p>
<blockquote>
<p>我觉得我弹得不好</p>
</blockquote>
<p>这是一种评价。</p>
<blockquote>
<p>作为吉他手，我感到很难过、失落</p>
</blockquote>
<p>这是在表达感受。</p>
<ol>
<li>用来表达我们的需要得到满足时的感受<br>  兴奋、甜蜜、精力充沛、兴高采烈、喜悦、自信、开心、高兴、幸福、愉快、满足、欣慰、陶醉等。</li>
<li>用来表达我们的需要没有得到满足时的感受<br>  害怕、担心、焦虑、忧虑、着急、紧张不安丶心神不宁丶悲伤、绝望、气腰丶灰心丶烦恼、愤怒、生气、厌烦等。</li>
<li>表达想法而非感受<br>  披抛弃、被羞辱、被虐待、被打扰、被拒绝、不受重视、被欺负、无人理睬、没人赏识、被利用等。</li>
</ol>
<h3 id="发现需要"><a href="#发现需要" class="headerlink" title="发现需要"></a>发现需要</h3><p>内在的需要，如：被关心、尊重、认可。</p>
<blockquote>
<p>人们常常认为自己的负面情绪是由别人造成的。</p>
</blockquote>
<p>人的感受是由自己的需要造成的，不是由对方的行为造成的。如：你对他人的期待。</p>
<h3 id="提出明确的请求"><a href="#提出明确的请求" class="headerlink" title="提出明确的请求"></a>提出明确的请求</h3><p>一旦知道自己需要什么，直接具体的表达自己的需求。（避免抽象，要具有可操作性）</p>
<h2 id="应对暴力沟通"><a href="#应对暴力沟通" class="headerlink" title="应对暴力沟通"></a>应对暴力沟通</h2><h3 id="应对别人的暴力语言"><a href="#应对别人的暴力语言" class="headerlink" title="应对别人的暴力语言"></a>应对别人的暴力语言</h3><ol>
<li><p>平静，事实，原因，对方的行为，自己的想法、感受、需要，提出请求。</p>
</li>
<li><p>平静，事实，原因，倾听，分析其感受、需要，引导对方说出明确的需求。</p>
</li>
</ol>
<h3 id="应对自己的暴力语言"><a href="#应对自己的暴力语言" class="headerlink" title="应对自己的暴力语言"></a>应对自己的暴力语言</h3><blockquote>
<p>如果你犯了错，也要理解、宽恕你自己，尽快调整自己，把注意力放在目标上，而不是一味的自责，因为那只会让你禁锢在原地，只有反思之后的行动，才有意义。</p>
</blockquote>
<p>我应该&#x2F;不得不这样做 -&gt; 写下来，理解自己行为的动机，化被动为主动 -&gt; 我选择这样做，是因为什么。</p>
]]></content>
      <categories>
        <category>200-听书笔记</category>
      </categories>
      <tags>
        <tag>沟通</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ 11 实现线程安全的环形缓冲区</title>
    <url>/2018/03/23/thread-safe-ring-buffer-implementation-in-cpp11/</url>
    <content><![CDATA[<p>环形缓冲区（<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTkyJUIwJUU1JUJEJUEyJUU3JUI3JUE5JUU4JUExJTlEJUU1JThEJTgw">Ring Buffer<i class="fa fa-external-link-alt"></i></span>），是一种用于表示一个固定尺寸、头尾相连的缓冲区的数据结构，适合缓存数据流。</p>
<p>环形缓冲区的一个有用特性是：当一个数据元素被用掉后，其余数据元素不需要移动其存储位置。换句话说，环形缓冲区适合实现先进先出缓冲区。</p>
<link href="/static/css/ringbuffer.css" rel="stylesheet" type="text/css" />
<div style="text-align: center"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div>

<blockquote>
<p>由于计算机内存是线性地址空间，因此环形缓冲区需要特别的设计才可以从逻辑上实现。<br>一般的，环形缓冲区需要4个指针：</p>
<ul>
<li>在内存中实际开始位置；</li>
<li>在内存中实际结束位置，也可以用缓冲区长度代替；</li>
<li>存储在缓冲区中的有效数据的开始位置（读指针）；</li>
<li>存储在缓冲区中的有效数据的结尾位置（写指针）。</li>
</ul>
</blockquote>
<blockquote>
<p>缓冲区是满、或是空，都有可能出现读指针与写指针指向同一位置，有多种策略用于检测缓冲区是满、或是空：</p>
<ul>
<li>总是保持一个存储单元为空</li>
<li>使用数据计数</li>
<li>镜像指示位</li>
<li>读&#x2F;写 计数</li>
<li>记录最后的操作</li>
</ul>
</blockquote>
<span id="more"></span>

<p>以下是使用数据计数策略用于检测缓冲区是满、或是空，使用自旋锁保证线程安全的高效环形缓冲区。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* ring_buffer_s.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;spin_mutex.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* \brief 线程安全的环形缓冲区</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ring_buffer_s</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">ring_buffer_s</span><span class="params">(<span class="type">size_t</span> capacity)</span></span>;</span><br><span class="line">    <span class="built_in">ring_buffer_s</span>(ring_buffer_s &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ring_buffer_s&amp; <span class="keyword">operator</span>=(ring_buffer_s&amp;&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ring_buffer_s</span>(<span class="type">const</span> ring_buffer_s &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ring_buffer_s&amp; <span class="keyword">operator</span>=(<span class="type">const</span> ring_buffer_s&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ring_buffer_s</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * \brief 获取缓冲区已用大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * \brief 获取缓冲区容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">capacity</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * \brief 写入数据</span></span><br><span class="line"><span class="comment">     * \param data 要写入的数据</span></span><br><span class="line"><span class="comment">     * \param bytes 要写入的数据的大小</span></span><br><span class="line"><span class="comment">     * \return 最终写入的数据的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * \brief 读取数据</span></span><br><span class="line"><span class="comment">     * \param data 用来存放读取数据的buffer</span></span><br><span class="line"><span class="comment">     * \param bytes 要读取的数据大小</span></span><br><span class="line"><span class="comment">     * \return 最终获取到的数据的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">read</span><span class="params">(<span class="type">void</span> *data, <span class="type">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">size_t</span> front_, rear_, size_, capacity_;</span><br><span class="line">    <span class="type">uint8_t</span> *data_;</span><br><span class="line">    <span class="keyword">mutable</span> spin_mutex mut_;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mut_read_;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mut_write_;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* ring_buffer_s.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ring_buffer_s.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">ring_buffer_s::ring_buffer_s</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> capacity)</span></span></span><br><span class="line"><span class="function">    : front_(<span class="number">0</span>)</span></span><br><span class="line"><span class="function">    , rear_(<span class="number">0</span>)</span></span><br><span class="line"><span class="function">    , size_(<span class="number">0</span>)</span></span><br><span class="line"><span class="function">    , capacity_(capacity)</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    data_ = <span class="keyword">new</span> <span class="type">uint8_t</span>[capacity];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ring_buffer_s::~<span class="built_in">ring_buffer_s</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span>[] data_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">ring_buffer_s::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> size_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">ring_buffer_s::capacity</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> capacity_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">ring_buffer_s::write</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *data, <span class="type">const</span> <span class="type">size_t</span> bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过互斥量保证任意时刻，至多只有一个线程在写数据。</span></span><br><span class="line">    std::lock_guard&lt;std::mutex&gt;<span class="built_in">lk_write</span>(mut_write_);</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> capacity = capacity_;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> bytes_to_write = std::<span class="built_in">min</span>(bytes, capacity - size_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_write == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一次性写入</span></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_write &lt;= capacity - rear_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data_ + rear_, data, bytes_to_write);</span><br><span class="line">        rear_ += bytes_to_write;</span><br><span class="line">        <span class="keyword">if</span> (rear_ == capacity) rear_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分两步进行</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> size_1 = capacity - rear_;</span><br><span class="line">        <span class="built_in">memcpy</span>(data_ + rear_, data, size_1);</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> size_2 = bytes_to_write - size_1;</span><br><span class="line">        <span class="built_in">memcpy</span>(data_, <span class="built_in">static_cast</span>&lt;<span class="type">const</span> <span class="type">uint8_t</span>*&gt;(data) + size_1, size_2);</span><br><span class="line">        rear_ = size_2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过自旋锁保证任意时刻，至多只有一个线程在改变 size_ .</span></span><br><span class="line">    std::lock_guard&lt;spin_mutex&gt;<span class="built_in">lk</span>(mut_);</span><br><span class="line">    size_ += bytes_to_write;</span><br><span class="line">    <span class="keyword">return</span> bytes_to_write;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">ring_buffer_s::read</span><span class="params">(<span class="type">void</span> *data, <span class="type">const</span> <span class="type">size_t</span> bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过互斥量保证任意时刻，至多只有一个线程在读数据。</span></span><br><span class="line">    std::lock_guard&lt;std::mutex&gt;<span class="built_in">lk_read</span>(mut_read_);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> capacity = capacity_;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> bytes_to_read = std::<span class="built_in">min</span>(bytes, size_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_read == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一次性读取</span></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_read &lt;= capacity - front_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data, data_ + front_, bytes_to_read);</span><br><span class="line">        front_ += bytes_to_read;</span><br><span class="line">        <span class="keyword">if</span> (front_ == capacity) front_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分两步进行</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> size_1 = capacity - front_;</span><br><span class="line">        <span class="built_in">memcpy</span>(data, data_ + front_, size_1);</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> size_2 = bytes_to_read - size_1;</span><br><span class="line">        <span class="built_in">memcpy</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(data) + size_1, data_, size_2);</span><br><span class="line">        front_ = size_2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过自旋锁保证任意时刻，至多只有一个线程在改变 size_ .</span></span><br><span class="line">    std::lock_guard&lt;spin_mutex&gt;<span class="built_in">lk</span>(mut_);</span><br><span class="line">    size_ -= bytes_to_read;</span><br><span class="line">    <span class="keyword">return</span> bytes_to_read;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* spin_mutex.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">spin_mutex</span> &#123;</span><br><span class="line">    std::atomic_flag flag_ = ATOMIC_FLAG_INIT;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">spin_mutex</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">spin_mutex</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">spin_mutex</span>(<span class="type">const</span> spin_mutex&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    spin_mutex&amp; <span class="keyword">operator</span>= (<span class="type">const</span> spin_mutex&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">spin_mutex</span>(spin_mutex&amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    spin_mutex&amp; <span class="keyword">operator</span>= (spin_mutex&amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (flag_.<span class="built_in">test_and_set</span>(std::memory_order_acquire))</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flag_.<span class="built_in">clear</span>(std::memory_order_release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>400-编程</category>
        <category>C/C++</category>
      </categories>
  </entry>
  <entry>
    <title>Visual Studio 技巧</title>
    <url>/2018/04/03/visual-studio-skill/</url>
    <content><![CDATA[<h2 id="重新安装-NuGet-包"><a href="#重新安装-NuGet-包" class="headerlink" title="重新安装 NuGet 包"></a>重新安装 NuGet 包</h2><p>有时候打开项目，发现 NuGet 包全部丢失了，点击<code>还原 NuGet 包</code>也没有任何作用。</p>
<p>这时我们可以点击<code>工具</code>-&gt;<code>NuGet 包管理器</code>-&gt;<code>程序包管理控制台</code>打开控制台，在里面输入以下命令重新安装解决方案的 NuGet 包。</p>
<pre><code>Update-Package -Reinstall
</code></pre>
<p>也可以只重新安装某一项目的 NuGet 包。</p>
<pre><code>Update-Package -ProjectName &quot;DemoProject&quot; -Reinstall
</code></pre>
<h2 id="DXERR-LIB"><a href="#DXERR-LIB" class="headerlink" title="DXERR.LIB"></a>DXERR.LIB</h2><p>**VS 2015 &#x2F; 2017:**The VS 2015 &#x2F; 2017 C Runtime is not compatible with the<code>DXERR.LIB</code>that ships in the legacy DirectX SDK. You will get link errors trying to use it. You can use this module to replace DXERR LIB but will have to rebuild the code that uses it. You can try linking with<code>legacy_stdio_definitions.lib</code>instead, but ideally you’d remove this dependency on the legacy DirectX SDK.</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>NuGet</tag>
        <tag>VisualStudio</tag>
      </tags>
  </entry>
  <entry>
    <title>在国内使用 Docker</title>
    <url>/2018/04/08/use-docker-in-china/</url>
    <content><![CDATA[<p>在国内安装 docker 或是从 Docker Hub 拉取镜像总是遇到网络慢甚至超时等问题。</p>
<span id="more"></span>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Debian-x2F-Ubuntu"><a href="#Debian-x2F-Ubuntu" class="headerlink" title="Debian&#x2F;Ubuntu"></a>Debian&#x2F;Ubuntu</h3><p>如果你过去安装过 docker，先删掉:</p>
<pre><code>sudo apt-get remove docker docker-engine docker.io
</code></pre>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><pre><code>sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common
</code></pre>
<h4 id="信任-Docker-的-GPG-公钥"><a href="#信任-Docker-的-GPG-公钥" class="headerlink" title="信任 Docker 的 GPG 公钥"></a>信任 Docker 的 GPG 公钥</h4><p>ubuntu</p>
<pre><code>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</code></pre>
<p>debian</p>
<pre><code>curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
</code></pre>
<h4 id="添加软件仓库"><a href="#添加软件仓库" class="headerlink" title="添加软件仓库"></a>添加软件仓库</h4><p>对于 amd64 架构的计算机，请运行:</p>
<pre><code>sudo add-apt-repository \
    &quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \
    $(lsb_release -cs) \
    stable&quot;
</code></pre>
<p>如果你是树莓派或其它ARM架构计算机，请运行:</p>
<pre><code>echo &quot;deb [arch=armhf] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \
    $(lsb_release -cs) stable&quot; | \
    sudo tee /etc/apt/sources.list.d/docker.list
</code></pre>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><pre><code>sudo apt-get update
sudo apt-get install docker-ce
</code></pre>
<h3 id="Fedora-x2F-CentOS-x2F-RHEL"><a href="#Fedora-x2F-CentOS-x2F-RHEL" class="headerlink" title="Fedora&#x2F;CentOS&#x2F;RHEL"></a>Fedora&#x2F;CentOS&#x2F;RHEL</h3><p>如果你之前安装过 docker，请先删掉</p>
<pre><code>sudo yum remove docker docker-common docker-selinux docker-engine
</code></pre>
<h4 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h4><pre><code>sudo yum install -y yum-utils device-mapper-persistent-data lvm2
</code></pre>
<h4 id="添加软件仓库-1"><a href="#添加软件仓库-1" class="headerlink" title="添加软件仓库"></a>添加软件仓库</h4><ol>
<li>先下载 repo 文件<br> CentOS&#x2F;RHEL:<br> <code>wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo</code><br> Fedora:<br> <code>wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/fedora/docker-ce.repo</code></li>
<li>把软件仓库地址替换为 TUNA:<br> <code>sudo sed -i &#39;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#39; /etc/yum.repos.d/docker-ce.repo</code></li>
</ol>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><pre><code>sudo yum makecache fast
sudo yum install docker-ce
</code></pre>
<h2 id="普通用户使用"><a href="#普通用户使用" class="headerlink" title="普通用户使用"></a>普通用户使用</h2><p>将用户加入 docker 用户组</p>
<pre><code>$ gpasswd -a user docker
</code></pre>
<h2 id="使用国内的镜像仓库"><a href="#使用国内的镜像仓库" class="headerlink" title="使用国内的镜像仓库"></a>使用国内的镜像仓库</h2><p>这是 Docker 官方提供的中国 registry mirror</p>
<pre><code>registry.docker-cn.com
</code></pre>
<h3 id="临时使用"><a href="#临时使用" class="headerlink" title="临时使用"></a>临时使用</h3><p>pull 时，加上 registry 地址，如：</p>
<pre><code>$ docker pull registry.docker-cn.com/library/ubuntu
</code></pre>
<h3 id="永久使用"><a href="#永久使用" class="headerlink" title="永久使用"></a>永久使用</h3><p>方法一： 将 <code>https://registry.docker-cn.com</code> 加入到 <code>/etc/docker/daemon.json</code> 中的 registry-mirrors 数组中。修改后的文件内容应该是这样的。</p>
<pre><code>&#123;
    &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]
&#125;
</code></pre>
<p>重启 Docker 服务。</p>
<p>方法二： 启动 Docker daemon 时，带上 –registry-mirror 参数。如。</p>
<pre><code>$ dockerd --registry-mirror=https://registry.docker-cn.com
</code></pre>
<h2 id="安装-docker-compose"><a href="#安装-docker-compose" class="headerlink" title="安装 docker-compose"></a>安装 docker-compose</h2><p>下载 compose 文件</p>
<pre><code>sudo curl -L https://github.com/docker/compose/releases/download/1.20.1/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
</code></pre>
<p>添加执行权限</p>
<pre><code>sudo chmod +x /usr/local/bin/docker-compose
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Notes</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>C# 计算文件 MD5</title>
    <url>/2018/04/10/calculate-file-md5/</url>
    <content><![CDATA[<p>计算文件 MD5</p>
<span id="more"></span>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">string</span> <span class="title">CalculateMd5</span>(<span class="params"><span class="built_in">string</span> filename</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> md5 = System.Security.Cryptography.MD5.Create())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> stream = File.OpenRead(filename))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> hash = md5.ComputeHash(stream);</span><br><span class="line">            <span class="keyword">return</span> BitConverter.ToString(hash).Replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).ToLowerInvariant();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Verify a hash against a string.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">VerifyMd5Hash</span>(<span class="params"><span class="built_in">string</span> filename, <span class="built_in">string</span> hash</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Hash the input.</span></span><br><span class="line">    <span class="built_in">string</span> hashOfInput = CalculateMd5(filename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a StringComparer an compare the hashes.</span></span><br><span class="line">    StringComparer comparer = StringComparer.OrdinalIgnoreCase;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == comparer.Compare(hashOfInput, hash))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
  </entry>
  <entry>
    <title>C# 获取文件的真实类型</title>
    <url>/2018/04/16/get-file-mime-type-without-file-extension/</url>
    <content><![CDATA[<p>用到的命名空间</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<blockquote>
<p>2018&#x2F;9&#x2F;5 更新</p>
</blockquote>
<p>代码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NativeMethods</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;urlmon.dll&quot;</span>, CharSet = CharSet.Unicode, ExactSpelling = true, SetLastError = false)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">FindMimeFromData</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        IntPtr pBC,</span></span></span><br><span class="line"><span class="params"><span class="function">        [MarshalAs(UnmanagedType.LPWStr</span>)] <span class="built_in">string</span> pwzUrl,</span></span><br><span class="line"><span class="function">        [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.LPArray, ArraySubType=UnmanagedType.I1, SizeParamIndex=<span class="number">3</span></span>)]</span></span><br><span class="line"><span class="function">        <span class="built_in">byte</span>[] pBuffer,</span></span><br><span class="line"><span class="function">        <span class="built_in">int</span> cbSize,</span></span><br><span class="line"><span class="function">        [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.LPWStr</span>)] <span class="built_in">string</span> pwzMimeProposed,</span></span><br><span class="line"><span class="function">        <span class="built_in">int</span> dwMimeFlags,</span></span><br><span class="line"><span class="function">        <span class="keyword">out</span> IntPtr ppwzMimeOut,</span></span><br><span class="line"><span class="function">        <span class="built_in">int</span> dwReserved)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetMimeFromFile</span>(<span class="params"><span class="built_in">string</span> filename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!File.Exists(filename))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">$&quot;<span class="subst">&#123;filename&#125;</span> not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">256</span>];</span><br><span class="line">        <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(filename, FileMode.Open))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (fs.Length &gt;= <span class="number">256</span>)</span><br><span class="line">                fs.Read(buffer, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                fs.Read(buffer, <span class="number">0</span>, (<span class="built_in">int</span>)fs.Length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            FindMimeFromData(IntPtr.Zero, <span class="literal">null</span>, buffer, <span class="number">256</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="keyword">out</span> IntPtr mimeTypePtr, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">string</span> mime = Marshal.PtrToStringUni(mimeTypePtr);</span><br><span class="line">            Marshal.FreeCoTaskMem(mimeTypePtr);</span><br><span class="line">            <span class="keyword">return</span> mime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown/unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是另一种写法（不推荐），在 64 位平台上会报错。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">NativeMethods</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">DllImport(@<span class="string">&quot;urlmon.dll&quot;</span>, CharSet = CharSet.Auto)</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">extern</span> <span class="keyword">static</span> System.<span class="function">UInt32 <span class="title">FindMimeFromData</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        System.UInt32 pBC,</span></span></span><br><span class="line"><span class="params"><span class="function">        [MarshalAs(UnmanagedType.LPStr</span>)] System.String pwzUrl,</span></span><br><span class="line"><span class="function">        [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.LPArray</span>)] <span class="built_in">byte</span>[] pBuffer,</span></span><br><span class="line"><span class="function">        System.UInt32 cbSize,</span></span><br><span class="line"><span class="function">        [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.LPStr</span>)] System.String pwzMimeProposed,</span></span><br><span class="line"><span class="function">        System.UInt32 dwMimeFlags,</span></span><br><span class="line"><span class="function">        <span class="keyword">out</span> System.UInt32 ppwzMimeOut,</span></span><br><span class="line"><span class="function">        System.UInt32 dwReserverd</span></span><br><span class="line"><span class="function">        )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetMimeFromFile</span>(<span class="params"><span class="built_in">string</span> filename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!File.Exists(filename))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(filename + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">256</span>];</span><br><span class="line">        <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(filename, FileMode.Open))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (fs.Length &gt;= <span class="number">256</span>)</span><br><span class="line">                fs.Read(buffer, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                fs.Read(buffer, <span class="number">0</span>, (<span class="built_in">int</span>)fs.Length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.UInt32 mimetype;</span><br><span class="line">            FindMimeFromData(<span class="number">0</span>, <span class="literal">null</span>, buffer, <span class="number">256</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="keyword">out</span> mimetype, <span class="number">0</span>);</span><br><span class="line">            System.IntPtr mimeTypePtr = <span class="keyword">new</span> IntPtr(mimetype);</span><br><span class="line">            <span class="built_in">string</span> mime = Marshal.PtrToStringUni(mimeTypePtr);</span><br><span class="line">            Marshal.FreeCoTaskMem(mimeTypePtr);</span><br><span class="line">            <span class="keyword">return</span> mime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown/unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>400-编程</category>
        <category>.Net</category>
      </categories>
  </entry>
  <entry>
    <title>Linux 使用技巧</title>
    <url>/2018/04/16/linux-skill-and-tips/</url>
    <content><![CDATA[<h2 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h2><p>批量修改当前目录及子目录中的文件夹权限为 775 、文件权限为 664</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 664 &#123;&#125; \+ -o -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">chmod</span> 775 &#123;&#125; \+</span><br></pre></td></tr></table></figure>

<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>find 命令中 <code>exec</code> 参数 <code>+</code> 结尾与 <code>;</code> 结尾有什么区别？</p>
<span id="more"></span>

<blockquote>
<p>Why is there a difference in output between using</p>
<pre><code>find . -exec ls &#39;&#123;&#125;&#39; \+
</code></pre>
<p>and</p>
<pre><code>find . -exec ls &#39;&#123;&#125;&#39; \;
</code></pre>
<p>This might be best illustrated with an example. Let’s say that find turns up these files:</p>
<pre><code>file1
file2
file3
</code></pre>
<p>Using -exec with a semicolon (find . -exec ls ‘{}’ ;), will execute</p>
<pre><code>ls file1
ls file2
ls file3
</code></pre>
<p>But if you use a plus sign instead (find . -exec ls ‘{}’ +), as many filenames as possible are passed as arguments to a single command:</p>
<pre><code>ls file1 file2 file3
</code></pre>
<p>The number of filenames is only limited by the system’s maximum command line length. If the command exceeds this length, the command will be called multiple times.</p>
</blockquote>
<h2 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h2><p>以下命令可以查看磁盘各分区大小、已用空间等信息：</p>
<pre><code>df -h
</code></pre>
<p>以下命令可以查看foo目录的大小：</p>
<pre><code>du -sh foo
</code></pre>
<p>有时候，硬盘比较满了，我们想找一些目录来清除，可以用下面命令查看当前目录以下搜索文件和子目录大小。找出特别大的，看里面有没有文件可删：</p>
<pre><code>du -sh *
</code></pre>
<p>如果我们插入了一个U盘或移动硬盘，可以用df命令查看它挂载的地方，通常在&#x2F;mnt或&#x2F;media下。如果想卸载USB存储设备，可以用umount命令：</p>
<pre><code>umount path
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Linux</category>
      </categories>
  </entry>
  <entry>
    <title>在 Ubuntu 16.04 中安装 Kurento Server</title>
    <url>/2018/05/15/install-kurento-server-in-ubuntu-16-04/</url>
    <content><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">REPO=<span class="string">&quot;xenial&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb http://ubuntu.kurento.org <span class="variable">$REPO</span> kms6&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kurento.list</span><br><span class="line">wget http://ubuntu.kurento.org/kurento.gpg.key -O - | sudo apt-key add -</span><br><span class="line">apt update</span><br><span class="line">useradd -U -m kurento</span><br><span class="line">apt install -y kurento-media-server-6.0</span><br><span class="line">systemctl start kurento-media-server-6.0</span><br><span class="line">systemctl <span class="built_in">enable</span> kurento-media-server-6.0</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="添加-H-264-支持"><a href="#添加-H-264-支持" class="headerlink" title="添加 H.264 支持"></a>添加 H.264 支持</h2><p>安装插件 <code>openh264-gst-plugins-bad-1.5</code></p>
<pre><code>apt install -y openh264-gst-plugins-bad-1.5
</code></pre>
<p>重启 kurento server</p>
<pre><code>systemctl restart kurento-media-server-6.0
</code></pre>
<p>若要只支持 H.264 则需要打开 <code>/etc/kurento/modules/kurento/SdpEndpoint.conf.json</code> ，注释掉 videoCodecs 中的 “VP8&#x2F;90000” 。修改之后的文件像这样的。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// ... omit ...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;videoCodecs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   &quot;name&quot; : &quot;VP8/90000&quot;</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;H264/90000&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>保存并重启 Kurento Server 。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Service</category>
      </categories>
      <tags>
        <tag>Kurento</tag>
      </tags>
  </entry>
  <entry>
    <title>Java Http/Https 请求</title>
    <url>/2018/06/01/java-http-or-https-request/</url>
    <content><![CDATA[<p>写好接口给 Java 的小伙伴调用，遇到使用Java发送http或者https请求的需求。和小伙伴在网上遛了一圈，找了很多代码都没能成功发送 Content-Type 为 “application&#x2F;x-www-form-urlencoded” 的 POST 请求（ T_T 可能我们不熟悉 Java ）。最后，发现 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00xbW9yeS9hcnRpY2xlL2RldGFpbHMvNzY5NDQ2Njg=">M1mory<i class="fa fa-external-link-alt"></i></span> 的能用。因此，稍作修改记录下来，方便以后使用。</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.HttpsURLConnection;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLEngine;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSession;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.X509ExtendedTrustManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpsUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">proxySet</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">proxyHost</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">proxyPort</span> <span class="operator">=</span> <span class="number">1080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://www.google.com&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">getResult</span> <span class="operator">=</span> HttpsUtils.sendPost(url, params, proxySet);</span><br><span class="line">        System.out.println(getResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置请求头属性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title function_">setProperty</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, String&gt; pMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// pMap.put(&quot;Accept-Encoding&quot;, &quot;gzip&quot;); //请求定义gzip,响应也是压缩包</span></span><br><span class="line">        pMap.put(<span class="string">&quot;connection&quot;</span>, <span class="string">&quot;Keep-Alive&quot;</span>);</span><br><span class="line">        pMap.put(<span class="string">&quot;user-agent&quot;</span>, <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;</span>);</span><br><span class="line">        pMap.put(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> pMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * GET请求</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     *            请求的URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment">     *            请求参数，name1=value1&amp;name2=value2 的形式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sendGet</span><span class="params">(String url, String param, <span class="type">boolean</span> isproxy)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">urlNameString</span> <span class="operator">=</span> url;</span><br><span class="line">            <span class="keyword">if</span> (param != <span class="literal">null</span> &amp;&amp; !(<span class="string">&quot;&quot;</span>.equals(param)))</span><br><span class="line">                urlNameString = url + <span class="string">&quot;?&quot;</span> + param;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">realUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(urlNameString);</span><br><span class="line">            <span class="comment">// 打开和URL之间的连接</span></span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (isproxy) &#123;<span class="comment">// 使用代理模式</span></span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;static-access&quot;)</span></span><br><span class="line">                <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(Proxy.Type.DIRECT.HTTP, <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(proxyHost, proxyPort));</span><br><span class="line">                connection = (HttpURLConnection) realUrl.openConnection(proxy);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                connection = (HttpURLConnection) realUrl.openConnection();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// https 忽略证书验证</span></span><br><span class="line">            <span class="keyword">if</span> (url.substring(<span class="number">0</span>, <span class="number">5</span>).equals(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">SSLContext</span> <span class="variable">ctx</span> <span class="operator">=</span> MyX509TrustManagerUtils();</span><br><span class="line">                ((HttpsURLConnection) connection).setSSLSocketFactory(ctx.getSocketFactory());</span><br><span class="line">                ((HttpsURLConnection) connection).setHostnameVerifier(<span class="keyword">new</span> <span class="title class_">HostnameVerifier</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String arg0, SSLSession arg1)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置通用的请求属性</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : setProperty().entrySet()) &#123;</span><br><span class="line">                connection.setRequestProperty(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 建立连接</span></span><br><span class="line">            connection.connect();</span><br><span class="line">            <span class="comment">// 定义 BufferedReader输入流来读取URL的响应</span></span><br><span class="line">            <span class="keyword">if</span> (connection.getResponseCode() == HttpURLConnection.HTTP_OK</span><br><span class="line">                    || connection.getResponseCode() == HttpURLConnection.HTTP_CREATED</span><br><span class="line">                    || connection.getResponseCode() == HttpURLConnection.HTTP_ACCEPTED) &#123;</span><br><span class="line">                in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(connection.getInputStream(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(connection.getErrorStream(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result += line;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发送GET请求出现异常！&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用finally块来关闭输入流</span></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * POST请求</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     *            发送请求的 URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment">     *            请求参数 name1=value1&amp;name2=value2 的形式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isproxy</span></span><br><span class="line"><span class="comment">     *            是否使用代理模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sendPost</span><span class="params">(String url, String param, <span class="type">boolean</span> isproxy)</span> &#123;</span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">realUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (isproxy) &#123;<span class="comment">// 使用代理模式</span></span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;static-access&quot;)</span></span><br><span class="line">                <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(Proxy.Type.DIRECT.HTTP, <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(proxyHost, proxyPort));</span><br><span class="line">                conn = (HttpURLConnection) realUrl.openConnection(proxy);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                conn = (HttpURLConnection) realUrl.openConnection();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// https</span></span><br><span class="line">            <span class="keyword">if</span> (url.substring(<span class="number">0</span>, <span class="number">5</span>).equals(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">SSLContext</span> <span class="variable">ctx</span> <span class="operator">=</span> MyX509TrustManagerUtils();</span><br><span class="line">                ((HttpsURLConnection) conn).setSSLSocketFactory(ctx.getSocketFactory());</span><br><span class="line">                ((HttpsURLConnection) conn).setHostnameVerifier(<span class="keyword">new</span> <span class="title class_">HostnameVerifier</span>() &#123;</span><br><span class="line">                    <span class="comment">//在握手期间，如果 URL 的主机名和服务器的标识主机名不匹配，则验证机制可以回调此接口的实现程序来确定是否应该允许此连接。</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String arg0, SSLSession arg1)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送POST请求必须设置如下两行</span></span><br><span class="line">            conn.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">            conn.setDoInput(<span class="literal">true</span>);</span><br><span class="line">            conn.setRequestMethod(<span class="string">&quot;POST&quot;</span>); <span class="comment">// POST方法</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置通用的请求属性</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : setProperty().entrySet()) &#123;</span><br><span class="line">                conn.setRequestProperty(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            conn.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取URLConnection对象对应的输出流</span></span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(conn.getOutputStream(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="comment">// 发送请求参数</span></span><br><span class="line">            out.write(param);</span><br><span class="line">            <span class="comment">// flush输出流的缓冲</span></span><br><span class="line">            out.flush();</span><br><span class="line">            <span class="comment">// 定义BufferedReader输入流来读取URL的响应</span></span><br><span class="line">            <span class="keyword">if</span> (conn.getResponseCode() == HttpURLConnection.HTTP_OK</span><br><span class="line">                    || conn.getResponseCode() == HttpURLConnection.HTTP_CREATED</span><br><span class="line">                    || conn.getResponseCode() == HttpURLConnection.HTTP_ACCEPTED) &#123;</span><br><span class="line">                in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(conn.getInputStream(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(conn.getErrorStream(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result += line;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发送 POST 请求出现异常！&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用finally块来关闭输出流、输入流</span></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===========================utils===================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * url编码</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source</span></span><br><span class="line"><span class="comment">     *            待编码字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encode</span></span><br><span class="line"><span class="comment">     *            字符编码 eg:UTF-8</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 编码字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">urlEncode</span><span class="params">(String source, String encode)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> source;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = java.net.URLEncoder.encode(source, encode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * HTTPS忽略证书验证,防止高版本jdk因证书算法不符合约束条件,使用继承X509ExtendedTrustManager的方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MyX509TrustManager</span> <span class="keyword">extends</span> <span class="title class_">X509ExtendedTrustManager</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span> <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span> <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] arg0, String arg1, Socket arg2)</span> <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] arg0, String arg1, SSLEngine arg2)</span></span><br><span class="line">                <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] arg0, String arg1, Socket arg2)</span> <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] arg0, String arg1, SSLEngine arg2)</span></span><br><span class="line">                <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SSLContext <span class="title function_">MyX509TrustManagerUtils</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        TrustManager[] tm = &#123; <span class="keyword">new</span> <span class="title class_">HttpsUtils</span>().<span class="keyword">new</span> <span class="title class_">MyX509TrustManager</span>() &#125;;</span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ctx = SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);</span><br><span class="line">            ctx.init(<span class="literal">null</span>, tm, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ctx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For More:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00xbW9yeS9hcnRpY2xlL2RldGFpbHMvNzY5NDQ2Njg=">Java实现 http&#x2F;https的 Post、Get、代理访问请求<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3NjaGluYS5uZXQvY29kZS9zbmlwcGV0XzIyNjYxNTdfNDUyNTI=">Java实现 Http 的 Post、Get、代理访问请求<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>400-编程</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows 小技巧</title>
    <url>/2018/10/05/windows-skill/</url>
    <content><![CDATA[<h2 id="文件夹别名"><a href="#文件夹别名" class="headerlink" title="文件夹别名"></a>文件夹别名</h2><p>在使用 Windows 系统时，会发现部分英文路径中的目录显示的却是中文名（如：显示为“我的文档”真实的文件名为 Documents ）。如果我们想建立一个目录放文件，需要使用英文路径，但是为了美观，用中文别名，这又是怎么实现的呢？</p>
<p>在当前目录新建一文件 <code>desktop.ini</code> ，修改其内容如下：</p>
<pre><code>[.ShellClassInfo]
LocalizedResourceName=显示名称
</code></pre>
<p>由于系统缓存的关系，文件名未及时改变。用下面的方法让它立刻生效。</p>
<p>右击文件夹 -&gt; 属性 -&gt; 自定义 -&gt; 更改图标；随便选一个图标，然后点击确定。</p>
<p>这时会发现文件名已变成我们要设置的名称，我们刚刚创建的 <code>desktop.ini</code> ，会被设置为“受系统保护的文件”并隐藏起来。</p>
<p>重新打开 <code>desktop.ini</code> ，会发现里面多了一行用来描述图标的。</p>
<pre><code>[.ShellClassInfo]
LocalizedResourceName=显示名称
IconResource=C:\Windows\system32\SHELL32.dll,7
</code></pre>
<p>如需恢复默认，可按如下操作恢复。</p>
<p>右击文件夹 -&gt; 属性 -&gt; 自定义 -&gt; 更改图标 -&gt; 还原默认值-&gt; 确定。</p>
<span id="more"></span>

<h2 id="Win10-截图快捷键"><a href="#Win10-截图快捷键" class="headerlink" title="Win10 截图快捷键"></a>Win10 截图快捷键</h2><ol>
<li>全屏截图（无反馈）<br> PrintScreen</li>
<li>截取活动窗口（无反馈）<br> Alt + PrintScreen</li>
<li>全屏截图并保存到”图片\屏幕截图”<br> Win + PrintScreen</li>
<li>截取自定义区域<br> Win + Shift + S</li>
<li>调出 Windows Ink 工作区，使用截图和草图<br> Win + W</li>
</ol>
<p>For <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMzgzMTU0MQ==">More<i class="fa fa-external-link-alt"></i></span>.</p>
<h2 id="激活-Windows-企业版"><a href="#激活-Windows-企业版" class="headerlink" title="激活 Windows 企业版"></a>激活 Windows 企业版</h2><pre><code># 设置 kms 服务器
slmgr /skms your.kms.server

# 执行激活命令
slmgr /ato
</code></pre>
<p>其他命令</p>
<pre><code># 检查系统版本及激活信息
slmgr /dlv

# 安装激活密钥
slmgr /ipk XXXXX-XXXXX-XXXXX-XXXXX-XXXXX
</code></pre>
<h2 id="激活-Office-VL-版"><a href="#激活-Office-VL-版" class="headerlink" title="激活 Office VL 版"></a>激活 Office VL 版</h2><blockquote>
<p>Office16 &#x3D;&#x3D; Office 2016<br>Office15 &#x3D;&#x3D; Office 2013<br>Office14 &#x3D;&#x3D; Office 2010</p>
</blockquote>
<pre><code>cd &quot;C:\Program Files\Microsoft Office\Office16&quot;
cscript ospp.vbs /sethst:your.kms.server
cscript ospp.vbs /act
</code></pre>
<p>如果是 64 位操作系统安装了 32 位的 Office ，第一条命令改为</p>
<pre><code>cd &quot;C:\Program Files (x86)\Microsoft Office\Office16&quot;
</code></pre>
<p>其他命令</p>
<pre><code># 查看原密钥后五位
cscript ospp.vbs /dstatus

# 卸载原密钥，XXXXX代表后五位
cscript ospp.vbs /unpkey:XXXXX

# 安装新密钥
cscript ospp.vbs /inpkey:XXXXX-XXXXX-XXXXX-XXXXX-XXXXX
</code></pre>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="CMD-注释"><a href="#CMD-注释" class="headerlink" title="CMD 注释"></a>CMD 注释</h3><p>CMD 注释形式如下：</p>
<ol>
<li><code>:: 注释内容</code>（第一个冒号后也可以跟任何一个非字母数字的字符）</li>
<li><code>REM 注释内容</code>（不能出现重定向符号和管道符号）</li>
<li><code>%注释内容%</code>（可以用作行间注释，不能出现重定向符号和管道符号）</li>
<li><code>:TAG 注释内容</code>（可以用作标签下方段的执行内容）</li>
</ol>
<h3 id="PowerShell-注释"><a href="#PowerShell-注释" class="headerlink" title="PowerShell 注释"></a>PowerShell 注释</h3><p>PowerShell 的注释符分为行注释符和块注释符。行注释符使用 “井号（<code>#</code>）”引起一行；块注释符使用“<code>&lt;#</code>”和“<code>#&gt;</code>”来引起一段注释。</p>
<p>行注释符，举例如下：</p>
<pre><code># 定义一个计数变量
$i = 0
</code></pre>
<p>块注释符、多行注释，举例如下：</p>
<pre><code>&lt;#
    文件：xxx.ps1
    用途：用于测试的xxx功能脚本
#&gt;
</code></pre>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>关于 Windows 10 文件夹共享</title>
    <url>/2019/09/05/Folder-sharing-in-windows-10/</url>
    <content><![CDATA[<h2 id="启用-Guest-账户方式"><a href="#启用-Guest-账户方式" class="headerlink" title="启用 Guest 账户方式"></a>启用 Guest 账户方式</h2><ol>
<li><p>方法一：<br>右击 “开始” 按钮 -&gt; 计算机管理 -&gt;  系统工具 -&gt; 本地用户和组 -&gt; 用户 -&gt; 右击 “Guest” 用户 -&gt; 属性 -&gt; 取消勾选 “账户已禁用” 。</p>
</li>
<li><p>方法二：<br>右击 “开始” 按钮 -&gt; 运行 -&gt; 输入 <code>%windir%\system32\secpol.msc /s</code> ，打开本地安全策略 -&gt; 安全设置 -&gt; 本地策略 -&gt; 安全选项 -&gt; 在右侧列表找到“帐户: 来宾帐户状态” -&gt; 双击，选中里面的“已启用”，确定。</p>
</li>
</ol>
<span id="more"></span>

<h2 id="使用-Guest-账户访问共享内容"><a href="#使用-Guest-账户访问共享内容" class="headerlink" title="使用 Guest 账户访问共享内容"></a>使用 Guest 账户访问共享内容</h2><ol>
<li><p>启用 Guest 账户</p>
</li>
<li><p>允许 Guest 从网络访问<br>右击 “开始” 按钮 -&gt; 运行 -&gt; 输入 <code>%windir%\system32\secpol.msc /s</code> ，打开本地安全策略 -&gt; 安全设置 -&gt; 本地策略 -&gt; 用户权限分配 -&gt; 在右侧列表找到“拒绝从网络访问这台计算机” -&gt; 双击，选中里面的“Guest”，点击删除，确定。</p>
</li>
<li><p>设置网络登录进行身份验证方式<br>右击 “开始” 按钮 -&gt; 运行 -&gt; 输入 <code>%windir%\system32\secpol.msc /s</code> ，打开本地安全策略 -&gt; 安全设置 -&gt; 本地策略 -&gt; 安全选项 -&gt; 在右侧列表找到“网络访问: 本地帐户的共享和安全模型” -&gt; 双击，选中里面的“仅来宾”模型，确定。</p>
</li>
<li><p>开启共享时选中允许 Guest 访问即可</p>
</li>
<li><p>检查防火墙设置（可忽略，一般在进行上一步时会自动设置好）<br>右击 “开始” 按钮 -&gt; 运行 -&gt; 输入 <code>control</code> ，打开控制面板 -&gt; 系统和安全 -&gt; Windows Defender 防火墙 -&gt; 高级设置 -&gt; 在入站规则中检查“文件和打印机共享”是否被放行即可。</p>
</li>
</ol>
<h2 id="允许匿名用户访问共享内容"><a href="#允许匿名用户访问共享内容" class="headerlink" title="允许匿名用户访问共享内容"></a>允许匿名用户访问共享内容</h2><ol>
<li><p>开启 SMB 服务器和客户端<br>右击 “开始” 按钮 -&gt; 运行 -&gt; 输入 <code>control</code> ，打开控制面板 -&gt; 程序 -&gt; 程序和功能 -&gt; 启用或关闭 Windows 功能 -&gt; 开启 <code>SMB 1.0/CIFS 文件共享支持</code> ，确定。</p>
</li>
<li><p>启用 Guest 账户</p>
</li>
<li><p>启用 “无密码保护的共享”<br>在地址栏输入 <code>控制面板\网络和 Internet\网络和共享中心\高级共享设置</code> ，确定 -&gt; 所有网络 -&gt; 密码保护的共享 -&gt; 选中 “无密码保护的共享”，确定。</p>
</li>
</ol>
<h2 id="其他可能引起共享失败的原因"><a href="#其他可能引起共享失败的原因" class="headerlink" title="其他可能引起共享失败的原因"></a>其他可能引起共享失败的原因</h2><p><code>Function Discovery Resource Publication</code> 服务被禁用。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>如何下载 Chrome 独立安装包</title>
    <url>/2019/09/06/Get-standalone-installation-package-of-chrome/</url>
    <content><![CDATA[<p>在地址栏上增加 <code>?standalone=1</code> 或 <code>&amp;standalone=1</code> ，假如原来的地址是：</p>
<pre><code>https://www.google.com/intl/zh-CN/chrome/
</code></pre>
<p>修改后变成：</p>
<pre><code>https://www.google.com/intl/zh-CN/chrome/?standalone=1
</code></pre>
<p>访问修改后的网址，点击下载，这时下载的就是独立安装包了。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>ArchLinux 出现错误 invalid or corrupted package (PGP signature) 的解决方法</title>
    <url>/2020/01/11/ArchLinux-error-invalid-or-corrupte-package/</url>
    <content><![CDATA[<p>升级系统时，有时会出现这个错误信息:</p>
<pre><code>error: vim: signature from &quot;Levente Polyak (anthraxx) &lt;levente@leventepolyak.net&gt;&quot; is unknown trust
:: File /var/cache/pacman/pkg/vim-8.2.0100-1-x86_64.pkg.tar.zst is corrupted (invalid or corrupted package (PGP signature)).
Do you want to delete it? [Y/n]
error: failed to commit transaction (invalid or corrupted package)
Errors occurred, no packages were upgraded.
</code></pre>
<p>可以尝试以下步骤：</p>
<ol>
<li>更新 archlinux-keyring</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman -Sy archlinux-keyring</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>更新所有密钥</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman-key --refresh-keys</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="pacman-key-相关命令"><a href="#pacman-key-相关命令" class="headerlink" title="pacman-key 相关命令"></a>pacman-key 相关命令</h2><ol>
<li>确保正确初始化密匙环</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman-key --init</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>从 <code>/usr/share/pacman/keyring</code> 中重新加载默认密钥</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman-key --populate</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Archlinux</tag>
      </tags>
  </entry>
  <entry>
    <title>Excel 技巧</title>
    <url>/2020/02/29/execl-skills/</url>
    <content><![CDATA[<h3 id="校验身份证号是否正确"><a href="#校验身份证号是否正确" class="headerlink" title="校验身份证号是否正确"></a>校验身份证号是否正确</h3><p>假设身份证号所在单元格是 <code>D5</code>，公式如下：</p>
<pre><code>=IF(D5=&quot;&quot;,&quot;&quot;,(IF(MID(&quot;10X98765432&quot;,MOD(SUMPRODUCT(MID(D5,ROW(INDIRECT(&quot;1:17&quot;)),1)*2^(18-ROW(INDIRECT(&quot;1:17&quot;)))),11)+1,1)=MID(D5,18,18),&quot;正确&quot;,&quot;错误&quot;)))
</code></pre>
<h3 id="Excel-VBA"><a href="#Excel-VBA" class="headerlink" title="Excel VBA"></a>Excel VBA</h3><h4 id="批量增加行高"><a href="#批量增加行高" class="headerlink" title="批量增加行高"></a>批量增加行高</h4><p>Execl 的“自动换行”和“自动调整行高”功能，存在 2 个问题，会导致我们需要手动为每一行调节行高：</p>
<ol>
<li>两行的字体之间没有空隙，显得密集，看起来不舒服；</li>
<li>单元格里文字有多行的时候，由于大部分打印机的打印质量是 200&#x2F;300&#x2F;600 DPI, 而电脑显示质量一般是 96 DPI，所以打印出来后可能有部分单元格内容显示不全。</li>
</ol>
<p>解决方法：批量调节行高，代码如下：</p>
<pre><code>Sub AddRowHeight()

Application.ScreenUpdating = False
rh = InputBox(&quot;请输入待增行高值：&quot;, , 10)
For i = 1 To ActiveSheet.UsedRange.Rows(ActiveSheet.UsedRange.Rows.Count).Row
If Application.WorksheetFunction.CountA(Rows(i)) &gt; 0 Then
Rows(i).RowHeight = Rows(i).RowHeight + rh
End If
Next i
Application.ScreenUpdating = True

End Sub
</code></pre>
<span id="more"></span>

<p>参阅： <span class="exturl" data-url="aHR0cDovL2NsdWIuZXhjZWxob21lLm5ldC90aHJlYWQtMTI4MDY5Mi0xLTEuaHRtbA==">http://club.excelhome.net/thread-1280692-1-1.html<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="完整显示跨页合并的单元格"><a href="#完整显示跨页合并的单元格" class="headerlink" title="完整显示跨页合并的单元格"></a>完整显示跨页合并的单元格</h4><pre><code>Sub ShowALL()
Dim P
Dim MergeAddress As String
Dim PageCell As Range
Dim MergeValue
ActiveWindow.View = xlPageBreakPreview
For Each P In ActiveSheet.HPageBreaks
Set PageCell = Cells(P.Location.Row - 1, ActiveCell.Column)
If PageCell.MergeCells And Not Intersect(Cells(P.Location.Row, ActiveCell.Column), PageCell.MergeArea) Is Nothing Then
MergeAddress = PageCell.MergeArea.Address
MergeValue = PageCell.MergeArea(1).Value
PageCell.MergeArea.UnMerge
Range(Range(MergeAddress)(1), PageCell).Merge
With Range(PageCell.Offset(1, 0), Cells(Split(MergeAddress, &quot;$&quot;)(4), ActiveCell.Column))
.Merge
.Value = MergeValue
End With
End If
Next
ActiveWindow.View = xlNormalView
End Sub
</code></pre>
<h4 id="保留表头拆分数据为若干新工作簿"><a href="#保留表头拆分数据为若干新工作簿" class="headerlink" title="保留表头拆分数据为若干新工作簿"></a>保留表头拆分数据为若干新工作簿</h4><pre><code>Sub 保留表头拆分数据为若干新工作簿()
Dim arr, d As Object, k, t, i&amp;, lc%, rng As Range, c%
c = Application.InputBox(&quot;请输入拆分列号&quot;, , 4, , , , , 1)
If c = 0 Then Exit Sub
Application.ScreenUpdating = False
Application.DisplayAlerts = False
arr = [a1].CurrentRegion
lc = UBound(arr, 2)
Set rng = [a1].Resize(, lc)
Set d = CreateObject(&quot;scripting.dictionary&quot;)
For i = 2 To UBound(arr)
If Not d.Exists(arr(i, c)) Then
Set d(arr(i, c)) = Cells(i, 1).Resize(1, lc)
Else
Set d(arr(i, c)) = Union(d(arr(i, c)), Cells(i, 1).Resize(1, lc))
End If
Next
k = d.Keys
t = d.Items
For i = 0 To d.Count - 1
With Workbooks.Add(xlWBATWorksheet)
rng.Copy .Sheets(1).[a1]
t(i).Copy .Sheets(1).[a2]
.SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\&quot; &amp; k(i) &amp; &quot;.xlsx&quot;
.Close
End With
Next
Application.DisplayAlerts = True
Application.ScreenUpdating = True
MsgBox &quot;完毕&quot;
End Sub
</code></pre>
<h4 id="拆分并填充单元格"><a href="#拆分并填充单元格" class="headerlink" title="拆分并填充单元格"></a>拆分并填充单元格</h4><pre><code>Sub 拆分并填充单元格()
&#39;
&#39; 拆分并填充单元格 宏
&#39;
&#39; 可以将选中的所有单元格都拆开并填充
&#39;
If Application.Selection.MergeCells = True Then
Set selectedRange = Application.Selection
selectedRange.UnMerge
selectedRange.Value = selectedRange.Cells(1, 1).Value
Else
For Each selectedCell In Application.Selection
If selectedCell.MergeCells = True Then
Set selectedRange = selectedCell.MergeArea
selectedRange.UnMerge
selectedRange.Value = selectedRange.Cells(1, 1).Value
End If
Next
End If
End Sub
</code></pre>
]]></content>
      <categories>
        <category>100-办公软件使用</category>
      </categories>
      <tags>
        <tag>Excel</tag>
      </tags>
  </entry>
  <entry>
    <title>借助 Clover 使旧电脑可以用上 NVMe 固态硬盘</title>
    <url>/2020/06/13/boot-on-nvme-sdd-with-clover/</url>
    <content><![CDATA[<p>这里介绍的是一种软件实现方案——它可以使<strong>没有 M.2 插槽</strong>且 <strong>BIOS 不支持 NVMe 协议</strong>的台式电脑通过 <em>M.2 to PCIE 转接卡</em> 用上 NVMe 固态硬盘，其原理是：由 U 盘或非 NVMe 硬盘来提供最初的系统引导，借助 Clover 加载 NVMe 驱动之后将后续的系统引导交回给 NVMe 固态硬盘。</p>
<span id="more"></span>

<blockquote>
<p>老主板通常没有M.2插槽，但是可以通过M.2 to PCIE转接卡将它安装上去。不过在BIOS设置引导顺序当中你却无法找到NVMe固态硬盘，也就是俗称的不认盘。这个问题是BIOS太老造成的，除了个别半旧不旧的主板可能有官方BIOS更新可以升级之外，多数UEFI BIOS可以手动注入NVMe驱动来解决，不过涉及到修改和刷新BIOS的风险较高。</p>
</blockquote>
<blockquote>
<p>无法作为系统盘开机，成为阻碍PCIE NVMe固态硬盘进入老电脑的首要敌人。毕竟多数人都是将固态硬盘当作系统盘使用的，尽管使用其他系统盘开机进入Windows系统之后，NVMe固态硬盘是可以识别和使用的，但好钢不能用在刀刃上，显然是非常大的遗憾。</p>
</blockquote>
<blockquote>
<p>对于动手能力普遍较强的数码IT玩家来说，只要有更高的性价比，多一点折腾并不麻烦。接下来就随存储极客一起实战老电脑免刷BIOS使用NVMe固态硬盘吧！</p>
</blockquote>
<blockquote>
<p>…</p>
</blockquote>
<blockquote>
<p>随着东芝推出RC100主流级NVMe固态硬盘，过去昂贵的高性能NVMe SSD开始走向平民化。M.2 2242规格、单芯片设计，这一切都预示着NVMe固态硬盘的应用范围将得到史无前例的扩展。在消灭最后一个系统启动的障碍之后，只要拥有PCIE插槽的电脑，几乎都可以使用NVMe固态硬盘，当然这需要一定的动手能力和合适的主板平台（需要PCIE 3.0接口充分发挥性能），并对自己动手能力有信心，使用软件魔改的NVMe系统盘也未尝不可。</p>
</blockquote>
<blockquote>
<p>引用自： <span class="exturl" data-url="aHR0cHM6Ly93d3cuc29odS5jb20vYS8yNDE0OTYyODJfNjE1NDY0">https://www.sohu.com/a/241496282_615464<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h3 id="需要用到的工具："><a href="#需要用到的工具：" class="headerlink" title="需要用到的工具："></a>需要用到的工具：</h3><p>软件：</p>
<ul>
<li>Archlinux 系统镜像（archiso）: <span class="exturl" data-url="aHR0cHM6Ly93d3cuYXJjaGxpbnV4Lm9yZy9kb3dubG9hZC8=">https://www.archlinux.org/download/<i class="fa fa-external-link-alt"></i></span></li>
<li>Clover: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Nsb3ZlckhhY2t5Q29sb3IvQ2xvdmVyQm9vdGxvYWRlci9yZWxlYXNlcw==">https://github.com/CloverHackyColor/CloverBootloader/releases<i class="fa fa-external-link-alt"></i></span></li>
<li>Windows 系统镜像: <span class="exturl" data-url="aHR0cHM6Ly90Yi5yZy1hZGd1YXJkLm5ldC8=">https://tb.rg-adguard.net/<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>硬件：</p>
<ul>
<li>系统安装盘（2 个 U 盘，如有另一台电脑，可在使用完 1 个后制作第 2 个系统盘，仅 1 个即可）： 用于制作 Archlinux 启动 U 盘和 Windows 安装盘。</li>
<li>引导盘： 用于安装 Clover, 引导系统启动；可以是系统支持的非 NVMe 硬盘（AHCI）或普通 U 盘，需要长期连接在电脑上。</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol>
<li>提前下载好 archiso 、 Clover 、以及自己需要 Windows 系统镜像。</li>
<li>制作好 Archlinux 系统盘和 Windows 系统盘。</li>
<li>将在 GitHub Release 页面下载到的 <code>Clover-*-X64.iso.7z</code> 解压，解压后得到的 <code>Clover-*-X64.iso</code> 可提前放置在 Archlinux 系统盘根目录。</li>
</ol>
<h4 id="建立引导分区"><a href="#建立引导分区" class="headerlink" title="建立引导分区"></a>建立引导分区</h4><ol>
<li>制作 Archlinux 系统盘，并使用该 Archlinux 系统盘引导系统启动。</li>
</ol>
<p>可参考 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvaW5kZXgucGhwL0luc3RhbGxhdGlvbl9ndWlkZV8oJUU3JUFFJTgwJUU0JUJEJTkzJUU0JUI4JUFEJUU2JTk2JTg3KQ==">https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)<i class="fa fa-external-link-alt"></i></span> 。</p>
<ol start="2">
<li>在引导盘上建立 EFI 系统分区（以下简称 ESP ，约 512 MB），并格式化。</li>
</ol>
<p>参考 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvaW5kZXgucGhwL0VGSV9zeXN0ZW1fcGFydGl0aW9u">https://wiki.archlinux.org/index.php/EFI_system_partition<i class="fa fa-external-link-alt"></i></span> 。</p>
<ol start="3">
<li>安装 Clover 。</li>
</ol>
<p>挂载 <code>Clover-*-X64.iso</code>，可见其目录结构是这样的：</p>
<pre><code>CloverCD
  |--EFI
  |--Library
  |--usr
</code></pre>
<p>将其中的文件夹 <code>EFI</code> 整个复制到第 2 步建立的 ESP 中。</p>
<p>在 ESP 中，将 <code>\EFI\CLOVER\drivers\off\NvmExpressDxe.efi</code> 复制一份到 <code>\EFI\CLOVER\drivers\UEFI\</code> 目录下。（这是 Clover 能够识别 NVMe 固态硬盘的关键）</p>
<h5 id="For-More"><a href="#For-More" class="headerlink" title="For More"></a>For More</h5><p>如需隐藏不必要的启动项，可编辑 <code>\EFI\CLOVER\config.plist</code>，找到 Scan ，并取消注释，修改前：</p>
<pre><code>&lt;key&gt;#Scan&lt;/key&gt;
&lt;dict&gt;
    &lt;key&gt;Entries&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;Legacy&lt;/key&gt;
    &lt;false/&gt;
    &lt;key&gt;Tool&lt;/key&gt;
    &lt;true/&gt;
&lt;/dict&gt;
</code></pre>
<p>修改后：</p>
<pre><code>&lt;key&gt;Scan&lt;/key&gt;
&lt;dict&gt;
    &lt;key&gt;Entries&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;Legacy&lt;/key&gt;
    &lt;false/&gt;
    &lt;key&gt;Tool&lt;/key&gt;
    &lt;true/&gt;
&lt;/dict&gt;
</code></pre>
<h4 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h4><p>使用 Windows 系统盘启动电脑，按照正常安装流程，把系统安装在支持 NVMe 协议的固态硬盘（由于在引导盘已经建立了 ESP，Windows 只会建立 MSR 分区和系统分区），重启后在 Clover 引导页可以看到新安装 Windows 系统选项，选中即可使用安装 NVMe 固态硬盘上的 Windows 系统。</p>
]]></content>
      <categories>
        <category>400-软件使用</category>
      </categories>
      <tags>
        <tag>Clover</tag>
      </tags>
  </entry>
  <entry>
    <title>TeamTalk server 编译与部署笔记</title>
    <url>/2017/03/29/Compile-and-deploy-TeamTalk-in-Ubuntu-Server-16-04/</url>
    <content><![CDATA[<p>记录 TeamTalk Server 的部署过程，仅供大家参考。</p>
<p>为了简化问题，全程采用 root 操作。</p>
<h2 id="编译前准备"><a href="#编译前准备" class="headerlink" title="编译前准备"></a>编译前准备</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><pre><code>操作系统: Ubuntu 16.04.2 LTS (GNU/Linux 4.4.0-62-generic x86_64)
域名： teamtalk.naturalwill.me
IP: 192.168.1.70
</code></pre>
<span id="more"></span>

<p>更新操作系统:</p>
<pre><code>apt update &amp;&amp; apt upgrade
</code></pre>
<p>该命令会执行更新，会消耗一段时间，国内用户，建议使用科大源或者163，搜狐等都可以，这会为大家节省很多时间，具体使用方法，可以见相关的页面:</p>
<pre><code>清华源帮助：
    https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/

163源帮助:
    http://mirrors.163.com/.help/ubuntu.html

搜狐源帮助:
    http://mirrors.sohu.com/help/ubuntu.html

科大源帮助:
    https://lug.ustc.edu.cn/wiki/mirrors/help/ubuntu
</code></pre>
<h3 id="安装-MySQL-、-Nginx-、-Redis"><a href="#安装-MySQL-、-Nginx-、-Redis" class="headerlink" title="安装 MySQL 、 Nginx 、 Redis"></a>安装 MySQL 、 Nginx 、 Redis</h3><pre><code>apt install -y nginx-full
apt install -y redis-server
apt install -y mysql-server
</code></pre>
<h3 id="安装-Termcap"><a href="#安装-Termcap" class="headerlink" title="安装 Termcap"></a>安装 Termcap</h3><pre><code>wget https://ftp.gnu.org/gnu/termcap/termcap-1.3.1.tar.gz
tar -xzvf termcap-1.3.1.tar.gz
cd termcap-1.3.1
./configure --prefix=/usr
make -j 2 &amp;&amp; make install
</code></pre>
<h3 id="安装-PHP"><a href="#安装-PHP" class="headerlink" title="安装 PHP"></a>安装 PHP</h3><p>安装 PHP 及需要用到的插件</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">add-apt-repository ppa:ondrej/php</span><br><span class="line">apt install -y software-properties-common</span><br><span class="line">apt update</span><br><span class="line">apt install -y --allow-unauthenticated php5.6-&#123;fpm,cli,dev,gd,mcrypt,mysqli,curl,mbstring,exif&#125;</span><br></pre></td></tr></table></figure>

<p>配置 PHP ：</p>
<pre><code>sed -i &#39;s/post_max_size = 8M/post_max_size = 50M/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/upload_max_filesize = 2M/upload_max_filesize = 50M/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/;date.timezone =/date.timezone = PRC/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/short_open_tag = Off/short_open_tag = On/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/; cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/; cgi.fix_pathinfo=0/cgi.fix_pathinfo=0/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/max_execution_time = 30/max_execution_time = 300/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/register_long_arrays = On/;register_long_arrays = On/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/magic_quotes_gpc = On/;magic_quotes_gpc = On/g&#39; /etc/php/5.6/fpm/php.ini
sed -i &#39;s/disable_functions =.*/disable_functions = passthru,exec,system,chroot,scandir,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server/g&#39; /etc/php/5.6/fpm/php.ini
</code></pre>
<h3 id="安装-PHP-zend-loader-（可选）"><a href="#安装-PHP-zend-loader-（可选）" class="headerlink" title="安装 PHP zend-loader （可选）"></a>安装 PHP zend-loader （可选）</h3><p>安装对应版本的 <span class="exturl" data-url="aHR0cDovL3d3dy56ZW5kLmNvbS9lbi9wcm9kdWN0cy9sb2FkZXIvZG93bmxvYWRzI0xpbnV4">Zend Guard Loader<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget http://downloads.zend.com/guard/7.0.0/zend-loader-php5.6-linux-x86_64_update1.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/zend/ <span class="comment">#1489462850:0</span></span><br><span class="line">tar -xzvf zend-loader-php5.6-linux-x86_64_update1.tar.gz</span><br><span class="line"><span class="built_in">cp</span> zend-loader-php5.6-linux-x86_64/*.so /usr/local/zend/</span><br></pre></td></tr></table></figure>

<p>修改 PHP 配置文件 <code>/etc/php/5.6/fpm/php.ini</code> ，在文件末尾添加：</p>
<pre><code>;eaccelerator

;ionCube

[Zend Optimizer]
zend_extension=/usr/local/zend/ZendGuardLoader.so
zend_extension=/usr/local/zend/opcache.so
zend_loader.enable=1
zend_loader.disable_licensing=0
zend_loader.obfuscation_level_support=3
zend_loader.license_path=
</code></pre>
<h2 id="编译-Teamtalk"><a href="#编译-Teamtalk" class="headerlink" title="编译 Teamtalk"></a>编译 Teamtalk</h2><p>下载并解压：</p>
<pre><code>wget https://github.com/meili/TeamTalk/archive/master.zip -O TeamTalk-master.zip
unzip TeamTalk-master.zip
mv TeamTalk-master ~/TeamTalk
</code></pre>
<h3 id="安装依赖："><a href="#安装依赖：" class="headerlink" title="安装依赖："></a>安装依赖：</h3><pre><code>apt install -y protobuf-compiler cmake make g++ git openssl libuu-dev libssl-dev libhiredis-dev libprotobuf-dev libcurl4-openssl-dev

cd ~/TeamTalk/server/src
bash ./make_hiredis.sh

apt install -y mysql-client libmysqlclient-dev
ln -s /usr/lib/x86_64-linux-gnu/libmysqlclient.so /usr/lib/x86_64-linux-gnu/libmysqlclient_r.so
</code></pre>
<h3 id="编译-google-protobuf"><a href="#编译-google-protobuf" class="headerlink" title="编译 google protobuf"></a>编译 google protobuf</h3><pre><code>cd ~/TeamTalk/server/src/protobuf/
tar -xzf protobuf-2.6.1.tar.gz
cd protobuf-2.6.1/
./configure --prefix=/usr/local/protobuf
make -j 2 &amp;&amp; make install
</code></pre>
<p>拷贝pb相关文件</p>
<pre><code>mkdir -p ~/TeamTalk/server/src/base/pb/lib/linux/
cp /usr/local/protobuf/lib/libprotobuf-lite.a ~/TeamTalk/server/src/base/pb/lib/linux/
cp -r /usr/local/protobuf/include/* ~/TeamTalk/server/src/base/pb/
</code></pre>
<p>生成pb协议</p>
<pre><code>cd ~/TeamTalk/pb
export PATH=/usr/local/protobuf/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/protobuf/lib:$LD_LIBRARY_PATH
bash create.sh
</code></pre>
<p>将相关文件拷贝到server 目录下：</p>
<pre><code>bash sync.sh
</code></pre>
<h3 id="安装-log4cxx"><a href="#安装-log4cxx" class="headerlink" title="安装 log4cxx"></a>安装 log4cxx</h3><pre><code>apt -y install liblog4cxx-dev liblog4cxx10-dev

cd ~/TeamTalk/server/src
rm -rf slog/include
cp -rf /usr/include/log4cxx slog/include

mkdir -p slog/lib/
cp -f $(dpkg -L liblog4cxx-dev | grep \\.so$)* slog/lib/
</code></pre>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><pre><code>cd ~/TeamTalk/server/src
bash build_ubuntu.sh version 1.0.0
</code></pre>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre><code>cd ~/TeamTalk/server
tar -xzf im-server-1.0.0.tar.gz
mv im-server-1.0.0 /usr/local/teamtalk
cd /usr/local/teamtalk &amp;&amp; sh sync_lib_for_zip.sh
ln -s /usr/local/teamtalk/daeml /usr/local/bin/daeml
</code></pre>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>登陆mysql:</p>
<pre><code>mysql -uroot -p
</code></pre>
<p>创建TeamTalk数据库:</p>
<pre><code>create database teamtalk
</code></pre>
<p>见到如下:</p>
<pre><code>mysql&gt; create database teamtalk;
Query OK, 1 row affected (0.00 sec)
</code></pre>
<p>创建成功。</p>
<p>创建teamtalk用户并给teamtalk用户授权teamtalk的操作:</p>
<pre><code>grant select,insert,update,delete on teamtalk.* to &#39;teamtalk&#39;@&#39;%&#39; identified by &#39;12345&#39;;
flush privileges;
</code></pre>
<p>导入数据库.</p>
<pre><code>use teamtalk;
source ~/TeamTalk/auto_setup/mariadb/conf/ttopen.sql;
show tables;
</code></pre>
<h3 id="PHP-程序配置"><a href="#PHP-程序配置" class="headerlink" title="PHP 程序配置"></a>PHP 程序配置</h3><p>执行如下命令:</p>
<pre><code>mkdir -p /var/www/teamtalk
cp -r ~/TeamTalk/php/* /var/www/teamtalk/
</code></pre>
<p>修改config.php:</p>
<pre><code>cd /var/www/teamtalk/
vim application/config/config.php
</code></pre>
<p>修改第18-19行:</p>
<pre><code>$config[&#39;msfs_url&#39;] = &#39;http://teamtalk.naturalwill.me:8700/&#39;;
$config[&#39;http_url&#39;] = &#39;http://teamtalk.naturalwill.me:8400&#39;;
</code></pre>
<p>修改database.php</p>
<pre><code>vim application/config/database.php
</code></pre>
<p>修改52-54行:</p>
<pre><code>$db[&#39;default&#39;][&#39;hostname&#39;] = &#39;127.0.0.1&#39;;
$db[&#39;default&#39;][&#39;username&#39;] = &#39;tamtalk&#39;;
$db[&#39;default&#39;][&#39;password&#39;] = &#39;12345&#39;;
$db[&#39;default&#39;][&#39;database&#39;] = &#39;teamtalk&#39;;
</code></pre>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>创建 Nginx 配置：</p>
<pre><code>vim /etc/nginx/sites-available/teamtalk.conf
</code></pre>
<p>修改如下：</p>
<pre><code>server &#123;
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name teamtalk.naturalwill.me;
    index index.html index.htm index.php default.html default.htm default.php;
    root /var/www/teamtalk;


    location ~ \.php($|/) &#123;
        # fastcgi_pass   127.0.0.1:9000;
        # fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
        fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_split_path_info ^(.+\.php)(.*)$;
        fastcgi_param   PATH_INFO $fastcgi_path_info;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;
    &#125;

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
            &#123;
                    expires      30d;
            &#125;

    location ~ .*\.(js|css)?$
            &#123;
                    expires      12h;
            &#125;
    if (!-e $request_filename) &#123;
        rewrite ^/(.*)$ /index.php/$1 last;
        break;
    &#125;
&#125;
</code></pre>
<p>激活配置：</p>
<pre><code>ln -s /etc/nginx/sites-available/teamtalk.conf /etc/nginx/sites-enabled/teamtalk.conf
systemctl reload nginx
</code></pre>
<h3 id="TeamTalk-配置"><a href="#TeamTalk-配置" class="headerlink" title="TeamTalk 配置"></a>TeamTalk 配置</h3><p>必须修改的配置：</p>
<ol>
<li>db_proxy_server 中的数据库配置</li>
<li>msg_server 中的 DBServer 需要有 2 个</li>
<li>msfs 中的 BaseDir</li>
</ol>
<p>配置文件说明:</p>
<h4 id="db-proxy-server"><a href="#db-proxy-server" class="headerlink" title="db_proxy_server"></a>db_proxy_server</h4><pre><code>ListenIP=127.0.0.1
ListenPort=10600
ThreadNum=48        # double the number of CPU core
MsfsSite=127.0.0.1

#configure for mysql
DBInstances=teamtalk_master,teamtalk_slave
#teamtalk_master
teamtalk_master_host=127.0.0.1
teamtalk_master_port=3306
teamtalk_master_dbname=teamtalk
teamtalk_master_username=root
teamtalk_master_password=12345
teamtalk_master_maxconncnt=16

#teamtalk_slave
teamtalk_slave_host=127.0.0.1
teamtalk_slave_port=3306
teamtalk_slave_dbname=teamtalk
teamtalk_slave_username=root
teamtalk_slave_password=12345
teamtalk_slave_maxconncnt=16


#configure for unread
CacheInstances=unread,group_set,token,group_member
#未读消息计数器的redis
unread_host=127.0.0.1
unread_port=6379
unread_db=1
unread_maxconncnt=16

#群组设置redis
group_set_host=127.0.0.1
group_set_port=6379
group_set_db=2
group_set_maxconncnt=16

#deviceToken redis
token_host=127.0.0.1
token_port=6379
token_db=4
token_maxconncnt=16

#GroupMember
group_member_host=127.0.0.1
group_member_port=6379
group_member_db=5
group_member_maxconncnt=48

#AES 密钥
aesKey=12345678901234567890123456789012
</code></pre>
<p>ListenIP:db_proxy_server监听的IP。</p>
<p>ListenPort:db_proxy_server监听的port</p>
<p>ThreadNum:工作线程个数。</p>
<p>MsfsSite:配置msfs服务器的地址，用于发送语音的时候上传保存语音文本。</p>
<p>DBInstances:db实例名称。一般配置一主一从即可，其他根据自己的需求修改。</p>
<p>(xxxx)_host:xxxx实例的ip</p>
<p>(xxxx)_port:xxxx实例的port</p>
<p>(xxxx)_dbname:xxxx实例的scheme名称</p>
<p>(xxxx)_username:xxxx实例的用户名</p>
<p>(xxxx)_password:xxxx实例的密码</p>
<p>(xxxx)_maxconncnt:xxxx实例最大连接数</p>
<p>CacheInstances:cache实例名称。</p>
<p>(xxxx)_host:xxxx实例的ip</p>
<p>(xxxx)_port:xxxx实例的port</p>
<p>(xxxx)_db:xxxx实例的db</p>
<p>(xxxx)_maxconncnt:xxxx</p>
<p>aesKey:消息加密密钥。</p>
<p>目前我们db实例配置的一主一从，cache实例配置了5个实例，分别是:</p>
<p>unread:主要用于未读计数。</p>
<p>group_set:群组设置。设置屏蔽群组。</p>
<p>token:主要用于保存ios系统的token。</p>
<p>group_member:保存群成员信息。</p>
<p>参考配置:</p>
<pre><code>ListenIP=0.0.0.0
ListenPort=10600
ThreadNum=48        # double the number of CPU core
MsfsSite=http://teamtalk.naturalwill.me:8700/

#configure for mysql
DBInstances=teamtalk_master,teamtalk_slave
#teamtalk_master
teamtalk_master_host=127.0.0.1
teamtalk_master_port=3306
teamtalk_master_dbname=teamtalk
teamtalk_master_username=teamtalk
teamtalk_master_password=12345
teamtalk_master_maxconncnt=16

#teamtalk_slave
teamtalk_slave_host=127.0.0.1
teamtalk_slave_port=3306
teamtalk_slave_dbname=teamtalk
teamtalk_slave_username=teamtalk
teamtalk_slave_password=12345
teamtalk_slave_maxconncnt=16


#configure for unread
CacheInstances=unread,group_set,token,sync,group_member
#未读消息计数器的redis
unread_host=127.0.0.1
unread_port=6379
unread_db=1
unread_maxconncnt=16

#群组设置redis
group_set_host=127.0.0.1
group_set_port=6379
group_set_db=1
group_set_maxconncnt=16

#同步控制
sync_host=127.0.0.1
sync_port=6379
sync_db=2
sync_maxconncnt=1

#deviceToken redis
token_host=127.0.0.1
token_port=6379
token_db=1
token_maxconncnt=16

#GroupMember
group_member_host=127.0.0.1
group_member_port=6379
group_member_db=1
group_member_maxconncnt=48

#AES 密钥
aesKey=12345678901234567890123456789012
</code></pre>
<h4 id="login-server"><a href="#login-server" class="headerlink" title="login_server"></a>login_server</h4><pre><code>ClientListenIP=0.0.0.0      # can use multiple ip, seperate by &#39;;&#39;
ClientPort=8008
HttpListenIP=0.0.0.0
HttpPort=8080
MsgServerListenIP=0.0.0.0   # can use multiple ip, seperate by &#39;;&#39;
MsgServerPort=8100
msfs=http://127.0.0.1:8700/
discovery=http://127.0.0.1/api/discovery
</code></pre>
<p>ClientListenIP:目前已经作废。</p>
<p>ClientPort:与上一个配套，同样作废。</p>
<p>HttpListenIP:供客户端过来获取msg_server及其他参数的接口地址，走http协议。</p>
<p>HttpPort:与上一个配套使用。</p>
<p>MsgServerListenIP:用于监听msg_server上报信息使用。</p>
<p>MsgServerPort:与上一个配套使用。msg_server启动的时候回来连接该ip:port，以上报自己的信息。</p>
<p>在运行过程中，也会实时将自己的信息汇报给login_server。</p>
<p>msfs:小文件存储的地址，该配置是提供给客户端获取参数时使用。</p>
<p>discovery:发现内容获取地址，该配置是提供给客户端获取参数时使用。</p>
<p>参考配置:</p>
<pre><code>ClientListenIP=0.0.0.0
ClientPort=8008
HttpListenIP=0.0.0.0
HttpPort=8080
MsgServerListenIP=0.0.0.0
MsgServerPort=8100
msfs=http://teamtalk.naturalwill.me:8700/
discovery=http://teamtalk.naturalwill.me/api/discovery
</code></pre>
<h4 id="route-server"><a href="#route-server" class="headerlink" title="route_server"></a>route_server</h4><pre><code>ListenIP=0.0.0.0            # Listening IP
ListenMsgPort=8200          # Listening Port for MsgServer
</code></pre>
<p>route_server配置比较简单，一个监听ip，一个监听port就OK了，供msg_server连接上来用。</p>
<p>参考配置:</p>
<pre><code>ListenIP=0.0.0.0
ListenMsgPort=8200
</code></pre>
<h4 id="http-msg-server"><a href="#http-msg-server" class="headerlink" title="http_msg_server"></a>http_msg_server</h4><pre><code>ListenIP=0.0.0.0
ListenPort=8400
ConcurrentDBConnCnt=4
DBServerIP1=127.0.0.1
DBServerPort1=10600
DBServerIP2=127.0.0.1
DBServerPort2=10600
RouteServerIP1=localhost
RouteServerPort1=8200
#RouteServerIP2=localhost
#RouteServerPort2=8201
</code></pre>
<p>ListenIP: 监听IP，供其他人来调用http_msg_server接口，比如，php在创建群组的时候，就会来调用http_msg_server的接口。</p>
<p>ListenPort: 监听端口，与上一个配套使用。</p>
<p>ConcurrentDBConnCnt: DB数目，目前必须配置为2的整数倍，是历史遗留问题，后期会修复。</p>
<p>DBServerIP(x):db_proxy_server监听的IP，http_msg_server会主动去连接。</p>
<p>DBServerPort(x):db_proxy_server监听的Port</p>
<p>RouteServerIP(x):route_server监听的IP，http_msg_server会主动去连接。</p>
<p>RouteServer(x):route_server监听的Port</p>
<p>参考配置:</p>
<pre><code>ListenIP=0.0.0.0
ListenPort=8400
ConcurrentDBConnCnt=4
DBServerIP1=127.0.0.1
DBServerPort1=10600
DBServerIP2=127.0.0.1
DBServerPort2=10600
RouteServerIP1=127.0.0.1
RouteServerPort1=8200
#RouteServerIP2=localhost
#RouteServerPort2=8201
</code></pre>
<h4 id="msg-server"><a href="#msg-server" class="headerlink" title="msg_server"></a>msg_server</h4><pre><code>ListenIP=0.0.0.0
ListenPort=8000

ConcurrentDBConnCnt=2
DBServerIP1=127.0.0.1
DBServerPort1=10600
DBServerIP2=127.0.0.1
DBServerPort2=10600

LoginServerIP1=127.0.0.1
LoginServerPort1=8100
#LoginServerIP2=localhost
#LoginServerPort2=8101

RouteServerIP1=127.0.0.1
RouteServerPort1=8200
#RouteServerIP2=localhost
#RouteServerPort2=8201

PushServerIP1=127.0.0.1
PushServerPort1=8500

FileServerIP1=127.0.0.1
FileServerPort1=8600
#FileServerIP2=localhost
#FileServerPort2=8601

IpAddr1=127.0.0.1   #电信IP
IpAddr2=127.0.0.1   #网通IP
MaxConnCnt=100000

#AES 密钥
aesKey=12345678901234567890123456789012
</code></pre>
<p>ListenIP:监听客户端连接上来的IP。</p>
<p>ListenPort:与上一个配套使用，监听客户端连接的port。</p>
<p>ConcurrentDBConnCnt:db_proxy_server个数，同http_msg_server 一样。</p>
<p>DBServerIP(x):db_proxy_server监听的ip，msg_server主动去连接。</p>
<p>DBServerPort(x):db_proxy_server监听的port。</p>
<p>LoginServerIP(x):login_server监听的ip，msg_server会主动去连接，汇报本机信息。</p>
<p>LoginServerPort(x):login_server监听的port。</p>
<p>RouteServerIP(x):route_server监听的IP，msg_server主动去连接。</p>
<p>RouteServerPort(x):route_server监听的port。</p>
<p>PushServerIP(x):push_server监听的IP，msg_server会主动去连接，给ios系统推送消息。</p>
<p>PushServerPort(x):push_server监听的port。</p>
<p>FileServerIP(x):file_server监听的IP，msg_server会主动去连接，用于文件传输，暂时未用到。</p>
<p>FileServerPort(x):file_server监听的port。</p>
<p>IpAddr1:msg_server监听的ip，用于汇报给login_server，便于login_server在客户端请求的时候返回给客户端。注意，这个ip一定要是客户端能连接的ip，之前发现好多人配置成127.0.0.1，这是不行的。</p>
<p>IpAddr2:同上。</p>
<p>aesKey:消息文本加密密钥.这里配置主要在msg_server向push_server推送的时候需要将加密的消息进行解密。</p>
<p>参考配置:</p>
<pre><code>ListenIP=0.0.0.0
ListenPort=8000

ConcurrentDBConnCnt=1
DBServerIP1=127.0.0.1
DBServerPort1=10600
DBServerIP2=127.0.0.1
DBServerPort2=10600

LoginServerIP1=192.168.1.70
LoginServerPort1=8100
#LoginServerIP2=localhost
#LoginServerPort2=8101

RouteServerIP1=192.168.1.70
RouteServerPort1=8200
#RouteServerIP2=localhost
#RouteServerPort2=8201

PushServerIP1=192.168.1.70
PushServerPort1=8500

FileServerIP1=192.168.1.70
FileServerPort1=8600
#FileServerIP2=localhost
#FileServerPort2=8601

IpAddr1=teamtalk.naturalwill.me #电信IP
IpAddr2=teamtalk.naturalwill.me #网通IP
MaxConnCnt=100000

# AES key
aesKey=12345678901234567890123456789012
</code></pre>
<h4 id="file-server"><a href="#file-server" class="headerlink" title="file_server"></a>file_server</h4><pre><code>#Address=0.0.0.0         # address for client
ClientListenIP=0.0.0.0
ClientListenPort=8600   # Listening Port for client

MsgServerListenIP=0.0.0.0
MsgServerListenPort=8601

TaskTimeout=60         # Task Timeout (seconds)
</code></pre>
<h4 id="push-server"><a href="#push-server" class="headerlink" title="push_server"></a>push_server</h4><pre><code>ListenIP=0.0.0.0
ListenPort=8500

CertPath=apns-dev-cert.pem
KeyPath=apns-dev-key.pem
KeyPassword=tt@mogujie

#SandBox
#1: sandbox 0: production
SandBox=1
</code></pre>
<h4 id="msfs"><a href="#msfs" class="headerlink" title="msfs"></a>msfs</h4><pre><code>BaseDir=/var/www/teamtalk/msfs #文件存放地址
FileCnt=10
FilesPerDir=30000
GetThreadCount=32
ListenIP=0.0.0.0
ListenPort=8700
PostThreadCount=1
</code></pre>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>服务端的启动没有严格的先后流程，因为各端在启动后会去主动连接其所依赖的服务端，如果相应的服务端还未启动，会始终尝试连接。不过在此，如果是线上环境,还是建议按照如下的启动顺序去启动(也不是唯一的顺序)：</p>
<p>1、启动 db_proxy。</p>
<p>2、启动 route_server, file_server, msfs</p>
<p>3、启动 login_server</p>
<p>4、启动 msg_server</p>
<p>命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> db_proxy_server &amp;&amp; daeml db_proxy_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> route_server &amp;&amp; daeml route_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> file_server &amp;&amp; daeml file_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> msfs &amp;&amp; daeml msfs &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> login_server &amp;&amp; daeml login_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> push_server &amp;&amp; daeml push_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> msg_server &amp;&amp; daeml msg_server &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> http_msg_server &amp;&amp; daeml http_msg_server &amp;&amp; <span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>蓝狐 的 <span class="exturl" data-url="aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTYxMDE0MDcwMzU5L2h0dHA6Ly9ibHVlZm94YWgub3JnL3RlYW10YWxrL25ld190dF9kZXBsb3kuaHRtbA==">新版TeamTalk部署教程<i class="fa fa-external-link-alt"></i></span></p>
<p>luoxn28 的 <span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS9sdW94bjI4L3AvNTM0ODY0OS5odG1s">TeamTalk源码分析之服务端描述<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>400-软件使用</category>
        <category>IM</category>
      </categories>
      <tags>
        <tag>TeamTalk</tag>
        <tag>C/C++</tag>
      </tags>
  </entry>
</search>
